/*! ez3 08-11-2015 */
var EZ3={VERSION:"1.0.0"};EZ3["extends"]=function(a,b){var c;for(c in b)b.hasOwnProperty(c)&&(a[c]=b[c])},EZ3.Camera=function(a,b,c,d,e){EZ3.Entity.call(this),this._filterBuffer=[],this._filter=e||!0,this._rotationAngles=new EZ3.Vector2,this._mode=d||EZ3.Camera.PERSPECTIVE,this.fov=70,this.aspectRatio=1,this.planes={},this.planes.near=.1,this.planes.far=1e3,this.look=new EZ3.Vector3(0,0,-1),this.right=new EZ3.Vector3(1,0,0),a instanceof EZ3.Vector3?this.position=a:this.position=new EZ3.Vector3(5,5,5),b instanceof EZ3.Vector3?this.target=b:this.target=new EZ3.Vector3,c instanceof EZ3.Vector3?this.up=c:this.up=new EZ3.Vector3(0,1,0),this._setupRotationAngles()},EZ3.Camera.prototype.constructor=EZ3.Camera,EZ3.Camera.prototype._setupRotationAngles=function(){var a,b;this.look=(new EZ3.Vector3).sub(this.position,this.target).normalize(),a=EZ3.Math.toDegrees(Math.atan2(this.look.z,this.look.x)+EZ3.Math.PI),b=EZ3.Math.toDegrees(Math.asin(this.look.y)),this._rotationAngles.x=a,this._rotationAngles.y=b},EZ3.Camera.prototype._filterMoves=function(a,b){var c,d=0,e=0,f=0,g=1;if(!this._filterBuffer.length)for(c=0;c<EZ3.Camera.FILTER_BUFFER_SIZE;++c)this._filterBuffer.push(new EZ3.Vector2(a,b));for(c=EZ3.Camera.FILTER_BUFFER_SIZE-1;c>0;c--)this._filterBuffer[c]=this._filterBuffer[c-1];for(this._filterBuffer[0]=new EZ3.Vector2(a,b),c=0;c<EZ3.Camera.FILTER_BUFFER_SIZE;c++)d+=this._filterBuffer[c].x*g,e+=this._filterBuffer[c].y*g,f+=g,g*=EZ3.Camera.FILTER_WEIGHT;return new EZ3.Vector2(d,e).scaleEqual(1/f)},EZ3.Camera.prototype.rotate=function(a,b){var c,d;this._rotationAngles.x-=a*EZ3.Camera.ROTATION_SPEED,this._rotationAngles.y+=b*EZ3.Camera.ROTATION_SPEED,this._filter&&(c=this._rotationAngles.x,d=this._rotationAngles.y,this._rotationAngles=this._filterMoves(c,d))},Object.defineProperty(EZ3.Camera.prototype,"view",{get:function(){return this._update(),(new EZ3.Matrix4).lookAt(this.position,this.target,this.up)}}),Object.defineProperty(EZ3.Camera.prototype,"projection",{get:function(){return this._mode===EZ3.Camera.PERSPECTIVE?(new EZ3.Matrix4).perspective(this.fov,this.aspectRatio,this.planes.near,this.planes.far):(new EZ3.Matrix4).ortho(this.planes.left,this.planes.right,this.planes.bottom,this.planes.top,this.planes.near,this.planes.far)}}),EZ3.Camera.PERSPECTIVE=0,EZ3.Camera.ORTHOGRAPHIC=1,EZ3.Camera.MOVE_SPEED=50,EZ3.Camera.ROTATION_SPEED=300,EZ3.Camera.FILTER_WEIGHT=.75,EZ3.Camera.FILTER_BUFFER_SIZE=10,EZ3.Cache=function(){this.ASSET={},this.ASSET.IMAGE=0,this.ASSET.DATA=1,this.ASSET.ENTITY=2,this._assets=[],this._assets[this.ASSET.IMAGE]={},this._assets[this.ASSET.DATA]={},this._assets[this.ASSET.ENTITY]={}},EZ3.Cache=new EZ3.Cache,EZ3.Cache.add=function(a,b){b instanceof Image?this._assets[this.ASSET.IMAGE][a]=b:b instanceof XMLHttpRequest?this._assets[this.ASSET.DATA][a]=b:b instanceof EZ3.Entity&&(this._assets[this.ASSET.ENTITY][a]=b)},EZ3.Cache.image=function(a){return this._assets[this.ASSET.IMAGE][a]},EZ3.Cache.data=function(a){return this._assets[this.ASSET.DATA][a]},EZ3.Cache.entity=function(a){return this._assets[this.ASSET.ENTITY][a]},EZ3.Engine=function(a,b){this._animationFrame=null,this._renderer=null,this.device=EZ3.Device,this.time=null,this.input=null,this.screens=null,this.device.onReady(this._init,this,[a,b])},EZ3.Engine.prototype._init=function(a,b){this._animationFrame=new EZ3.AnimationFrame(!1),this._renderer=new EZ3.Renderer(a,b),this.time=new EZ3.Time,this.input=new EZ3.InputManager(a),this.screens=new EZ3.ScreenManager(a,this._renderer,this.time,this.input),this._renderer.initContext(),this.time.start(),this._update()},EZ3.Engine.prototype._update=function(){this.screens.update(),this.time.update(),this._animationFrame.request(this._update.bind(this))},EZ3.Entity=function(){this._cache={},this.parent=null,this.children=[],this.model=new EZ3.Matrix4,this.world=new EZ3.Matrix4,this.scale=new EZ3.Vector3(1,1,1),this.position=new EZ3.Vector3(0,0,0),this.rotation=new EZ3.Quaternion(1,0,0,0),this._cache.model=this.model.clone(),this._cache.scale=this.scale.clone(),this._cache.position=this.position.clone(),this._cache.rotation=this.rotation.clone(),this._cache.parentWorld=this.model.clone()},EZ3.Entity.prototype.add=function(a){a instanceof EZ3.Entity&&(a.parent&&a.parent.remove(a),a.parent=this,this.children.push(a))},EZ3.Entity.prototype.remove=function(a){var b=this.children.indexOf(a);~b&&this.children.splice(b,1)},EZ3.Entity.prototype.updateWorld=function(){var a,b,c,d,e;this._cache.position.testDiff(this.position)&&(this._cache.position=this.position.clone(),a=!0),this._cache.rotation.testDiff(this.rotation)&&(this._cache.rotation=this.rotation.clone(),b=!0),this._cache.scale.testDiff(this.scale)&&(this._cache.scale=this.scale.clone(),c=!0),(a||b||c)&&(this.model.fromRotationTranslation(this.model,this.rotation,this.position),this.model.scale(this.model,this.scale)),this.parent?(d=this._cache.model.testDiff(this.model),e=this._cache.parentWorld.testDiff(this.parent.world),(e||d)&&(d&&(this._cache.model=this.model.clone()),e&&(this._cache.parentWorld=this.parent.world.clone()),this.world.mul(this.model,this.parent.world),this instanceof EZ3.Mesh&&(this.updateNormalMatrix=!0))):(d=this._cache.model.testDiff(this.model),d&&(this.world.copy(this.model),this._cache.model=this.model.clone(),this instanceof EZ3.Mesh&&(this.updateNormalMatrix=!0)))},EZ3.Scene=function(){EZ3.Entity.call(this)},EZ3.Scene.prototype=Object.create(EZ3.Entity.prototype),EZ3.Scene.prototype.constructor=EZ3.Scene,EZ3.Screen=function(a,b,c){this.id=a,this.position=b,this.size=c,this.load=new EZ3.LoadManager,this.scene=new EZ3.Scene,this.camera=null},EZ3.Screen.prototype.onKeyPress=function(){},EZ3.Screen.prototype.onKeyDown=function(){},EZ3.Screen.prototype.onKeyUp=function(){},EZ3.Screen.prototype.onMousePress=function(){},EZ3.Screen.prototype.onMouseMove=function(){},EZ3.Screen.prototype.onMouseUp=function(){},EZ3.Screen.prototype.onTouchPress=function(){},EZ3.Screen.prototype.onTouchMove=function(){},EZ3.Screen.prototype.onTouchUp=function(){},EZ3.Screen.prototype.create=function(){},EZ3.Screen.prototype.update=function(){},EZ3.ScreenManager=function(a,b,c,d){this._screens=[],this.canvas=a,this.bounds=a.getBoundingClientRect(),this.renderer=b,this.time=c,this.input=d,this.fullScreeneded=!1},EZ3.ScreenManager.prototype._addEventListeners=function(a){var b,c,d,e={keyboard:{onKeyPress:"onKeyPress",onKeyDown:"onKeyDown",onKeyUp:"onKeyUp"},mouse:{onPress:"onMousePress",onMove:"onMouseMove",onUp:"onMouseUp",onWheel:"onMouseWheel"},touch:{onPress:"onTouchPress",onMove:"onTouchMove",onUp:"onTouchUp"}},f=EZ3.Device;for(c in e){b=e[c];for(d in b)a[b[d]]!==EZ3.Screen.prototype[b[d]]&&a.input[c][d].add(a[b[d]],a)}a.onResize&&f.onResize.add(a.onResize,a)},EZ3.ScreenManager.prototype._removeEventListeners=function(a){var b,c,d,e;b={keyboard:["onKeyPress","onKeyDown","onKeyUp"],mouse:["onPress","onMove","onUp"],touch:["onPress","onMove","onUp"]};for(d in b)for(c=b[d],e=0;e<c.length;e++)a.input[d][c[e]].remove(a[c[e]],a)},EZ3.ScreenManager.prototype._processFullScreenChange=function(){var a=EZ3.Device;this.fullScreened=!this.fullScreened,this.fullScreened||(this.canvas.removeEventListener(a.fullScreenChange,this._onFullScreenChange,!0),delete this._onFullScreenChange)},EZ3.ScreenManager.prototype.add=function(a){return a instanceof EZ3.Screen&&!this.get(a.id)?(a.manager=this,a.input=this.input,a.preload?(a.preload(),a.load.onComplete.add(a.create,a),a.load.onComplete.add(function(){this._addEventListeners(a),this._screens.unshift(a)},this),a.load.start()):(a.create(),this._addEventListeners(a),this._screens.unshift(a)),a):void 0},EZ3.ScreenManager.prototype.get=function(a){var b;for(b=0;b<this._screens.length;b++)if(this._screens[b].id===a)return this._screens[b]},EZ3.ScreenManager.prototype.remove=function(a){var b;for(b=0;b<this._screens.length;b++)if(this._screens[b].id===a)return this._removeEventListeners(this._screens[b]),this._screens.splice(b,1)},EZ3.ScreenManager.prototype.update=function(){var a,b;for(this.renderer.clear(),b=0;b<this._screens.length;b++)a=this._screens[b],this.renderer.viewport(a.position,a.size),this.renderer.render(a.scene,a.camera),this._screens[b].update()},EZ3.ScreenManager.prototype.fullScreen=function(){var a,b=EZ3.Device;console.log("x"),b.requestFullScreen&&!this.fullScreened&&(console.log("x1"),a=this,this._onFullScreenChange=function(b){a._processFullScreenChange(b)},this.canvas.addEventListener(b.fullScreenChange,this._onFullScreenChange,!0),this.canvas[b.requestFullScreen]())},EZ3.ScreenManager.prototype.windowed=function(){var a=EZ3.Device;a.cancelFullScreen&&this.fullScreened&&this.canvas[a.cancelFullScreen]()},EZ3.Signal=function(){var a;this._bindings=[],this._prevParams=null,a=this,this.dispatch=function(){EZ3.Signal.prototype.dispatch.apply(a,arguments)}},EZ3.Signal.prototype._shouldPropagate=!0,EZ3.Signal.prototype.memorize=!1,EZ3.Signal.prototype.active=!0,EZ3.Signal.prototype._registerListener=function(a,b,c,d){var e,f;if(e=this._indexOfListener(a,c),-1!==e){if(f=this._bindings[e],f.isOnce!==b)throw new Error("You cannot add"+(b?"":"Once")+"() then add"+(b?"Once":"")+"() the same listener without removing the relationship first.")}else f=new EZ3.SignalBinding(this,a,b,c,d),this._addBinding(f);return this.memorize&&this._prevParams&&f.execute(this._prevParams),f},EZ3.Signal.prototype._addBinding=function(a){var b;b=this._bindings.length;do--b;while(this._bindings[b]&&a._priority<=this._bindings[b]._priority);this._bindings.splice(b+1,0,a)},EZ3.Signal.prototype._indexOfListener=function(a,b){var c,d;for(c=this._bindings.length;c--;)if(d=this._bindings[c],d.listener===a&&d.context===b)return c;return-1},EZ3.Signal.prototype.has=function(a,b){return-1!==this._indexOfListener(a,b)},EZ3.Signal.prototype.add=function(a,b,c){return this._registerListener(a,!1,b,c)},EZ3.Signal.prototype.addOnce=function(a,b,c){return this._registerListener(a,!0,b,c)},EZ3.Signal.prototype.remove=function(a,b){var c;return c=this._indexOfListener(a,b),-1!==c&&(this._bindings[c]._destroy(),this._bindings.splice(c,1)),a},EZ3.Signal.prototype.removeAll=function(a){var b;if(b=this._bindings.length,a)for(;b--;)this._bindings[b].context===a&&(this._bindings[b]._destroy(),this._bindings.splice(b,1));else{for(;b--;)this._bindings[b]._destroy();this._bindings.length=0}},EZ3.Signal.prototype.getNumListeners=function(){return this._bindings.length},EZ3.Signal.prototype.halt=function(){this._shouldPropagate=!1},EZ3.Signal.prototype.dispatch=function(a){var b,c,d;if(this.active&&(b=Array.prototype.slice.call(arguments),c=this._bindings.length,this.memorize&&(this._prevParams=b),c)){d=this._bindings.slice(),this._shouldPropagate=!0;do c--;while(d[c]&&this._shouldPropagate&&d[c].execute(b)!==!1)}},EZ3.Signal.prototype.forget=function(){this._prevParams=null},EZ3.Signal.prototype.dispose=function(){this.removeAll(),delete this._bindings,delete this._prevParams},EZ3.SignalBinding=function(a,b,c,d,e){this._signal=a,this._priority=e||0,this.listener=b,this.isOnce=c,this.context=d},EZ3.SignalBinding.prototype.active=!0,EZ3.SignalBinding.prototype.params=null,EZ3.SignalBinding.prototype._destroy=function(){delete this._signal,delete this.listener,delete this.context},EZ3.SignalBinding.prototype.execute=function(a){var b,c;return this.active&&this.listener&&(c=this.params?this.params.concat(a):a,b=this.listener.apply(this.context,c),this.isOnce&&this.detach()),b},EZ3.SignalBinding.prototype.detach=function(){return this.isBound()?this._signal.remove(this.listener,this.context):null},EZ3.SignalBinding.prototype.isBound=function(){return!!this._signal&&!!this.listener},EZ3.InputManager=function(a){this.keyboard=new EZ3.Keyboard,this.mouse=new EZ3.Mouse(a),this.touch=new EZ3.Touch(a)},EZ3.Keyboard=function(){this._keys=[],this.enabled=!1,this.onKeyPress=new EZ3.Signal,this.onKeyDown=new EZ3.Signal,this.onKeyUp=new EZ3.Signal},EZ3.Keyboard.prototype.constructor=EZ3.Keyboard,EZ3.Keyboard.prototype._processKeyDown=function(a){this._keys[a.keyCode]||(this._keys[a.keyCode]=new EZ3.Switch(a.keyCode)),this._keys[a.keyCode].processDown()&&this.onKeyPress.dispatch(this._keys[a.keyCode]),this.onKeyDown.dispatch(this._keys[a.keyCode])},EZ3.Keyboard.prototype._processKeyUp=function(a){this._keys[a.keyCode]||(this._keys[a.keyCode]=new EZ3.Switch(a.keyCode)),this._keys[a.keyCode].processUp(),this.onKeyUp.dispatch(this._keys[a.keyCode])},EZ3.Keyboard.prototype.enable=function(){var a=this;this.enabled=!0,this._onKeyDown=function(b){a._processKeyDown(b)},this._onKeyUp=function(b){a._processKeyUp(b)},window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1)},EZ3.Keyboard.prototype.disable=function(){this.enabled=!1,window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),delete this._onKeyDown,delete this._onKeyUp},EZ3.Keyboard.prototype.getKey=function(a){return this._keys[a]||(this._keys[a]=new EZ3.Switch(a)),this._keys[a]},EZ3.Keyboard.A="A".charCodeAt(0),EZ3.Keyboard.B="B".charCodeAt(0),EZ3.Keyboard.C="C".charCodeAt(0),EZ3.Keyboard.D="D".charCodeAt(0),EZ3.Keyboard.E="E".charCodeAt(0),EZ3.Keyboard.F="F".charCodeAt(0),EZ3.Keyboard.G="G".charCodeAt(0),EZ3.Keyboard.H="H".charCodeAt(0),EZ3.Keyboard.I="I".charCodeAt(0),EZ3.Keyboard.J="J".charCodeAt(0),EZ3.Keyboard.K="K".charCodeAt(0),EZ3.Keyboard.L="L".charCodeAt(0),EZ3.Keyboard.M="M".charCodeAt(0),EZ3.Keyboard.N="N".charCodeAt(0),EZ3.Keyboard.O="O".charCodeAt(0),EZ3.Keyboard.P="P".charCodeAt(0),EZ3.Keyboard.Q="Q".charCodeAt(0),EZ3.Keyboard.R="R".charCodeAt(0),EZ3.Keyboard.S="S".charCodeAt(0),EZ3.Keyboard.T="T".charCodeAt(0),EZ3.Keyboard.U="U".charCodeAt(0),EZ3.Keyboard.V="V".charCodeAt(0),EZ3.Keyboard.W="W".charCodeAt(0),EZ3.Keyboard.X="X".charCodeAt(0),EZ3.Keyboard.Y="Y".charCodeAt(0),EZ3.Keyboard.Z="Z".charCodeAt(0),EZ3.Keyboard.ZERO="0".charCodeAt(0),EZ3.Keyboard.ONE="1".charCodeAt(0),EZ3.Keyboard.TWO="2".charCodeAt(0),EZ3.Keyboard.THREE="3".charCodeAt(0),EZ3.Keyboard.FOUR="4".charCodeAt(0),EZ3.Keyboard.FIVE="5".charCodeAt(0),EZ3.Keyboard.SIX="6".charCodeAt(0),EZ3.Keyboard.SEVEN="7".charCodeAt(0),EZ3.Keyboard.EIGHT="8".charCodeAt(0),EZ3.Keyboard.NINE="9".charCodeAt(0),EZ3.Keyboard.NUMPAD_0=96,EZ3.Keyboard.NUMPAD_1=97,EZ3.Keyboard.NUMPAD_2=98,EZ3.Keyboard.NUMPAD_3=99,EZ3.Keyboard.NUMPAD_4=100,EZ3.Keyboard.NUMPAD_5=101,EZ3.Keyboard.NUMPAD_6=102,EZ3.Keyboard.NUMPAD_7=103,EZ3.Keyboard.NUMPAD_8=104,EZ3.Keyboard.NUMPAD_9=105,EZ3.Keyboard.NUMPAD_MULTIPLY=106,EZ3.Keyboard.NUMPAD_ADD=107,EZ3.Keyboard.NUMPAD_ENTER=108,EZ3.Keyboard.NUMPAD_SUBTRACT=109,EZ3.Keyboard.NUMPAD_DECIMAL=110,EZ3.Keyboard.NUMPAD_DIVIDE=111,EZ3.Keyboard.F1=112,EZ3.Keyboard.F2=113,EZ3.Keyboard.F3=114,EZ3.Keyboard.F4=115,EZ3.Keyboard.F5=116,EZ3.Keyboard.F6=117,EZ3.Keyboard.F7=118,EZ3.Keyboard.F8=119,EZ3.Keyboard.F9=120,EZ3.Keyboard.F10=121,EZ3.Keyboard.F11=122,EZ3.Keyboard.F12=123,EZ3.Keyboard.F13=124,EZ3.Keyboard.F14=125,EZ3.Keyboard.F15=126,EZ3.Keyboard.COLON=186,EZ3.Keyboard.EQUALS=187,EZ3.Keyboard.COMMA=188,EZ3.Keyboard.UNDERSCORE=189,EZ3.Keyboard.PERIOD=190,EZ3.Keyboard.QUESTION_MARK=191,EZ3.Keyboard.TILDE=192,EZ3.Keyboard.OPEN_BRACKET=219,EZ3.Keyboard.BACKWARD_SLASH=220,EZ3.Keyboard.CLOSED_BRACKET=221,EZ3.Keyboard.QUOTES=222,EZ3.Keyboard.BACKSPACE=8,EZ3.Keyboard.TAB=9,EZ3.Keyboard.CLEAR=12,EZ3.Keyboard.ENTER=13,EZ3.Keyboard.SHIFT=16,EZ3.Keyboard.CONTROL=17,EZ3.Keyboard.ALT=18,EZ3.Keyboard.CAPS_LOCK=20,EZ3.Keyboard.ESC=27,EZ3.Keyboard.SPACEBAR=32,EZ3.Keyboard.PAGE_UP=33,EZ3.Keyboard.PAGE_DOWN=34,EZ3.Keyboard.END=35,EZ3.Keyboard.HOME=36,EZ3.Keyboard.LEFT=37,EZ3.Keyboard.UP=38,EZ3.Keyboard.RIGHT=39,EZ3.Keyboard.DOWN=40,EZ3.Keyboard.PLUS=43,EZ3.Keyboard.MINUS=44,EZ3.Keyboard.INSERT=45,EZ3.Keyboard.DELETE=46,EZ3.Keyboard.HELP=47,EZ3.Keyboard.NUM_LOCK=144,EZ3.Mouse=function(a){this._domElement=a,this._device=EZ3.Device,this.enabled=!1,this.pointer=new EZ3.MousePointer(a),this.onPress=new EZ3.Signal,this.onMove=new EZ3.Signal,this.onUp=new EZ3.Signal,this.onWheel=new EZ3.Signal,this.onLockChange=new EZ3.Signal},EZ3.Mouse.prototype.constructor=EZ3.Mouse,EZ3.Mouse.prototype._processMousePress=function(a){this.pointer.processPress(a,this.onPress,this.onMove)},EZ3.Mouse.prototype._processMouseMove=function(a){this.pointer.processMove(a,this.onMove)},EZ3.Mouse.prototype._processMouseUp=function(a){this.pointer.processUp(a,this.onUp)},EZ3.Mouse.prototype._processMouseWheel=function(a){this.pointer.processWheel(a,this.onWheel)},EZ3.Mouse.prototype._processMouseLockChange=function(){this.pointer.locked&&(document.removeEventListener(this._device.pointerLockChange,this._onMouseLockChange,!0),delete this._onMouseLockChange),this.pointer.processLockChange(this.onLockChange)},EZ3.Mouse.prototype.lock=function(){var a;this._device.requestPointerLock&&!this.pointer.locked&&(a=this,this._onMouseLockChange=function(b){a._processMouseLockChange(b)},document.addEventListener(this._device.pointerLockChange,this._onMouseLockChange,!0),this._domElement[this._device.requestPointerLock]())},EZ3.Mouse.prototype.unlock=function(){this._device.cancelPointerLock&&this.pointer.locked&&this._domElement[this._device.cancelPointerLock]()},EZ3.Mouse.prototype.enable=function(){var a=this;this.enabled=!0,this._onMousePress=function(b){a._processMousePress(b)},this._onMouseMove=function(b){a._processMouseMove(b)},this._onMouseUp=function(b){a._processMouseUp(b)},this._onMouseWheel=function(b){a._processMouseWheel(b)},this._domElement.addEventListener("mousedown",this._onMousePress,!0),this._domElement.addEventListener("mousemove",this._onMouseMove,!0),this._domElement.addEventListener("mouseup",this._onMouseUp,!0),this._domElement.addEventListener("mousewheel",this._onMouseWheel,!0),this._domElement.addEventListener("DOMMouseScroll",this._onMouseWheel,!0)},EZ3.Mouse.prototype.disable=function(){this.enabled=!1,this._domElement.removeEventListener("mousedown",this._onMouserDown,!0),this._domElement.removeEventListener("mousemove",this._onMouseMove,!0),this._domElement.removeEventListener("mouseup",this._onMouseUp,!0),this._domElement.removeEventListener("mousewheel",this._onMouseWheel,!0),this._domElement.removeEventListener("DOMMouseScroll",this._onMouseWheel,!0),delete this._onMousePress,delete this._onMouseMove,delete this._onMouseUp,delete this._onMouseWheel},EZ3.Mouse.LEFT_BUTTON=0,EZ3.Mouse.MIDDLE_BUTTON=1,EZ3.Mouse.RIGHT_BUTTON=2,EZ3.Mouse.BACK_BUTTON=3,EZ3.Mouse.FORWARD_BUTTON=4,EZ3.Pointer=function(a){this._domElement=a,this._bound=a.getBoundingClientRect(),this.page=new EZ3.Vector2,this.client=new EZ3.Vector2,this.screen=new EZ3.Vector2,this.position=new EZ3.Vector2},EZ3.Pointer.prototype.constructor=EZ3.Pointer,EZ3.Pointer.prototype.processPress=function(a){EZ3.Pointer.prototype.processMove.call(this,a)},EZ3.Pointer.prototype.processMove=function(a){this.page.set(a.pageX,a.pageY),this.client.set(a.clientX,a.clientY),this.screen.set(a.screenX,a.screenY),this.position.x=Math.round((a.clientX-this._bound.left)/(this._bound.right-this._bound.left)*this._domElement.width),this.position.y=Math.round((a.clientY-this._bound.top)/(this._bound.bottom-this._bound.top)*this._domElement.height)},EZ3.Switch=function(a){this._state=!1,this.code=a},EZ3.Switch.prototype.constructor=EZ3.Switch,EZ3.Switch.prototype.processPress=function(){this._state=!0},EZ3.Switch.prototype.processDown=function(){var a=this.isUp();return this._state=!0,a},EZ3.Switch.prototype.processUp=function(){this._state=!1},EZ3.Switch.prototype.isDown=function(){return this._state},EZ3.Switch.prototype.isUp=function(){return!this._state},EZ3.Touch=function(a){this._device=EZ3.Device,this._domElement=a,this._pointers=[],this.enabled=!1,this.onPress=new EZ3.Signal,this.onMove=new EZ3.Signal,this.onUp=new EZ3.Signal},EZ3.Touch.prototype.constructor=EZ3.Touch,EZ3.Touch.prototype._searchPointerIndex=function(a){for(var b=0;b<this._pointers.length;b++)if(a===this._pointers[b].id)return b;return-1},EZ3.Touch.prototype._processTouchPress=function(a){a.preventDefault();for(var b=0;b<a.changedTouches.length;b++){for(var c=!1,d=0;d<EZ3.Touch.MAX_NUM_OF_POINTERS;d++){if(!this._pointers[d]){this._pointers[d]=new EZ3.TouchPointer(this._domElement,d,a.changedTouches[b].identifier),c=!0;break}if(this._pointers[d].isUp()){this._pointers[d].id=a.changedTouches[b].identifier,c=!0;break}}c&&this._pointers[d].processPress(a.changedTouches[b],this.onPress,this.onMove)}},EZ3.Touch.prototype._processTouchMove=function(a){a.preventDefault();for(var b=0;b<a.changedTouches.length;b++){var c=this._searchPointerIndex(a.changedTouches[b].identifier);c>=0&&this._pointers[c].processMove(a.changedTouches[b],this.onMove)}},EZ3.Touch.prototype._processTouchUp=function(a){a.preventDefault();for(var b=0;b<a.changedTouches.length;b++){var c=this._searchPointerIndex(a.changedTouches[b].identifier);c>=0&&this._pointers[c].processUp(this.onUp)}},EZ3.Touch.prototype.enable=function(){if(this._device.touchDown){var a=this;this.enabled=!0,this._onTouchPress=function(b){a._processTouchPress(b)},this._onTouchMove=function(b){a._processTouchMove(b)},this._onTouchUp=function(b){a._processTouchUp(b)},this._domElement.addEventListener(this._device.touchDown,this._onTouchPress,!1),this._domElement.addEventListener(this._device.touchMove,this._onTouchMove,!1),this._domElement.addEventListener(this._device.touchUp,this._onTouchUp,!1)}},EZ3.Touch.prototype.disable=function(){this._device.touchDown&&(this.enabled=!1,this._domElement.removeEventListener(this._device.touchDown,this._onTouchPress,!1),this._domElement.removeEventListener(this._device.touchMove,this._onTouchMove,!1),this._domElement.removeEventListener(this._device.touchUp,this._onTouchUp,!1),delete this._onTouchPress,delete this._onTouchMove,delete this._onTouchUp)},EZ3.Touch.prototype.getPointer=function(a){return this._pointers[a]||(this._pointers[a]=new EZ3.TouchPointer(this._domElement,a)),this._pointers[a]},EZ3.Touch.POINTER_1=0,EZ3.Touch.POINTER_2=1,EZ3.Touch.POINTER_3=2,EZ3.Touch.POINTER_4=3,EZ3.Touch.POINTER_5=4,EZ3.Touch.POINTER_6=5,EZ3.Touch.POINTER_7=6,EZ3.Touch.POINTER_8=7,EZ3.Touch.POINTER_9=8,EZ3.Touch.POINTER_10=9,EZ3.Touch.MAX_NUM_OF_POINTERS=10,EZ3.Light=function(){EZ3.Entity.call(this),this.diffuse=new EZ3.Vector3(1,1,1),this.specular=new EZ3.Vector3(1,1,1)},EZ3.Light.prototype=Object.create(EZ3.Entity.prototype),EZ3.Light.prototype.constructor=EZ3.Light,EZ3.Light.prototype.updateUniforms=function(a,b,c){b.loadUniformf(a,c+"diffuse",3,this.diffuse),b.loadUniformf(a,c+"specular",3,this.specular)},EZ3.Data=function(a,b,c){this.url=a,this.crossOrigin=b,this.responseType=c,this.content=new XMLHttpRequest},EZ3.Data.prototype._processLoad=function(a,b){this._removeEventHandlers(),b(this.url,a)},EZ3.Data.prototype._processError=function(a,b){this._removeEventHandlers(),b(this.url,a)},EZ3.Data.prototype.load=function(a,b){var c;c=this,this._onLoad=function(){c._processLoad(this,a)},this._onError=function(b){c._processError(b,a)},this.content.open("GET",this.url,!0),this.content.addEventListener("load",this._onLoad,!1),this.content.addEventListener("error",this._onError,!1),this.crossOrigin&&(this.content.crossOrigin=this.crossOrigin),this.responseType&&(this.content.responseType=this.responseType),this.content.send(null)},EZ3.Data.prototype._removeEventHandlers=function(){this.content.addEventListener("load",this._onLoad,!1),this.content.addEventListener("error",this._onError,!1),delete this._onLoad,delete this._onError},EZ3.Image=function(a,b){this.url=a,this.crossOrigin=b,this.content=new Image},EZ3.Image.prototype._processLoad=function(a,b){this._removeEventHandlers(),b(this.url,a)},EZ3.Image.prototype._processError=function(a,b){this._removeEventHandlers(),b(this.url,a)},EZ3.Image.prototype.load=function(a,b){var c;c=this,this._onLoad=function(){c._processLoad(this,a)},this._onError=function(b){c._processError(b,a)},this.content.addEventListener("load",this._onLoad,!1),this.content.addEventListener("error",this._onError,!1),this.crossOrigin||(this.content.crossOrigin=this.crossOrigin),this.content.src=this.url},EZ3.Image.prototype._removeEventHandlers=function(){this.content.addEventListener("load",this._onLoad,!1),this.content.addEventListener("error",this._onError,!1),delete this._onLoad,delete this._onError},EZ3.LoadManager=function(){this._cache=EZ3.Cache,this._files={},this.started=!1,this.filesToLoad=0,this.loadedFiles=0,this.failedFiles=0,this.onComplete=new EZ3.Signal,this.onProgress=new EZ3.Signal},EZ3.LoadManager.prototype._processLoad=function(a,b){this.loadedFiles++,this._cache.add(a,b),this._processProgress(a)},EZ3.LoadManager.prototype._processError=function(a,b){this.failedFiles++,this._processProgress(a,b)},EZ3.LoadManager.prototype._processProgress=function(a,b){var c,d;this.onProgress.dispatch(a,b,this.loadedFiles,this.failedFiles,this.filesToLoad),this.filesToLoad===this.loadedFiles+this.failedFiles&&(c=this.loadedFiles,d=this.failedFiles,this._files={},this.filesToLoad=0,this.loadedFiles=0,this.failedFiles=0,this.started=!1,this.onComplete.dispatch(d,c))},EZ3.LoadManager.prototype.data=function(a,b,c){var d;return(d=this._cache.data(a))?d:(this._files[a]=new EZ3.Data(a,b,c),this.filesToLoad++,this._files[a].content)},EZ3.LoadManager.prototype.image=function(a,b){var c;return(c=this._cache.image(a))?c:(this._files[a]||(this._files[a]=new EZ3.Image(a,b),this.filesToLoad++),this._files[a].content)},EZ3.LoadManager.prototype.obj=function(a,b){var c;return(c=this._cache.entity(a))?c:(this._files[a]=new EZ3.Obj(a,b),this.filesToLoad++,this._files[a].content)},EZ3.LoadManager.prototype.start=function(){var a;this.filesToLoad||this.onComplete.dispatch(0,0),this.started=!0;for(a in this._files)this._files[a].load(this._processLoad.bind(this),this._processError.bind(this))},EZ3.Obj=function(a,b){this.url=a,this.crossOrigin=b,this.content=new EZ3.Entity},EZ3.Obj.prototype._parseMaterial=function(){},EZ3.Obj.prototype._parse=function(a,b){function c(a){var b,c=[];for(a=a.split(" "),b=1;b<a.length-1;b++)c.push(a[0],a[b],a[b+1]);return c}function d(a){var b;for(b=1;4>b;b++)x.push(parseFloat(a[b]))}function e(a){var b;for(b=1;4>b;b++)y.push(parseFloat(a[b]))}function f(a){var b;for(b=1;3>b;b++)z.push(parseFloat(a[b]))}function g(a){return a=parseInt(a),0>=a?x.length/3+a:a-1}function h(a){return a=parseInt(a),0>=a?y.length/3+a:a-1}function i(a){return a=parseInt(a),0>=a?z.length/2+a:a-1}function j(a){var b,c,d,e;for(d=0;d<a.length;d++)if(b=g(a[d]),void 0===w[b])for(c=B.length/3,w[b]=c,A.push(c),e=0;3>e;e++)B.push(x[3*b+e]);else A.push(w[b])}function k(a){var b,c,d,e,f,h,j;for(h=0;h<a.length;h++){for(b=a[h].split("/"),c=g(b[0]),d=i(b[1]),e=-1,f=B.length/3,w[c]||(w[c]=[]),j=0;j<w[c].length;j++)if(w[c][j].uv===d){e=w[c][j].index;break}if(e>=0)A.push(e);else{for(w[c].push({uv:d,index:f}),A.push(f),j=0;3>j;j++)B.push(x[3*c+j]);for(j=0;2>j;j++)D.push(z[2*d+j])}}}function l(a){var b,c,d,e,f,j,k,l;for(k=0;k<a.length;k++){for(b=a[k].split("/"),c=g(b[0]),d=i(b[1]),e=h(b[2]),f=-1,j=B.length/3,w[c]||(w[c]=[]),l=0;l<w[c].length;l++)if(w[c][l].uv===d&&w[c][l].normal===e){f=w[c][l].index;break}if(f>=0)A.push(f);else{for(w[c].push({uv:d,normal:e,index:j}),A.push(j),l=0;3>l;l++)B.push(x[3*c+l]);for(l=0;2>l;l++)D.push(z[2*d+l]);for(l=0;3>l;l++)C.push(y[3*e+l])}}}function m(a){var b,c,d,e,f,i,j;for(i=0;i<a.length;i++){for(b=a[i].split("//"),c=g(b[0]),d=h(b[1]),e=-1,f=B.length/3,w[c]||(w[c]=[]),j=0;j<w[c].length;j++)if(w[c][j].normal===d){e=w[c][j].index;break}if(e>=0)A.push(e);else{for(w[c].push({normal:d,index:f}),A.push(f),j=0;3>j;j++)B.push(x[3*c+j]);for(j=0;3>j;j++)C.push(y[3*d+j])}}}function n(){var a;if(A.length){for(var b=-9999999,c=9999999,d=-9999999,e=9999999,f=0;f<D.length;f+=2)b=Math.max(b,D[f]),c=Math.min(c,D[f]),d=Math.max(d,D[f+1]),e=Math.min(e,D[f+1]);for(f=0;f<D.length;f+=2)D[f+1]=1-D[f+1];console.log(D),a=new EZ3.IndexBuffer(A,!1,!0),u.geometry.buffers.add("triangle",a),a=new EZ3.VertexBuffer(B),a.addAttribute("position",new EZ3.VertexBufferAttribute(3)),u.geometry.buffers.add("position",a),D.length&&(a=new EZ3.VertexBuffer(D),a.addAttribute("uv",new EZ3.VertexBufferAttribute(2)),u.geometry.buffers.add("uv",a),D=[]),C.length&&(a=new EZ3.VertexBuffer(C),a.addAttribute("normal",new EZ3.VertexBufferAttribute(3)),u.geometry.buffers.add("normal",a),C=[]),w=[],A=[],B=[],t.content.add(u),u=new EZ3.Mesh(new EZ3.Geometry,new EZ3.MeshMaterial)}}function o(){var a,c,d,e,f;for(a=new EZ3.LoadManager,c=[],d=t.url.split("/"),e=t.url.substr(0,t.url.length-d[d.length-1].length),f=0;f<F.length;f++)c.push(a.data(e+F[f]));a.onComplete.add(function(){var d;for(d=0;d<c.length;d++)p(e,c[d].response,a);a.onComplete.removeAll(),a.onComplete.add(function(){b(t.url,t.content)}),a.start()}),a.start()}function p(a,b,c){var d,e,f,g,h,i,j;for(d=b.split("\n"),i=0;i<d.length;i++)if(e=d[i].trim(),j=e.indexOf(" "),f=j>=0?e.substring(0,j):e,f=f.toLowerCase(),g=j>=0?e.substring(j+1):"",g=g.trim(),f=f.toLowerCase(),"newmtl"===f)h=E[g];else if("kd"===f);else if("ka"===f);else if("ks"===f);else if("ns"===f);else if("d"===f);else if("map_ka"===f);else if("map_kd"===f)for(var k=new EZ3.Texture2D(c.image(a+g)),l=0;l<h.length;l++)h[l].diffuseMap=k}var q,r,s,t=this,u=new EZ3.Mesh(new EZ3.Geometry,new EZ3.MeshMaterial),v=a.split("\n"),w=[],x=[],y=[],z=[],A=[],B=[],C=[],D=[],E=[],F=[];for(s=0;s<v.length;s++)q=v[s].trim().replace(/ +(?= )/g,""),0!==q.length&&"#"!==q.charAt(0)&&((r=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/.exec(q))?d(r):(r=/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/.exec(q))?e(r):(r=/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/.exec(q))?f(r):(r=/f\s(([+-]?\d+\s){2,}[+-]?\d+)/.exec(q))?j(c(r[1])):(r=/f\s(([+-]?\d+\/[+-]?\d+\s){2,}[+-]?\d+\/[+-]?\d+)/.exec(q))?k(c(r[1])):(r=/f\s((([+-]?\d+\/[+-]?\d+\/[+-]?\d+\s){2,})[+-]?\d+\/[+-]?\d+\/[+-]?\d+)/.exec(q))?l(c(r[1])):(r=/f\s(([+-]?\d+\/\/[+-]?\d+\s){2,}[+-]?\d+\/\/[+-]?\d+)/.exec(q))?m(c(r[1])):/^o/.test(q)||/^g/.test(q)||(/^mtllib/.test(q)?F.push(q.substring(7).trim()):/^usemtl/.test(q)&&(n(),u.material.name=q.substring(7).trim(),E[u.material.name]||(E[u.material.name]=[]),E[u.material.name].push(u.material))));n(),o()},EZ3.Obj.prototype.load=function(a,b){var c,d,e;return c=this,d=new EZ3.LoadManager,e=d.data(this.url),d.onComplete.add(function(){c._parse(e.response,a,b)}),d.start(),this.content},EZ3.Material=function(a){this._name=a,this.program=null,this.fill=EZ3.MeshMaterial.WIREFRAME,this.transparent=!1,this.backFaceCulling=!0,this.frontFaceCulling=!1,this.depthTest=!0},EZ3.Material.prototype.updateStates=function(a,b){this.depthTest?b.capability[EZ3.State.DEPTH_TEST]||(a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL),b.capability[EZ3.State.DEPTH_TEST]=!0):b.capability[EZ3.State.DEPTH_TEST]&&(a.disable(a.DEPTH_TEST),b.capability[EZ3.State.DEPTH_TEST]=!1),this.backFaceCulling?(b.capability[EZ3.State.CULL_FACE]||(a.enable(a.CULL_FACE),b.capability[EZ3.State.CULL_FACE]=!0),b.capability[EZ3.State.BACKFACE_CULLING]||(a.cullFace(a.BACK),b.capability[EZ3.State.BACKFACE_CULLING]=!0)):this.frontFaceCulling?(b.capability[EZ3.State.CULL_FACE]||(a.enable(a.CULL_FACE),b.capability[EZ3.State.CULL_FACE]=!0),b.capability[EZ3.State.FRONTFACE_CULLING]||(a.cullFace(a.FRONT),b.capability[EZ3.State.FRONTFACE_CULLING]=!0)):b.capability[EZ3.State.CULL_FACE]&&(a.disable(a.CULL_FACE),b.capability[EZ3.State.CULL_FACE]=!1)},EZ3.Material.SOLID=0,EZ3.Material.POINTS=1,EZ3.Material.WIREFRAME=2,EZ3.BoundingBox=function(a,b){},EZ3.BoundingSphere=function(a,b){},EZ3.Math=function(){this.PI=Math.PI,this.HALF_PI=.5*this.PI,this.DOUBLE_PI=2*this.PI,this.MAX_UINT=Math.pow(2,32)-1,this.MAX_USHORT=Math.pow(2,16)-1},EZ3.Math=new EZ3.Math,EZ3.Math.toRadians=function(a){return a*EZ3.Math.PI/180},EZ3.Math.toDegrees=function(a){return 180*a/EZ3.Math.PI},EZ3.Matrix3=function(a,b,c,d,e,f,g,h,i){this.dirty=!0,this._elements=[],this.init(a||1,b||0,c||0,d||0,e||1,f||0,g||0,h||0,i||1)},EZ3.Matrix3.prototype.constructor=EZ3.Matrix3,EZ3.Matrix3.prototype.init=function(a,b,c,d,e,f,g,h,i){
return this.elements=[a,b,c,d,e,f,g,h,i],this},EZ3.Matrix3.prototype.add=function(a,b){var c=this.elements,d=a.elements,e=b.elements;return c[0]=d[0]+e[0],c[1]=d[1]+e[1],c[2]=d[2]+e[2],c[3]=d[3]+e[3],c[4]=d[4]+e[4],c[5]=d[5]+e[5],c[6]=d[6]+e[6],c[7]=d[7]+e[7],c[8]=d[8]+e[8],this.dirty=!0,this},EZ3.Matrix3.prototype.addEqual=function(a){var b=a.elements;return this.elements[0]+=b[0],this.elements[1]+=b[1],this.elements[2]+=b[2],this.elements[3]+=b[3],this.elements[4]+=b[4],this.elements[5]+=b[5],this.elements[6]+=b[6],this.elements[7]+=b[7],this.elements[8]+=b[8],this.dirty=!0,this},EZ3.Matrix3.prototype.sub=function(a,b){var c=this.elements,d=a.elements,e=b.elements;return c[0]=d[0]-e[0],c[1]=d[1]-e[1],c[2]=d[2]-e[2],c[3]=d[3]-e[3],c[4]=d[4]-e[4],c[5]=d[5]-e[5],c[6]=d[6]-e[6],c[7]=d[7]-e[7],c[8]=d[8]-e[8],this.dirty=!0,this},EZ3.Matrix3.prototype.subEqual=function(a){var b=a.elements;return this.elements[0]-=b[0],this.elements[1]-=b[1],this.elements[2]-=b[2],this.elements[3]-=b[3],this.elements[4]-=b[4],this.elements[5]-=b[5],this.elements[6]-=b[6],this.elements[7]-=b[7],this.elements[8]-=b[8],this.dirty=!0,this},EZ3.Matrix3.prototype.scale=function(a,b){var c=a.elements;return this.elements[0]=c[0]*b,this.elements[1]=c[1]*b,this.elements[2]=c[2]*b,this.elements[3]=c[3]*b,this.elements[4]=c[4]*b,this.elements[5]=c[5]*b,this.elements[6]=c[6]*b,this.elements[7]=c[7]*b,this.elements[8]=c[8]*b,this.dirty=!0,this},EZ3.Matrix3.prototype.scaleEqual=function(a){return this.elements[0]*=a,this.elements[1]*=a,this.elements[2]*=a,this.elements[3]*=a,this.elements[4]*=a,this.elements[5]*=a,this.elements[6]*=a,this.elements[7]*=a,this.elements[8]*=a,this.dirty=!0,this},EZ3.Matrix3.prototype.mul=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=this.elements,w=a.elements;return void 0!==b?(c=b.elements,d=w[0],e=w[1],f=w[2],g=w[3],h=w[4],i=w[5],j=w[6],k=w[7],l=w[8],m=c[0],n=c[1],o=c[2],p=c[3],q=c[4],r=c[5],s=c[6],t=c[7],u=c[8]):(d=v[0],e=v[1],f=v[2],g=v[3],h=v[4],i=v[5],j=v[6],k=v[7],l=v[8],m=w[0],n=w[1],o=w[2],p=w[3],q=w[4],r=w[5],s=w[6],t=w[7],u=w[8]),this.elements[0]=d*m+e*p+f*s,this.elements[1]=d*n+e*q+f*t,this.elements[2]=d*o+e*r+f*u,this.elements[3]=g*m+h*p+i*s,this.elements[4]=g*n+h*q+i*t,this.elements[5]=g*o+h*r+i*u,this.elements[6]=j*m+k*p+l*s,this.elements[7]=j*n+k*q+l*t,this.elements[8]=j*o+k*r+l*u,this.dirty=!0,this},EZ3.Matrix3.prototype.mulScale=function(a,b,c,d,e){var f=a.elements,g=this.elements,h=e||!1;return h?(g[0]=b*f[0],g[1]=b*f[1],g[2]=b*f[2],g[3]=c*f[3],g[4]=c*f[4],g[5]=c*f[5],g[6]=d*f[6],g[7]=d*f[7],g[8]=d*f[8]):(g[0]=f[0]*b,g[1]=f[1]*c,g[2]=f[2]*d,g[3]=f[3]*b,g[4]=f[4]*c,g[5]=f[5]*d,g[6]=f[6]*b,g[7]=f[7]*c,g[8]=f[8]*d),this.elements=g,this},EZ3.Matrix3.prototype.mulRotate=function(a,b,c,d,e,f){var g=a.elements,h=Math.sin(b),i=Math.cos(b),j=1-i,k=c*c*j+i,l=c*d*j-e*h,m=c*e*j+d*h,n=d*c*j+e*h,o=d*d*j+i,p=d*e*j-c*h,q=e*c*j-d*h,r=e*d*j+c*h,s=e*e*j+i,t=g[0],u=g[3],v=g[6],w=g[1],x=g[4],y=g[7],z=g[2],A=g[5],B=g[8],C=f||!1;return C?(this.elements[0]=k*t+l*u+m*v,this.elements[1]=k*w+l*x+m*y,this.elements[2]=k*z+l*A+m*B,this.elements[3]=n*t+o*u+p*v,this.elements[4]=n*w+o*x+p*y,this.elements[5]=n*z+o*A+p*B,this.elements[6]=q*t+r*u+s*v,this.elements[7]=q*w+r*x+s*y,this.elements[8]=q*z+r*A+s*B):(this.elements[0]=t*k+w*n+z*q,this.elements[1]=t*l+w*o+z*r,this.elements[2]=t*m+w*p+z*s,this.elements[3]=u*k+x*n+A*q,this.elements[4]=u*l+x*o+A*r,this.elements[5]=u*m+x*p+A*s,this.elements[6]=v*k+y*n+B*q,this.elements[7]=v*l+y*o+B*r,this.elements[8]=v*m+y*p+B*s),this.dirty=!0,this},EZ3.Matrix3.prototype.transpose=function(a){var b=void 0!==a?a.elements:this.elements,c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8];return this.elements[0]=c,this.elements[1]=f,this.elements[2]=i,this.elements[3]=d,this.elements[4]=g,this.elements[5]=j,this.elements[6]=e,this.elements[7]=h,this.elements[8]=k,this.dirty=!0,this},EZ3.Matrix3.prototype.setQuat=function(a){var b=2*a.x,c=2*a.y,d=2*a.z,e=a.x*b,f=a.y*c,g=a.z*d,h=a.x*c,i=a.y*d,j=a.x*d,k=a.s*b,l=a.s*c,m=a.s*d;return this.elements[0]=1-f-g,this.elements[1]=h-m,this.elements[2]=j+l,this.elements[3]=h+m,this.elements[4]=1-e-g,this.elements[5]=i-k,this.elements[6]=j-l,this.elements[7]=i+k,this.elements[8]=1-e-f,this.dirty=!0,this},EZ3.Matrix3.prototype.invert=function(a){var b=void 0!==a?a.elements:this.elements,c=b[0],d=b[3],e=b[6],f=b[1],g=b[4],h=b[7],i=b[2],j=b[5],k=b[8],l=g*k-h*j,m=h*i-f*k,n=f*j-g*i,o=c*l+d*m+e*n;return 0!==o&&(o=1/o),this.elements[0]=o*l,this.elements[1]=o*m,this.elements[2]=o*n,this.elements[3]=o*(j*e-d*k),this.elements[4]=o*(c*k-i*e),this.elements[5]=o*(i*d-c*j),this.elements[6]=o*(d*h-g*e),this.elements[7]=o*(f*e-c*h),this.elements[8]=o*(c*g-f*d),this.dirty=!0,this},EZ3.Matrix3.prototype.normalFromMat4=function(a){var b,c=a.elements,d=c[0],e=c[1],f=c[2],g=c[3],h=c[4],i=c[5],j=c[6],k=c[7],l=c[8],m=c[9],n=c[10],o=c[11],p=c[12],q=c[13],r=c[14],s=c[15],t=d*i-e*h,u=d*j-f*h,v=d*k-g*h,w=e*j-f*i,x=e*k-g*i,y=f*k-g*j,z=l*q-m*p,A=l*r-n*p,B=l*s-o*p,C=m*r-n*q,D=m*s-o*q,E=n*s-o*r;return(b=t*E-u*D+v*C+w*B-x*A+y*z)?(b=1/b,this.elements[0]=(i*E-j*D+k*C)*b,this.elements[1]=(j*B-h*E-k*A)*b,this.elements[2]=(h*D-i*B+k*z)*b,this.elements[3]=(f*D-e*E-g*C)*b,this.elements[4]=(d*E-f*B+g*A)*b,this.elements[5]=(e*B-d*D-g*z)*b,this.elements[6]=(q*y-r*x+s*w)*b,this.elements[7]=(r*v-p*y-s*u)*b,this.elements[8]=(p*x-q*v+s*t)*b,this.dirty=!0,this):null},EZ3.Matrix3.prototype.identity=function(){return this.elements=[1,0,0,1,1,0,1,0,1],this},EZ3.Matrix3.prototype.clone=function(){return new EZ3.Matrix3(this.elements[0],this.elements[1],this.elements[2],this.elements[3],this.elements[4],this.elements[5],this.elements[6],this.elements[7],this.elements[8])},EZ3.Matrix3.prototype.copy=function(a){return this.elements=a.elements,this},EZ3.Matrix3.prototype.toArray=function(){return this.elements},EZ3.Matrix3.prototype.toString=function(){return"Matrix3[\n"+this.elements[0].toFixed(4)+", "+this.elements[1].toFixed(4)+", "+this.elements[2].toFixed(4)+"\n"+this.elements[3].toFixed(4)+", "+this.elements[4].toFixed(4)+", "+this.elements[5].toFixed(4)+"\n"+this.elements[6].toFixed(4)+", "+this.elements[7].toFixed(4)+", "+this.elements[8].toFixed(4)+"\n]"},EZ3.Matrix3.prototype.testEqual=function(a){return a instanceof EZ3.Matrix3?a.elements[0]===this.elements[0]&&a.elements[1]===this.elements[1]&&a.elements[2]===this.elements[2]&&a.elements[3]===this.elements[3]&&a.elements[4]===this.elements[4]&&a.elements[5]===this.elements[5]&&a.elements[6]===this.elements[6]&&a.elements[7]===this.elements[7]&&a.elements[8]===this.elements[8]:!1},EZ3.Matrix3.prototype.set=EZ3.Matrix3.prototype.init,Object.defineProperty(EZ3.Matrix3.prototype,"elements",{get:function(){return this._elements},set:function(a){this._elements=a,this.dirty=!0}}),EZ3.Matrix4=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){this._elements=[],this.dirty=!0,this.init(a||1,b||0,c||0,d||0,e||0,f||1,g||0,h||0,i||0,j||0,k||1,l||0,m||0,n||0,o||0,p||1)},EZ3.Matrix4.prototype.constructor=EZ3.Matrix4,EZ3.Matrix4.prototype.init=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){return this.elements=[a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p],this},EZ3.Matrix4.prototype.transpose=function(a){var b,c,d,e,f,g,h;return void 0!==a?(h=a.elements,b=h[1],c=h[2],d=h[3],e=h[6],f=h[7],g=h[11],this.elements[1]=h[4],this.elements[2]=h[8],this.elements[3]=h[12],this.elements[4]=b,this.elements[6]=h[9],this.elements[7]=h[13],this.elements[8]=c,this.elements[9]=e,this.elements[11]=h[14],this.elements[12]=d,this.elements[13]=f,this.elements[14]=g):(h=this.elements,this.elements[0]=h[0],this.elements[1]=h[4],this.elements[2]=h[8],this.elements[3]=h[12],this.elements[4]=h[1],this.elements[5]=h[5],this.elements[6]=h[9],this.elements[7]=h[13],this.elements[8]=h[2],this.elements[9]=h[6],this.elements[10]=h[10],this.elements[11]=h[14],this.elements[12]=h[3],this.elements[13]=h[7],this.elements[14]=h[11],this.elements[15]=h[15]),this.dirty=!0,this},EZ3.Matrix4.prototype.invert=function(a){var b,c=a.elements,d=c[0],e=c[1],f=c[2],g=c[3],h=c[4],i=c[5],j=c[6],k=c[7],l=c[8],m=c[9],n=c[10],o=c[11],p=c[12],q=c[13],r=c[14],s=c[15],t=d*i-e*h,u=d*j-f*h,v=d*k-g*h,w=e*j-f*i,x=e*k-g*i,y=f*k-g*j,z=l*q-m*p,A=l*r-n*p,B=l*s-o*p,C=m*r-n*q,D=m*s-o*q,E=n*s-o*r;return(b=t*E-u*D+v*C+w*B-x*A+y*z)?(b=1/b,this.elements[0]=(i*E-j*D+k*C)*b,this.elements[1]=(f*D-e*E-g*C)*b,this.elements[2]=(q*y-r*x+s*w)*b,this.elements[3]=(n*x-m*y-o*w)*b,this.elements[4]=(j*B-h*E-k*A)*b,this.elements[5]=(d*E-f*B+g*A)*b,this.elements[6]=(r*v-p*y-s*u)*b,this.elements[7]=(l*y-n*v+o*u)*b,this.elements[8]=(h*D-i*B+k*z)*b,this.elements[9]=(e*B-d*D-g*z)*b,this.elements[10]=(p*x-q*v+s*t)*b,this.elements[11]=(m*v-l*x-o*t)*b,this.elements[12]=(i*A-h*C-j*z)*b,this.elements[13]=(d*C-e*A+f*z)*b,this.elements[14]=(q*u-p*w-r*t)*b,this.elements[15]=(l*w-m*u+n*t)*b,this.dirty=!0,this):null},EZ3.Matrix4.prototype.mul=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;return void 0!==b?(c=a.elements,d=b.elements):(c=this.elements,d=a.elements),e=c[0],f=c[1],g=c[2],h=c[3],i=c[4],j=c[5],k=c[6],l=c[7],m=c[8],n=c[9],o=c[10],p=c[11],q=c[12],r=c[13],s=c[14],t=c[15],u=d[0],v=d[1],w=d[2],x=d[3],y=d[4],z=d[5],A=d[6],B=d[7],C=d[8],D=d[9],E=d[10],F=d[11],G=d[12],H=d[13],I=d[14],J=d[15],this.elements[0]=e*u+f*y+g*C+h*G,this.elements[1]=e*v+f*z+g*D+h*H,this.elements[2]=e*w+f*A+g*E+h*I,this.elements[3]=e*x+f*B+g*F+h*J,this.elements[4]=i*u+j*y+k*C+l*G,this.elements[5]=i*v+j*z+k*D+l*H,this.elements[6]=i*w+j*A+k*E+l*I,this.elements[7]=i*x+j*B+k*F+l*J,this.elements[8]=m*u+n*y+o*C+p*G,this.elements[9]=m*v+n*z+o*D+p*H,this.elements[10]=m*w+n*A+o*E+p*I,this.elements[11]=m*x+n*B+o*F+p*J,this.elements[12]=q*u+r*y+s*C+t*G,this.elements[13]=q*v+r*z+s*D+t*H,this.elements[14]=q*w+r*A+s*E+t*I,this.elements[15]=q*x+r*B+s*F+t*J,this.dirty=!0,this},EZ3.Matrix4.prototype.translate=function(a,b){var c=a.elements,d=b.x,e=b.y,f=b.z,g=c[0],h=c[1],i=c[2],j=c[3],k=c[0],l=c[1],m=c[2],n=c[3],o=c[0],p=c[1],q=c[2],r=c[3];return this.elements[0]=g,this.elements[1]=h,this.elements[2]=i,this.elements[3]=j,this.elements[4]=k,this.elements[5]=l,this.elements[6]=m,this.elements[7]=n,this.elements[8]=o,this.elements[9]=p,this.elements[10]=q,this.elements[11]=r,this.elements[12]=g*d+k*e+o*f+this.elements[12],this.elements[13]=h*d+l*e+p*f+this.elements[13],this.elements[14]=i*d+m*e+q*f+this.elements[14],this.elements[15]=j*d+n*e+r*f+this.elements[15],this.dirty=!0,this},EZ3.Matrix4.prototype.scale=function(a,b){var c=b.x,d=b.y,e=b.z,f=a.elements;return this.elements[0]=f[0]*c,this.elements[1]=f[1]*c,this.elements[2]=f[2]*c,this.elements[3]=f[3]*c,this.elements[4]=f[4]*d,this.elements[5]=f[5]*d,this.elements[6]=f[6]*d,this.elements[7]=f[7]*d,this.elements[8]=f[8]*e,this.elements[9]=f[9]*e,this.elements[10]=f[10]*e,this.elements[11]=f[11]*e,this.elements[12]=f[12],this.elements[13]=f[13],this.elements[14]=f[14],this.elements[15]=f[15],this.dirty=!0,this},EZ3.Matrix4.prototype.setQuat=function(a){var b=2*a.x,c=2*a.y,d=2*a.z,e=a.x*b,f=a.y*c,g=a.z*d,h=a.x*c,i=a.y*d,j=a.x*d,k=a.s*b,l=a.s*c,m=a.s*d;return this.elements[0]=1-f-g,this.elements[1]=h-m,this.elements[2]=j+l,this.elements[3]=0,this.elements[4]=h+m,this.elements[5]=1-e-g,this.elements[6]=i-k,this.elements[7]=0,this.elements[8]=j-l,this.elements[9]=i+k,this.elements[10]=1-e-f,this.elements[11]=0,this.elements[12]=0,this.elements[13]=0,this.elements[14]=0,this.elements[15]=1,this.dirty=!0,this},EZ3.Matrix4.prototype.fromRotationTranslation=function(a,b,c){var d=2*b.x,e=2*b.y,f=2*b.z,g=b.x*d,h=b.y*e,i=b.z*f,j=b.x*e,k=b.y*f,l=b.x*f,m=b.s*d,n=b.s*e,o=b.s*f;return this.elements[0]=1-h-i,this.elements[1]=j-o,this.elements[2]=l+n,this.elements[3]=0,this.elements[4]=j+o,this.elements[5]=1-g-i,this.elements[6]=k-m,this.elements[7]=0,this.elements[8]=l-n,this.elements[9]=k+m,this.elements[10]=1-g-h,this.elements[11]=0,this.elements[12]=c.x,this.elements[13]=c.y,this.elements[14]=c.z,this.elements[15]=1,this.dirty=!0,this},EZ3.Matrix4.prototype.perspective=function(a,b,c,d){var e=1/Math.tan(a/2),f=1/(c-d);return this.elements[0]=e/b,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=0,this.elements[5]=e,this.elements[6]=0,this.elements[7]=0,this.elements[8]=0,this.elements[9]=0,this.elements[10]=(d+c)*f,this.elements[11]=-1,this.elements[12]=0,this.elements[13]=0,this.elements[14]=2*d*c*f,this.elements[15]=0,this.dirty=!0,this},EZ3.Matrix4.prototype.frustum=function(a,b,c,d,e,f){var g=1/(b-a),h=1/(d-c),i=1/(e-f);return this.elements[0]=2*e*g,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=0,this.elements[5]=2*e*h,this.elements[6]=0,this.elements[7]=0,this.elements[8]=(b+a)*g,this.elements[9]=(d+c)*h,this.elements[10]=(f+e)*i,this.elements[11]=-1,this.elements[12]=0,this.elements[13]=0,this.elements[14]=f*e*2*i,this.elements[15]=0,this.dirty=!0,this},EZ3.Matrix4.prototype.ortho=function(a,b,c,d,e,f){var g=1/(a-b),h=1/(c-d),i=1/(e-f);return this.elements[0]=-2*g,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=0,this.elements[5]=-2*h,this.elements[6]=0,this.elements[7]=0,this.elements[8]=0,this.elements[9]=0,this.elements[10]=2*i,this.elements[11]=0,this.elements[12]=(a+b)*g,this.elements[13]=(d+c)*h,this.elements[14]=(f+e)*i,this.elements[15]=1,this.dirty=!0,this},EZ3.Matrix4.prototype.lookAt=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;return n=c.x,o=c.y,p=c.z,q=a.x,r=a.y,s=a.z,t=b.x,u=b.y,v=b.z,Math.abs(q-t)<1e-6&&Math.abs(r-u)<1e-6&&Math.abs(s-v)<1e-6?this.identity():(k=q-t,l=r-u,m=s-v,d=1/Math.sqrt(k*k+l*l+m*m),k*=d,l*=d,m*=d,e=o*m-p*l,f=p*k-n*m,g=n*l-o*k,d=Math.sqrt(e*e+f*f+g*g),d?(d=1/d,e*=d,f*=d,g*=d):(e=0,f=0,g=0),h=l*g-m*f,i=m*e-k*g,j=k*f-l*e,d=Math.sqrt(h*h+i*i+j*j),d?(d=1/d,h*=d,i*=d,j*=d):(h=0,i=0,j=0),this.elements[0]=e,this.elements[1]=h,this.elements[2]=k,this.elements[3]=0,this.elements[4]=f,this.elements[5]=i,this.elements[6]=l,this.elements[7]=0,this.elements[8]=g,this.elements[9]=j,this.elements[10]=m,this.elements[11]=0,this.elements[12]=-(e*q+f*r+g*s),this.elements[13]=-(h*q+i*r+j*s),this.elements[14]=-(k*q+l*r+m*s),this.elements[15]=1,this.dirty=!0,this)},EZ3.Matrix4.prototype.identity=function(){return this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this},EZ3.Matrix4.prototype.yawPitchRoll=function(a,b,c){var d=Math.cos(a),e=Math.sin(a),f=Math.cos(b),g=Math.sin(b),h=Math.cos(c),i=Math.sin(c);return this.elements[0]=d*h+e*g*i,this.elements[1]=i*f,this.elements[2]=-e*h+d*g*i,this.elements[3]=0,this.elements[4]=-d*i+e*g*h,this.elements[5]=h*f,this.elements[6]=i*e+d*g*h,this.elements[7]=0,this.elements[8]=e*f,this.elements[9]=-g,this.elements[10]=d*f,this.elements[11]=0,this.elements[12]=0,this.elements[13]=0,this.elements[14]=0,this.elements[15]=1,this},EZ3.Matrix4.prototype.clone=function(){return new EZ3.Matrix4(this.elements[0],this.elements[1],this.elements[2],this.elements[3],this.elements[4],this.elements[5],this.elements[6],this.elements[7],this.elements[8],this.elements[9],this.elements[10],this.elements[11],this.elements[12],this.elements[13],this.elements[14],this.elements[15])},EZ3.Matrix4.prototype.copy=function(a){return this.elements[0]=a.elements[0],this.elements[1]=a.elements[1],this.elements[2]=a.elements[2],this.elements[3]=a.elements[3],this.elements[4]=a.elements[4],this.elements[5]=a.elements[5],this.elements[6]=a.elements[6],this.elements[7]=a.elements[7],this.elements[8]=a.elements[8],this.elements[9]=a.elements[9],this.elements[10]=a.elements[10],this.elements[11]=a.elements[11],this.elements[12]=a.elements[12],this.elements[13]=a.elements[13],this.elements[14]=a.elements[14],this.elements[15]=a.elements[15],this.dirty=!0,this},EZ3.Matrix4.prototype.toArray=function(){return this.elements},EZ3.Matrix4.prototype.toString=function(){return"Matrix4[\n"+this.elements[0].toFixed(4)+", "+this.elements[1].toFixed(4)+", "+this.elements[2].toFixed(4)+", "+this.elements[3].toFixed(4)+"\n"+this.elements[4].toFixed(4)+", "+this.elements[5].toFixed(4)+", "+this.elements[6].toFixed(4)+", "+this.elements[7].toFixed(4)+"\n"+this.elements[8].toFixed(4)+", "+this.elements[9].toFixed(4)+", "+this.elements[10].toFixed(4)+", "+this.elements[11].toFixed(4)+"\n"+this.elements[12].toFixed(4)+", "+this.elements[13].toFixed(4)+", "+this.elements[14].toFixed(4)+", "+this.elements[15].toFixed(4)+"\n]"},EZ3.Matrix4.prototype.testEqual=function(a){return a instanceof EZ3.Matrix4?a.elements[0]===this.elements[0]&&a.elements[1]===this.elements[1]&&a.elements[2]===this.elements[2]&&a.elements[3]===this.elements[3]&&a.elements[4]===this.elements[4]&&a.elements[5]===this.elements[5]&&a.elements[6]===this.elements[6]&&a.elements[7]===this.elements[7]&&a.elements[8]===this.elements[8]&&a.elements[9]===this.elements[9]&&a.elements[10]===this.elements[10]&&a.elements[11]===this.elements[11]&&a.elements[12]===this.elements[12]&&a.elements[13]===this.elements[13]&&a.elements[14]===this.elements[14]&&a.elements[15]===this.elements[15]:!1},EZ3.Matrix4.prototype.testDiff=function(a){return a instanceof EZ3.Matrix4?a.elements[0]!==this.elements[0]||a.elements[1]!==this.elements[1]||a.elements[2]!==this.elements[2]||a.elements[3]!==this.elements[3]||a.elements[4]!==this.elements[4]||a.elements[5]!==this.elements[5]||a.elements[6]!==this.elements[6]||a.elements[7]!==this.elements[7]||a.elements[8]!==this.elements[8]||a.elements[9]!==this.elements[9]||a.elements[10]!==this.elements[10]||a.elements[11]!==this.elements[11]||a.elements[12]!==this.elements[12]||a.elements[13]!==this.elements[13]||a.elements[14]!==this.elements[14]||a.elements[15]!==this.elements[15]:!1},EZ3.Matrix4.prototype.set=EZ3.Matrix4.prototype.init,Object.defineProperty(EZ3.Matrix4.prototype,"elements",{get:function(){return this._elements},set:function(a){this._elements=a,this.dirty=!0}}),EZ3.Quaternion=function(a,b,c,d){this.s=void 0!==a?a:1,this.x=b||0,this.y=c||0,this.z=d||0,this.dirty=!0},EZ3.Quaternion.prototype.constructor=EZ3.Quaternion,EZ3.Quaternion.prototype.init=function(a,b,c,d){return this.s=void 0!==a?a:1,this.x=b||0,this.y=c||0,this.z=d||0,this},EZ3.Quaternion.prototype.add=function(a,b){return void 0!==b?(this.s=a.s+b.s,this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z):(this.s+=a.s,this.x+=a.x,this.y+=a.y,this.z+=a.z),this},EZ3.Quaternion.prototype.addTime=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n;return c=a.x,d=a.y,e=a.z,f=this.s,g=this.x,h=this.y,i=this.z,b*=.5,j=(-c*g-d*h-e*i)*b,k=(c*f+d*i-e*h)*b,l=(-c*i+d*f+e*g)*b,m=(c*h-d*g+e*f)*b,f+=j,g+=k,h+=l,i+=m,n=1/Math.sqrt(f*f+g*g+h*h+i*i),this.s=f*n,this.x=g*n,this.y=h*n,this.z=i*n,this},EZ3.Quaternion.prototype.sub=function(a,b){return void 0!==b?(this.s=a.s-b.s,this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z):(this.s-=a.s,this.x-=a.x,this.y-=a.y,this.z-=a.z),this.dirty=!0,this},EZ3.Quaternion.prototype.scale=function(a,b){return this.s=a.s*b,this.x=a.x*b,this.y=a.y*b,this.z=a.z*b,this},EZ3.Quaternion.prototype.mul=function(a,b){var c,d,e,f,g,h,i,j;return c=a.x,d=a.y,e=a.z,f=a.s,void 0!==b?(g=b.x,h=b.y,i=b.z,j=b.s):(g=this.x,h=this.y,i=this.z,j=this.s),this.s=f*j-c*g-d*h-e*i,this.x=c*j+f*g+d*i-e*h,this.y=d*j+f*h+e*g-c*i,this.z=e*j+f*i+c*h-d*g,this},EZ3.Quaternion.prototype.arc=function(a,b){var c,d,e,f,g,h,i,j,k,l;return c=a.x,d=a.y,e=a.z,f=b.x,g=b.y,h=b.z,l=c*f+d*g+e*h,-1===l?(f=d*c-e*e,g=-e*d-c*c,h=c*e+d*d,l=1/Math.sqrt(f*f+g*g+h*h),this.s=0,this.x=f*l,this.y=g*l,this.z=h*l):(i=d*h-e*g,j=e*f-c*h,k=c*g-d*f,this.s=Math.sqrt(.5*(1+l)),l=.5/this.s,this.x=i*l,this.y=j*l,this.z=k*l),this},EZ3.Quaternion.prototype.normalize=function(a){var b,c,d,e,f;return void 0!==a?(b=Math.sqrt(a.s*a.s+a.x*a.x+a.y*a.y+a.z*a.z),b>0&&(b=1/b),this.s=a.s*b,this.x=a.x*b,this.y=a.y*b,this.z=a.z*b):(c=this.s*this.s,d=this.x*this.x,e=this.y*this.y,f=this.z*this.z,b=Math.sqrt(c+d+e+f),b>0&&(b=1/b),this.s=this.s*b,this.x=this.x*b,this.y=this.y*b,this.z=this.z*b),this},EZ3.Quaternion.prototype.invert=function(a){return void 0!==a?(this.s=a.s,this.x=-a.x,this.y=-a.y,this.z=-a.z):(this.s=+this.s,this.x=-this.x,this.y=-this.y,this.z=-this.z),this},EZ3.Quaternion.prototype.length=function(){var a=this.s*this.s,b=this.x*this.x,c=this.y*this.y,d=this.z*this.z;return Math.sqrt(a+b+c+d)},EZ3.Quaternion.prototype.testDiff=function(a){var b=this.s!==a.s,c=this.x!==a.x,d=this.y!==a.y,e=this.z!==a.z;return b||c||d||e},EZ3.Quaternion.prototype.fromAxisAngle=function(a,b){var c=Math.sin(.5*b);return this.x=c*a.x,this.y=c*a.y,this.z=c*a.z,this.s=Math.cos(.5*b),this},EZ3.Quaternion.prototype.toMatrix3=function(a,b){var c,d,e,f,g,h,i,j,k,l=new EZ3.Matrix3;return b?(c=2*b.y*b.y,d=2*b.x*b.y,e=2*b.x*b.z,f=2*b.y*b.z,g=2*b.z*b.z,h=2*b.s*b.z,i=2*b.s*b.y,j=2*b.s*b.x,k=2*b.x*b.x):(c=2*this.y*this.y,d=2*this.x*this.y,e=2*this.x*this.z,f=2*this.y*this.z,g=2*this.z*this.z,h=2*this.s*this.z,i=2*this.s*this.y,j=2*this.s*this.x,k=2*this.x*this.x),l.elements[0]=-c-g+1,l.elements[1]=d-a*h,l.elements[2]=e+a*i,l.elements[3]=d+a*h,l.elements[4]=-k-g+1,l.elements[5]=f-a*j,l.elements[6]=e-a*i,l.elements[7]=f+a*j,l.elements[8]=-k-c+1,l},EZ3.Quaternion.prototype.copy=function(a){return this.s=a.s,this.x=a.x,this.y=a.y,this.z=a.z,this},EZ3.Quaternion.prototype.clone=function(){return new EZ3.Quaternion(this.s,this.x,this.y,this.z)},EZ3.Quaternion.prototype.toString=function(){var a=this.x.toFixed(4),b=this.y.toFixed(4),c=this.z.toFixed(4),d=this.s.toFixed(4);return"Quaternion["+d+", "+a+", "+b+", "+c+" ]"},Object.defineProperty(EZ3.Quaternion.prototype,"s",{get:function(){return this._s},set:function(a){this._s=a,this.dirty=!0}}),Object.defineProperty(EZ3.Quaternion.prototype,"x",{get:function(){return this._x},set:function(a){this._x=a,this.dirty=!0}}),Object.defineProperty(EZ3.Quaternion.prototype,"y",{get:function(){return this._y},set:function(a){this._y=a,this.dirty=!0}}),Object.defineProperty(EZ3.Quaternion.prototype,"z",{get:function(){return this._z},set:function(a){this._z=a,this.dirty=!0}}),EZ3.Quaternion.NORMAL=1,EZ3.Quaternion.INVERSE=-1,EZ3.Vector2=function(a,b){this._x=a||0,this._y=b||0,this.dirty=!0},EZ3.Vector2.prototype.init=function(a,b){return this.x=a||0,this.y=b||0,this},EZ3.Vector2.prototype.set=function(a,b){return this.x=a,this.y=b,this},EZ3.Vector2.prototype.add=function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this},EZ3.Vector2.prototype.addEqual=function(a){return this.x+=a.x,this.y+=a.y,this},EZ3.Vector2.prototype.sub=function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this},EZ3.Vector2.prototype.subEqual=function(a){return this.x-=a.x,this.y-=a.y,this},EZ3.Vector2.prototype.addScale=function(a,b){return this.x+=a.x*b,this.y+=a.y*b,this},EZ3.Vector2.prototype.scale=function(a,b){return this.x=a.x*b,this.y=a.y*b,this},EZ3.Vector2.prototype.scaleEqual=function(a){return this.x*=a,this.y*=a,this},EZ3.Vector2.prototype.div=function(a,b){return b.hasZero()||(this.x=a.x/b.x,this.y=a.y/b.y),this},EZ3.Vector2.prototype.divEqual=function(a){return a.hasZero()||(this.x/=a.x,this.y/=a.y,this.z/=a.z),this},EZ3.Vector2.prototype.dot=function(a,b){return void 0!==b?a.x*b.x+a.y*b.y:this.x*a.x+this.y*a.y},EZ3.Vector2.prototype.max=function(a,b){return void 0!==b?(this.x=a.x>b.x?a.x:b.x,this.y=a.y>b.y?a.y:b.y):(this.x<a.x&&(this.x=a.x),this.y<a.y&&(this.y=a.y)),this},EZ3.Vector2.prototype.min=function(a,b){return void 0!==b?(this.x=a.x<b.x?a.x:b.x,this.y=a.y<b.y?a.y:b.y):(this.x>a.x&&(this.x=a.x),this.y>a.y&&(this.y=a.y)),this},EZ3.Vector2.prototype.length=function(a){return void 0!==a?Math.sqrt(a.dot(a)):Math.sqrt(this.dot(this))},EZ3.Vector2.prototype.normalize=function(a){var b;return void 0!==a?(b=a.length(),b>0&&(b=1/b,this.x=a.x*b,this.y=a.y*b)):(b=this.length(),b>0&&(b=1/b,this.x*=b,this.y*=b)),this},EZ3.Vector2.prototype.invert=function(a){return void 0!==a?(this.x=-a.x,this.y=-a.y):(this.x=-this.x,this.y=-this.y),this},EZ3.Vector2.prototype.copy=function(a){return this.x=a.x,this.y=a.y,this},EZ3.Vector2.prototype.clone=function(){return new EZ3.Vector2(this.x,this.y)},EZ3.Vector2.prototype.toArray=function(){return[this.x,this.y]},EZ3.Vector2.prototype.testEqual=function(a){return a instanceof EZ3.Vector2?this.x===a.x&&this.y===a.y:!1},EZ3.Vector2.prototype.hasZero=function(a){return void 0!==a?0===a.x||0===a.y:0===this.x||0===this.y},EZ3.Vector2.prototype.testZero=function(a){return void 0!==a?0===a.x&&0===a.y:0===this.x&&0===this.y},EZ3.Vector2.prototype.testDiff=function(a){return this.x!==a.x&&this.y!==a.y},EZ3.Vector2.prototype.toString=function(){return"Vector2["+this.x.toFixed(4)+", "+this.y.toFixed(4)+"]"},Object.defineProperty(EZ3.Vector2.prototype,"x",{get:function(){return this._x},set:function(a){this._x=a,this.dirty=!0}}),Object.defineProperty(EZ3.Vector2.prototype,"y",{get:function(){return this._y},set:function(a){this._y=a,this.dirty=!0}}),EZ3.Vector3=function(a,b,c){this._x=a||0,this._y=b||0,this._z=c||0,this.dirty=!0},EZ3.Vector3.prototype.constructor=EZ3.Vector3,EZ3.Vector3.prototype.init=function(a,b,c){return this.x=a||0,this.y=b||0,this.z=c||0,this},EZ3.Vector3.prototype.set=function(a,b,c){return this.x=a,this.y=b,this.z=c,this},EZ3.Vector3.prototype.add=function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this},EZ3.Vector3.prototype.addEqual=function(a){return this.x+=a.x,this.y+=a.y,this.z+=a.z,this},EZ3.Vector3.prototype.sub=function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this},EZ3.Vector3.prototype.subEqual=function(a){return this.x-=a.x,this.y-=a.y,this.z-=a.z,this},EZ3.Vector3.prototype.addScale=function(a,b){this.x+=a.x*b,this.y+=a.y*b,this.z+=a.z*b},EZ3.Vector3.prototype.scale=function(a,b){return this.x=a.x*b,this.y=a.y*b,this.z=a.z*b,this},EZ3.Vector3.prototype.scaleEqual=function(a){return this.x*=a,this.y*=a,this.z*=a,this},EZ3.Vector3.prototype.div=function(a,b){return void 0!==b?b.hasZero()||(this.x=a.x/b.x,this.y=a.y/b.y,this.z=a.z/b.z):a.hasZero()||(this.x=this.x/a.x,this.y=this.y/a.y,this.z=this.z/a.z),this},EZ3.Vector3.prototype.divEqual=function(a){return a.hasZero()||(this.x/=a.x,this.y/=a.y,this.z/=a.z),this},EZ3.Vector3.prototype.dot=function(a,b){return void 0!==b?a.x*b.x+a.y*b.y+a.z*b.z:this.x*a.x+this.y*a.y+this.z*a.z},EZ3.Vector3.prototype.max=function(a,b){return void 0!==b?(this.x=a.x>b.x?a.x:b.x,this.y=a.y>b.y?a.y:b.y,this.z=a.z>b.z?a.z:b.z):(this.x<a.x&&(this.x=a.x),this.y<a.y&&(this.y=a.y),this.z<a.z&&(this.z=a.z)),this},EZ3.Vector3.prototype.min=function(a,b){return void 0!==b?(this.x=a.x<b.x?a.x:b.x,this.y=a.y<b.y?a.y:b.y,this.z=a.z<b.z?a.z:b.z):(this.x>a.x&&(this.x=a.x),this.y>a.y&&(this.y=a.y),this.z>a.z&&(this.z=a.z)),this},EZ3.Vector3.prototype.len=function(){return this.x*this.x+this.y*this.y+this.z*this.z},EZ3.Vector3.prototype.mul=function(a,b,c){var d=c.elements;return this.x=a.x+b.x*d[0]+b.y*d[1]+b.z*d[2],this.y=a.y+b.x*d[3]+b.y*d[4]+b.z*d[5],this.z=a.z+b.x*d[6]+b.y*d[7]+b.z*d[8],this},EZ3.Vector3.prototype.cross=function(a,b){var c,d,e;return void 0!==b?(c=a.y*b.z-a.z*b.y,d=a.z*b.x-a.x*b.z,e=a.x*b.y-a.y*b.x):(c=a.y*this.z-a.z*this.y,d=a.z*this.x-a.x*this.z,e=a.x*this.y-a.y*this.x),this.x=c,this.y=d,this.z=e,this},EZ3.Vector3.prototype.mulMat=function(a,b){var c,d,e,f=a.elements;return void 0!==b?(c=b.x,d=b.y,e=b.z):(c=this.x,d=this.y,e=this.z),this.x=c*f[0]+d*f[1]+e*f[2],this.y=c*f[3]+d*f[4]+e*f[5],this.z=c*f[6]+d*f[7]+e*f[8],this},EZ3.Vector3.prototype.applyQuaternion=function(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,g=a.z,h=a.s,i=h*b+f*d-g*c,j=h*c+g*b-e*d,k=h*d+e*c-f*b,l=-e*b-f*c-g*d;return this.x=i*h+l*-e+j*-g-k*-f,this.y=j*h+l*-f+k*-e-i*-g,this.z=k*h+l*-g+i*-f-j*-e,this},EZ3.Vector3.prototype.length=function(a){return void 0!==a?Math.sqrt(a.dot(a)):Math.sqrt(this.dot(this))},EZ3.Vector3.prototype.normalize=function(a){var b;return void 0!==a?(b=a.length(),b>0&&(b=1/b,this.x=a.x*b,this.y=a.y*b,this.z=a.z*b)):(b=this.length(),b>0&&(b=1/b,this.x*=b,this.y*=b,this.z*=b)),this},EZ3.Vector3.prototype.invert=function(a){return void 0!==a?(this.x=-a.x,this.y=-a.y,this.z=-a.z):(this.x=-this.x,this.y=-this.y,this.z=-this.z),this},EZ3.Vector3.prototype.copy=function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this},EZ3.Vector3.prototype.clone=function(){return new EZ3.Vector3(this.x,this.y,this.z)},EZ3.Vector3.prototype.toArray=function(){return[this.x,this.y,this.z]},EZ3.Vector3.prototype.testEqual=function(a){return a instanceof EZ3.Vector3?this.x===a.x&&this.y===a.y&&this.z===a.z:!1},EZ3.Vector3.prototype.hasZero=function(a){return void 0!==a?0===a.x||0===a.y||0===a.z:0===this.x||0===this.y||0===this.z},EZ3.Vector3.prototype.testZero=function(a){return void 0!==a?0===a.x&&0===a.y&&0===a.z:0===this.x&&0===this.y&&0===this.z},EZ3.Vector3.prototype.testDiff=function(a){return this.x!==a.x||this.y!==a.y||this.z!==a.z},EZ3.Vector3.prototype.toString=function(){var a=this.x.toFixed(4),b=this.y.toFixed(4),c=this.z.toFixed(4);return"Vector3["+a+", "+b+", "+c+"]"},EZ3.Vector3.prototype.setPositionFromMatrix=function(a){return a instanceof EZ3.Matrix4&&(this.x=a.elements[12],this.y=a.elements[13],this.z=a.elements[14]),this},EZ3.Vector3.prototype.set=EZ3.Vector3.prototype.init,Object.defineProperty(EZ3.Vector3.prototype,"x",{get:function(){return this._x},set:function(a){this._x=a,this.dirty=!0}}),Object.defineProperty(EZ3.Vector3.prototype,"y",{get:function(){return this._y},set:function(a){this._y=a,this.dirty=!0}}),Object.defineProperty(EZ3.Vector3.prototype,"z",{get:function(){return this._z},set:function(a){this._z=a,this.dirty=!0}}),EZ3.Vector4=function(a,b,c,d){this._x=a||0,this._y=b||0,this._z=c||0,this._w=d||0,this.dirty=!0},EZ3.Vector4.prototype.constructor=EZ3.Vector4,EZ3.Vector4.prototype.init=function(a,b,c,d){return this.x=a||0,this.y=b||0,this.z=c||0,this.w=d||0,this},EZ3.Vector4.prototype.set=function(a,b,c,d){this.x=a,this.y=b,this.z=c,this.w=d},EZ3.Vector4.prototype.add=function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this.w=a.w+b.w,this},EZ3.Vector4.prototype.addEqual=function(a){return this.x+=a.x,this.y+=a.y,this.z+=a.z,this.w+=a.w,this},EZ3.Vector4.prototype.sub=function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this.w=a.w-b.w,this},EZ3.Vector4.prototype.subEqual=function(a){return this.x-=a.x,this.y-=a.y,this.z-=a.z,this.w-=a.w,this},EZ3.Vector4.prototype.addScale=function(a,b){return this.x+=a.x*b,this.y+=a.y*b,this.z+=a.z*b,this.w+=a.w*b,this},EZ3.Vector4.prototype.scale=function(a,b){return this.x=a.x*b,this.y=a.y*b,this.z=a.z*b,this.w=a.w*b,this},EZ3.Vector4.prototype.scaleEqual=function(a){return this.x*=a,this.y*=a,this.z*=a,this.w*=a,this},EZ3.Vector4.prototype.div=function(a,b){return void 0!==b?b.hasZero()||(this.x=a.x/b.x,this.y=a.y/b.y,this.z=a.z/b.z,this.w=a.w/b.w):a.hasZero()||(this.x=this.x/a.x,this.y=this.y/a.y,this.z=this.z/a.z,this.w=this.w/a.w),this},EZ3.Vector4.prototype.divEqual=function(a){return a.hasZero()||(this.x/=a.x,this.y/=a.y,this.z/=a.z,this.w/=a.w),this},EZ3.Vector4.prototype.dot=function(a,b){return void 0!==b?a.x*b.x+a.y*b.y+a.z*b.z+a.w*b.w:this.x*a.x+this.y*a.y+this.z*a.z+this.w*a.w},EZ3.Vector4.prototype.max=function(a,b){return void 0!==b?(this.x=a.x>b.x?a.x:b.x,this.y=a.y>b.y?a.y:b.y,this.z=a.z>b.z?a.z:b.z,this.w=a.w>b.w?a.w:b.w):(this.x<a.x&&(this.x=a.x),this.y<a.y&&(this.y=a.y),this.z<a.z&&(this.z=a.z),this.w<a.w&&(this.w=a.w)),this},EZ3.Vector4.prototype.min=function(a,b){return void 0!==b?(this.x=a.x<b.x?a.x:b.x,this.y=a.y<b.y?a.y:b.y,this.z=a.z<b.z?a.z:b.z,this.w=a.w<b.w?a.w:b.w):(this.x>a.x&&(this.x=a.x),this.y>a.y&&(this.y=a.y),this.z>a.z&&(this.z=a.z),this.w>a.w&&(this.w=a.w)),this},EZ3.Vector4.prototype.len=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},EZ3.Vector4.prototype.mul=function(a,b,c){var d=c.elements;return this.x=a.x+b.x*d[0]+b.y*d[1]+b.z*d[2]+b.w*d[3],this.y=a.y+b.x*d[4]+b.y*d[5]+b.z*d[6]+b.w*d[7],this.z=a.z+b.x*d[8]+b.y*d[9]+b.z*d[10]+b.w*d[11],this.w=a.w+b.x*d[12]+b.y*d[13]+b.z*d[14]+b.w*d[15],this},EZ3.Vector4.prototype.mulMat=function(a,b){var c,d,e,f,g=a.elements;return void 0!==b?(c=b.x,d=b.y,e=b.z,f=b.w):(c=this.x,d=this.y,e=this.z,f=this.w),this.x=c*g[0]+d*g[4]+e*g[8]+f*g[12],this.y=c*g[1]+d*g[5]+e*g[9]+f*g[13],
this.z=c*g[2]+d*g[6]+e*g[10]+f*g[14],this.w=c*g[3]+d*g[7]+e*g[11]+f*g[15],this},EZ3.Vector4.prototype.length=function(a){return void 0!==a?Math.sqrt(a.dot(a)):Math.sqrt(this.dot(this))},EZ3.Vector4.prototype.normalize=function(a){var b;return void 0!==a?(b=a.length(),b>0&&(b=1/b,this.x=a.x*b,this.y=a.y*b,this.z=a.z*b,this.w=a.w*b)):(b=this.length(),b>0&&(b=1/b,this.x*=b,this.y*=b,this.z*=b,this.w*=b)),this},EZ3.Vector4.prototype.invert=function(a){return void 0!==a?(this.x=-a.x,this.y=-a.y,this.z=-a.z,this.w=-a.w):(this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w),this},EZ3.Vector4.prototype.copy=function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this.w=a.w,this},EZ3.Vector4.prototype.clone=function(){return new EZ3.Vector4(this.x,this.y,this.z,this.w)},EZ3.Vector4.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},EZ3.Vector4.prototype.testEqual=function(a){var b,c,d,e;return a instanceof EZ3.Vector4?(b=this.x===a.x,c=this.y===a.y,d=this.z===a.z,e=this.w===a.w,b&&c&&d&&e):!1},EZ3.Vector4.prototype.hasZero=function(a){var b,c,d,e;return void 0!==a?(b=0===a.x,c=0===a.y,d=0===a.z,e=0===a.w):(b=0===this.x,c=0===this.y,d=0===this.z,e=0===this.w),b||c||d||e},EZ3.Vector4.prototype.testZero=function(a){var b,c,d,e;return void 0!==a?(b=0===a.x,c=0===a.y,d=0===a.z,e=0===a.w):(b=0===this.x,c=0===this.y,d=0===this.z,e=0===this.w),b&&c&&d&&e},EZ3.Vector4.prototype.testDiff=function(a){var b=this.x!==a.x,c=this.y!==a.y,d=this.z!==a.z,e=this.w!==a.w;return b&&c&&d&&e},EZ3.Vector4.prototype.toString=function(){var a=this.x.toFixed(4),b=this.y.toFixed(4),c=this.z.toFixed(4),d=this.w.toFixed(4);return"Vector4["+a+", "+b+", "+c+", "+d+"]"},EZ3.Vector4.prototype.toVec2=function(){return new EZ3.Vector2(this.x,this.y)},EZ3.Vector4.prototype.toVec3=function(){return new EZ3.Vector3(this.x,this.y,this.z)},Object.defineProperty(EZ3.Vector4.prototype,"x",{get:function(){return this._x},set:function(a){this._x=a,this.dirty=!0}}),Object.defineProperty(EZ3.Vector4.prototype,"y",{get:function(){return this._y},set:function(a){this._y=a,this.dirty=!0}}),Object.defineProperty(EZ3.Vector4.prototype,"z",{get:function(){return this._z},set:function(a){this._z=a,this.dirty=!0}}),Object.defineProperty(EZ3.Vector4.prototype,"w",{get:function(){return this._w},set:function(a){this._w=a,this.dirty=!0}}),EZ3.Geometry=function(){this.buffers=new EZ3.ArrayBuffer},EZ3.Geometry.prototype.processLinearIndices=function(){var a,b,c=[];if(this.buffers.get("triangle")){for(a=this.buffers.get("triangle").data,b=0;b<a.length;b+=3)c.push(a[b]),c.push(a[b+1]),c.push(a[b]),c.push(a[b+2]),c.push(a[b+1]),c.push(a[b+2]);this.buffers.add("line",new EZ3.IndexBuffer(c,!1))}},EZ3.Geometry.prototype.processNormals=function(){var a,b,c,d,e,f=[],g=[],h=[],i=new EZ3.Vector3,j=new EZ3.Vector3,k=new EZ3.Vector3,l=new EZ3.Vector3,m=new EZ3.Vector3,n=new EZ3.Vector3,o=this.buffers.get("triangle").data,p=this.buffers.get("position").data;for(e=0;e<p.length/3;++e)g.push(0),g.push(0),g.push(0),h.push(0);for(e=0;e<o.length;e+=3)b=3*o[e+0],c=3*o[e+1],d=3*o[e+2],j.set(p[b+0],p[b+1],p[b+2]),k.set(p[c+0],p[c+1],p[c+2]),l.set(p[d+0],p[d+1],p[d+2]),m.sub(k,j),n.sub(l,j),i=n.cross(m),i.testZero()||i.normalize(),g[b+0]+=i.x,g[b+1]+=i.y,g[b+2]+=i.z,g[c+0]+=i.x,g[c+1]+=i.y,g[c+2]+=i.z,g[d+0]+=i.x,g[d+1]+=i.y,g[d+2]+=i.z,++h[b/3],++h[c/3],++h[d/3];for(e=0;e<p.length/3;++e)b=3*e+0,c=3*e+1,d=3*e+2,f.push(g[b]/h[e]),f.push(g[c]/h[e]),f.push(g[d]/h[e]);g=[],h=[],a=new EZ3.VertexBuffer(f,!1),a.addAttribute("normal",new EZ3.VertexBufferAttribute(3)),this.buffers.add("normal",a)},EZ3.Geometry.prototype.processTangentsAndBitangents=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m=[],n=[],o=[],p=[],q=new EZ3.Vector3,r=new EZ3.Vector3,s=new EZ3.Vector3,t=new EZ3.Vector3,u=new EZ3.Vector3,v=new EZ3.Vector3,w=new EZ3.Vector3,x=new EZ3.Vector3,y=new EZ3.Vector3,z=new EZ3.Vector2,A=new EZ3.Vector2,B=new EZ3.Vector2,C=new EZ3.Vector2,D=new EZ3.Vector2,E=this.uvs.data,F=this.indices.data,G=this.normals.data,H=this.vertices.data;for(l=0;l<H.length;++l)o.push(0),p.push(0);for(l=0;l<F.length;l+=3)e=3*F[l+0],f=3*F[l+1],g=3*F[l+2],h=2*F[l+0],i=2*F[l+1],j=2*F[l+2],z.set(E[h+0],E[h+1]),A.set(E[i+0],E[i+1]),B.set(E[j+0],E[j+1]),q.set(H[e+0],H[e+1],H[e+2]),r.set(H[f+0],H[f+1],H[f+2]),s.set(H[g+0],H[g+1],H[g+2]),v.sub(r,q),w.sub(s,q),C.sub(A,z),D.sub(B,z),k=1/(C.x*D.y-D.x*C.y),u.x=(D.y*v.x-C.y*w.x)*k,u.y=(D.y*v.y-C.y*w.y)*k,u.z=(D.y*v.z-C.y*w.z)*k,y.x=(C.x*w.x-D.x*v.x)*k,y.y=(C.x*w.y-D.x*v.y)*k,y.z=(C.x*w.z-D.x*v.z)*k,o[e+0]+=u.x,o[f+0]+=u.y,o[g+0]+=u.z,o[e+1]+=u.x,o[f+1]+=u.y,o[g+1]+=u.z,o[e+2]+=u.x,o[f+2]+=u.y,o[g+2]+=u.z,p[e+0]+=y.x,p[f+0]+=y.y,p[g+0]+=y.z,p[e+1]+=y.x,p[f+1]+=y.y,p[g+1]+=y.z,p[e+2]+=y.x,p[f+2]+=y.y,p[g+2]+=y.z;for(l=0;l<H.length/3;++l)b=3*l+0,c=3*l+1,d=3*l+2,u.set(o[b],o[c],o[d]),y.set(p[b],p[c],p[d]),t.set(G[b],G[c],G[d]),x.copy(t),x.scaleEqual(x.dot(u)),u.subEqual(x),u.normalize(),x.copy(t),a=y.dot(x.cross(u))<0?-1:1,n.push(y.x,y.y,y.z),m.push(u.x,u.y,u.z,a);o=[],p=[],this.tangents.data=m,this.bitangents.data=n},EZ3.ArrayBuffer=function(){this._id=null,this._index={},this._vertex={}},EZ3.ArrayBuffer.prototype.constructor=EZ3.ArrayBuffer,EZ3.ArrayBuffer.prototype.bind=function(a,b,c,d,e){var f,g;if(d.vertexArrayObject){this._id||(this._id=d.vertexArrayObject.createVertexArrayOES()),d.vertexArrayObject.bindVertexArrayOES(this._id);for(g in this._vertex)f=this._vertex[g],f.validate(a,b)&&f.dirty&&(f.bind(a,b),f.update(a),f.dirty=!1)}else for(g in this._vertex)f=this._vertex[g],f.validate(a,b)&&(f.bind(a,b,c),f.dirty&&(f.update(a),f.dirty=!1));e&&(e.bind(a),e.dirty&&(e.update(a,d),e.dirty=!1))},EZ3.ArrayBuffer.prototype.add=function(a,b){b instanceof EZ3.IndexBuffer?this._index[a]=b:b instanceof EZ3.VertexBuffer&&(this._vertex[a]=b)},EZ3.ArrayBuffer.prototype.get=function(a){return this._index[a]?this._index[a]:this._vertex[a]},EZ3.Buffer=function(a,b){this._id=null,this.ranges=[],this.data=a||[],this.dynamic=b||!1,this.usage=null,this.length=null,this.dirty=!0},EZ3.Buffer.prototype.constructor=EZ3.Buffer,EZ3.BufferRange=function(a,b){this.left=a,this.right=b},EZ3.Extension=function(a){this.elementIndexUInt=a.getExtension("OES_element_index_uint"),this.vertexArrayObject=a.getExtension("OES_vertex_array_object"),this.standardDerivates=a.getExtension("OES_standard_derivatives"),this.shaderLOD=a.getExtension("EXT_shader_texture_lod")},EZ3.GLSLProgram=function(a,b,c,d){this.used=1,this._cache={},this._shaders=[],this._uniform={},this._attribute={},this._program=null,this._create(a,b,c,d)},EZ3.GLSLProgram.prototype._compile=function(a,b,c){var d,e,f,g=a.createShader(b);a.shaderSource(g,c),a.compileShader(g),a.getShaderParameter(g,a.COMPILE_STATUS)?b===a.VERTEX_SHADER?this._shaders[EZ3.GLSLProgram.VERTEX]=g:b===a.FRAGMENT_SHADER&&(this._shaders[EZ3.GLSLProgram.FRAGMENT]=g):(d=a.getShaderInfoLog(g),f=this._addLineNumbers(c),e="EZ3.GLSLProgram shader info log: ",console.log(e+d+f+"\n"))},EZ3.GLSLProgram.prototype._create=function(a,b,c,d){var e,f;d=d?d:"",this._compile(a,a.VERTEX_SHADER,d+b),this._compile(a,a.FRAGMENT_SHADER,d+c),this._program=a.createProgram(),a.attachShader(this._program,this._shaders[EZ3.GLSLProgram.VERTEX]),a.attachShader(this._program,this._shaders[EZ3.GLSLProgram.FRAGMENT]),a.linkProgram(this._program),a.getProgramParameter(this._program,a.LINK_STATUS)?(this._loadUniforms(a),this._loadAttributes(a),a.deleteShader(this._shaders[EZ3.GLSLProgram.VERTEX]),a.deleteShader(this._shaders[EZ3.GLSLProgram.FRAGMENT])):(e=a.getProgramInfoLog(this._program,a.LINK_STATUS),f="EZ3.GLSLProgram linking program error info log: ",console.log(f+e+"\n"))},EZ3.GLSLProgram.prototype._loadUniforms=function(a){for(var b,c=a.getProgramParameter(this._program,a.ACTIVE_UNIFORMS),d=0;c>d;++d)b=a.getActiveUniform(this._program,d),this._addUniform(a,b.name)},EZ3.GLSLProgram.prototype._loadAttributes=function(a){for(var b,c=a.getProgramParameter(this._program,a.ACTIVE_ATTRIBUTES),d=0;c>d;++d)b=a.getActiveAttrib(this._program,d),this._addAttribute(a,b.name)},EZ3.GLSLProgram.prototype._addUniform=function(a,b){this.uniforms[b]=a.getUniformLocation(this._program,b)},EZ3.GLSLProgram.prototype._addAttribute=function(a,b){this.attributes[b]=a.getAttribLocation(this._program,b)},EZ3.GLSLProgram.prototype._addLineNumbers=function(a){for(var b=a.split("\n"),c=0;c<b.length;++c)b[c]=c+1+": "+b[c]+"\n\n";return b},EZ3.GLSLProgram.prototype._isCached=function(a,b){var c=this._cache[a];return c?c instanceof EZ3.Matrix3||c instanceof EZ3.Matrix4||c instanceof EZ3.Vector2||c instanceof EZ3.Vector3||c instanceof EZ3.Vector4?c.testEqual(b):c===b?!0:!1:!1},EZ3.GLSLProgram.prototype._caching=function(a,b){b instanceof EZ3.Matrix3||b instanceof EZ3.Matrix4||b instanceof EZ3.Vector2||b instanceof EZ3.Vector3||b instanceof EZ3.Vector4?this._cache[a]=b.clone():this._cache[a]=b},EZ3.GLSLProgram.prototype.bind=function(a){a.useProgram(this._program)},EZ3.GLSLProgram.prototype.loadUniformf=function(a,b,c,d){var e;if(!this._isCached(b,d))switch(this._caching(b,d),c>1&&(e=d.toArray()),c){case EZ3.GLSLProgram.UNIFORM_SIZE_1D:a.uniform1f(this.uniforms[b],d);break;case EZ3.GLSLProgram.UNIFORM_SIZE_2D:a.uniform2f(this.uniforms[b],e[0],e[1]);break;case EZ3.GLSLProgram.UNIFORM_SIZE_3D:a.uniform3f(this.uniforms[b],e[0],e[1],e[2]);break;case EZ3.GLSLProgram.UNIFORM_SIZE_4D:a.uniform4f(this.uniforms[b],e[0],e[1],e[2],e[3])}},EZ3.GLSLProgram.prototype.loadUniformi=function(a,b,c,d){var e;if(!this._isCached(b,d))switch(this._caching(b,d),c>1&&(e=d.toArray()),c){case EZ3.GLSLProgram.UNIFORM_SIZE_1D:a.uniform1i(this.uniforms[b],d);break;case EZ3.GLSLProgram.UNIFORM_SIZE_2D:a.uniform2i(this.uniforms[b],e[0],e[1]);break;case EZ3.GLSLProgram.UNIFORM_SIZE_3D:a.uniform3i(this.uniforms[b],e[0],e[1],e[2]);break;case EZ3.GLSLProgram.UNIFORM_SIZE_4D:a.uniform4i(this.uniforms[b],e[0],e[1],e[2],e[3])}},EZ3.GLSLProgram.prototype.loadUniformMatrix=function(a,b,c,d){var e;if(!this._isCached(b,d))switch(this._caching(b,d),e=d.toArray(),c){case EZ3.GLSLProgram.UNIFORM_SIZE_2X2:a.uniformMatrix2fv(this.uniforms[b],!1,e);break;case EZ3.GLSLProgram.UNIFORM_SIZE_3X3:a.uniformMatrix3fv(this.uniforms[b],!1,e);break;case EZ3.GLSLProgram.UNIFORM_SIZE_4X4:a.uniformMatrix4fv(this.uniforms[b],!1,e)}},Object.defineProperty(EZ3.GLSLProgram.prototype,"uniforms",{get:function(){return this._uniform}}),Object.defineProperty(EZ3.GLSLProgram.prototype,"attributes",{get:function(){return this._attribute}}),EZ3.GLSLProgram.UNIFORM_SIZE_1D=1,EZ3.GLSLProgram.UNIFORM_SIZE_2D=2,EZ3.GLSLProgram.UNIFORM_SIZE_3D=3,EZ3.GLSLProgram.UNIFORM_SIZE_4D=4,EZ3.GLSLProgram.UNIFORM_SIZE_2X2=2,EZ3.GLSLProgram.UNIFORM_SIZE_3X3=3,EZ3.GLSLProgram.UNIFORM_SIZE_4X4=4,EZ3.GLSLProgram.VERTEX=0,EZ3.GLSLProgram.FRAGMENT=1,EZ3.Renderer=function(a,b){this.context=null,this.extension=null,this.canvas=a,this.options=b,this.state=null},EZ3.Renderer.prototype._processContextLost=function(a){a.preventDefault()},EZ3.Renderer.prototype._renderMesh=function(a,b,c){var d,e=this.context,f=a.material.program,g=new EZ3.Matrix4;for(f.bind(e),a.material.updateStates(e,this.state),a.material.updateUniforms(e,this.state),g.mul(a.world,b.view),f.loadUniformf(e,"uEyePosition",3,b.position),f.loadUniformMatrix(e,"uModel",4,a.world),f.loadUniformMatrix(e,"uModelView",4,g),f.loadUniformMatrix(e,"uProjection",4,b.projection),c.empty||f.loadUniformMatrix(e,"uNormal",3,a.normal),d=0;d<c.point.length;d++)c.point[d].updateUniforms(e,f,d);for(d=0;d<c.directional.length;d++)c.directional[d].updateUniforms(e,f,d);for(d=0;d<c.spot.length;d++)c.spot[d].updateUniforms(e,f,d);a.render(e,f.attributes,this.state,this.extension)},EZ3.Renderer.prototype.initContext=function(){var a,b=this,c=["webgl","experimental-webgl","webkit-3d","moz-webgl"];for(a=0;a<c.length;a++){try{this.context=this.canvas.getContext(c[a],this.options)}catch(d){}if(this.context){this.state=new EZ3.State,this.extension=new EZ3.Extension(this.context);break}}if(!this.context)throw new Error("Unable to initialize WebGL with selected options.");this._onContextLost=function(a){b._processContextLost(a)},this.canvas.addEventListener("webglcontextlost",this._onContextLost,!1)},EZ3.Renderer.prototype.clear=function(){var a=this.context;a.clearColor(0,0,0,1),a.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT)},EZ3.Renderer.prototype.viewport=function(a,b){var c=this.context;c.viewport(a.x,a.y,b.x,b.y)},EZ3.Renderer.prototype.render=function(a,b){var c,d,e,f=this.context,g=[],h={common:[],opaque:[],transparent:[]},i={empty:!0,point:[],directional:[],spot:[]};for(g.push(a);g.length;){for(c=g.pop(),c instanceof EZ3.PointLight?i.point.push(c):c instanceof EZ3.DirectionalLight?i.directional.push(c):c instanceof EZ3.SpotLight?i.spot.push(c):c instanceof EZ3.Mesh&&h.common.push(c),e=c.children.length-1;e>=0;e--)g.push(c.children[e]);c.updateWorld()}for((i.point.length||i.directional.length||i.spot.length)&&(i.empty=!1),e=0;e<h.common.length;e++)d=h.common[e],d.updateEssentialBuffers(),i.empty||(d.updateIlluminationBuffers(),d.updateNormal()),d.material.updateProgram(f,i,this.state),d.material.transparent?h.transparent.push(d):h.opaque.push(d);for(e=0;e<h.opaque.length;e++)this._renderMesh(h.opaque[e],b,i);for(e=0;e<h.transparent.length;e++)this._renderMesh(h.transparent[e],b,i)},EZ3.ShaderLibrary=function(){this.mesh={}},EZ3.ShaderLibrary=new EZ3.ShaderLibrary,EZ3.ShaderLibrary.mesh.vertex="precision highp float;\r\n\r\nattribute vec3 position;\r\nattribute vec3 normal;\r\nattribute vec2 uv;\r\n\r\nuniform mat4 uModel;\r\nuniform mat3 uNormal;\r\nuniform mat4 uModelView;\r\nuniform mat4 uProjection;\r\n\r\nvarying vec3 vPosition;\r\nvarying vec3 vNormal;\r\nvarying vec2 vUv;\r\n\r\nvoid main() {\r\n  vPosition = vec3(uModel * vec4(position, 1.0));\r\n  vNormal = normalize(uNormal * normal);\r\n  vUv = uv;\r\n\r\n  gl_PointSize = 3.0;\r\n  gl_Position = uProjection * uModelView * vec4(position, 1.0);\r\n}\r\n",EZ3.ShaderLibrary.mesh.fragment="precision highp float;\r\n\r\n#extension GL_EXT_shader_texture_lod : enable\r\n#extension GL_OES_standard_derivatives : enable\r\n\r\nstruct PointLight\r\n{\r\n	vec3 position;\r\n	vec3 diffuse;\r\n	vec3 specular;\r\n};\r\n\r\nstruct DirectionalLight\r\n{\r\n	vec3 direction;\r\n	vec3 diffuse;\r\n	vec3 specular;\r\n};\r\n\r\nstruct SpotLight\r\n{\r\n	vec3 position;\r\n	vec3 direction;\r\n	float cutoff;\r\n	vec3 diffuse;\r\n	vec3 specular;\r\n};\r\n\r\nvarying vec3 vPosition;\r\nvarying vec3 vNormal;\r\nvarying vec2 vUv;\r\n\r\nuniform vec3 uEmissive;\r\nuniform vec3 uDiffuse;\r\nuniform vec3 uSpecular;\r\nuniform float uShininess;\r\nuniform vec3 uEyePosition;\r\n\r\n#if MAX_POINT_LIGHTS > 0\r\n  uniform PointLight uPointLights[MAX_POINT_LIGHTS];\r\n#endif\r\n\r\n#if MAX_DIRECTIONAL_LIGHTS > 0\r\n  uniform DirectionalLight uDirectionalLights[MAX_DIRECTIONAL_LIGHTS];\r\n#endif\r\n\r\n#if MAX_SPOT_LIGHTS > 0\r\n  uniform SpotLight uSpotLights[MAX_SPOT_LIGHTS];\r\n#endif\r\n\r\n#ifdef EMISSIVE_MAP\r\n	uniform sampler2D uEmissiveSampler;\r\n#endif\r\n\r\n#ifdef DIFFUSE_MAP\r\n	uniform sampler2D uDiffuseSampler;\r\n#endif\r\n\r\n#ifdef SPECULAR_MAP\r\n	uniform sampler2D uSpecularSampler;\r\n#endif\r\n\r\n#ifdef ENVIRONMENT_MAP\r\n	uniform samplerCube uEnvironmentSampler;\r\n#endif\r\n\r\n#ifdef LAMBERT\r\nfloat lambert(vec3 s, vec3 n)\r\n{\r\n	return max(dot(s, n), 0.0);\r\n}\r\n#endif\r\n\r\n#ifdef OREN_NAYAR\r\nfloat orenNayar(vec3 v, vec3 s, vec3 n)\r\n{\r\n	return 0.0;\r\n}\r\n#endif\r\n\r\n#ifdef PHONG\r\nfloat phong(vec3 v, vec3 s, vec3 n)\r\n{\r\n	vec3 r = reflect(-s, n);\r\n	return pow(max(dot(r, v), 0.0), uShininess);\r\n}\r\n#endif\r\n\r\n#ifdef BLINN_PHONG\r\nfloat blinnPhong(vec3 v, vec3 s, vec3 n)\r\n{\r\n	vec3 h = normalize(s + v);\r\n	return pow(max(dot(h, n), 0.0), uShininess);\r\n}\r\n#endif\r\n\r\n#ifdef COOK_TORRANCE\r\nfloat cookTorrance(vec3 v, vec3 s, vec3 n)\r\n{\r\n	return 0.0;\r\n}\r\n#endif\r\n\r\n#ifdef NORMAL_MAP\r\nuniform sampler2D uNormalSampler;\r\n\r\nvec3 pertubNormal(vec3 v) {\r\n	vec3 q0 = dFdx(v);\r\n	vec3 q1 = dFdy(v);\r\n\r\n	vec2 st0 = dFdx(vUv);\r\n	vec2 st1 = dFdy(vUv);\r\n\r\n	vec3 s = normalize(q0 * st1.t - q1 * st0.t);\r\n	vec3 t = normalize(-q0 * st1.s + q1 * st0.s);\r\n	vec3 n = normalize(vNormal);\r\n\r\n	vec3 d = texture2D(uNormalSampler, vUv).xyz * 2.0 - 1.0;\r\n\r\n	return normalize(mat3(s, t, n) * d);\r\n}\r\n#endif\r\n\r\nvoid main() {\r\n	vec3 emissive = uEmissive;\r\n	vec3 diffuse = vec3(0.0, 0.0, 0.0);\r\n	vec3 specular = vec3(0.0, 0.0, 0.0);\r\n\r\n	vec3 v = normalize(uEyePosition - vPosition);\r\n\r\n#ifdef NORMAL_MAP\r\n	vec3 n = pertubNormal(-v);\r\n#else\r\n	vec3 n = vNormal;\r\n#endif\r\n\r\n#if MAX_POINT_LIGHTS > 0\r\n  for(int i = 0; i < MAX_POINT_LIGHTS; i++)\r\n  {\r\n    vec3 s = normalize(uPointLights[i].position - vPosition);\r\n\r\n		#ifdef LAMBERT\r\n			float q = lambert(s, n);\r\n		#endif\r\n\r\n		#ifdef OREN_NAYAR\r\n			float q = orenNayar(v, s, n);\r\n		#endif\r\n\r\n		if (q > 0.0) {\r\n			#ifdef BLINN_PHONG\r\n				float w = blinnPhong(v, s, n);\r\n			#endif\r\n\r\n			#ifdef COOK_TORRANCE\r\n				float w = cookTorrance(v, s, n);\r\n			#endif\r\n\r\n			#ifdef PHONG\r\n				float w = phong(v, s, n);\r\n			#endif\r\n\r\n    	diffuse += uPointLights[i].diffuse * uDiffuse * q;\r\n			specular += uPointLights[i].specular * uSpecular * w;\r\n		}\r\n  }\r\n#endif\r\n\r\n#if MAX_DIRECTIONAL_LIGHTS > 0\r\n  for(int i = 0; i < MAX_DIRECTIONAL_LIGHTS; i++)\r\n  {\r\n		vec3 s = uDirectionalLights[i].direction;\r\n\r\n		#ifdef LAMBERT\r\n			float q = lambert(s, n);\r\n		#endif\r\n\r\n		#ifdef OREN_NAYAR\r\n			float q = orenNayar(v, s, n);\r\n		#endif\r\n\r\n		if (q > 0.0) {\r\n			#ifdef BLINN_PHONG\r\n				float w = blinnPhong(v, s, n);\r\n			#endif\r\n\r\n			#ifdef COOK_TORRANCE\r\n				float w = cookTorrance(v, s, n);\r\n			#endif\r\n\r\n			#ifdef PHONG\r\n				float w = phong(v, s, n);\r\n			#endif\r\n\r\n    	diffuse += uDirectionalLights[i].diffuse * uDiffuse * q;\r\n			specular += uDirectionalLights[i].specular * uSpecular * w;\r\n		}\r\n  }\r\n#endif\r\n\r\n#if MAX_SPOT_LIGHTS > 0\r\n  for(int i = 0; i < MAX_SPOT_LIGHTS; i++)\r\n  {\r\n		vec3 s = normalize(uSpotLights[i].position - vPosition);\r\n		float angle = max(dot(s, uSpotLights[i].direction), 0.0);\r\n\r\n		if(angle > uSpotLights[i].cutoff) {\r\n\r\n			s = uSpotLights[i].direction;\r\n\r\n			#ifdef LAMBERT\r\n				float q = lambert(s, n);\r\n			#endif\r\n\r\n			#ifdef OREN_NAYAR\r\n				float q = orenNayar(v, s, n);\r\n			#endif\r\n\r\n			if (q > 0.0) {\r\n				#ifdef BLINN_PHONG\r\n					float w = blinnPhong(v, s, n);\r\n				#endif\r\n\r\n				#ifdef COOK_TORRANCE\r\n					float w = cookTorrance(v, s, n);\r\n				#endif\r\n\r\n				#ifdef PHONG\r\n					float w = phong(v, s, n);\r\n				#endif\r\n\r\n				diffuse += uSpotLights[i].diffuse * uDiffuse * q;\r\n				specular += uSpotLights[i].specular * uSpecular * w;\r\n			}\r\n		}\r\n  }\r\n#endif\r\n\r\n#ifdef EMISSIVE_MAP\r\n  emissive *= vec3(texture2D(uEmissiveSampler, vUv));\r\n#endif\r\n\r\n#ifdef DIFFUSE_MAP\r\n	diffuse *= texture2DLodEXT(uDiffuseSampler, vUv, 0.0).rgb;\r\n#endif\r\n\r\n#ifdef SPECULAR_MAP\r\n	specular *= vec3(texture2D(uSpecularSampler, vUv));\r\n#endif\r\n\r\n#ifdef REFLECTION\r\n	vec3 reflection = reflect(-v, n);\r\n	diffuse *= textureCubeLodEXT(uEnvironmentSampler, reflection, 0.0).rgb;\r\n#endif\r\n\r\n#ifdef REFRACTION\r\n	vec3 refraction = refract(-v, n, uRefractFactor);\r\n	diffuse *= textureCubeLodEXT(uEnvironmentSampler, refraction, 0.0).rgb;\r\n#endif\r\n\r\n  gl_FragColor = vec4(emissive + diffuse + specular, 1.0);\r\n}\r\n",EZ3.State=function(){this.program={},this.texture={},this.attribute={},this.capability={},this.currentTextureSlot=null},EZ3.State.prototype.constructor=EZ3.State,EZ3.State.FACE_CULLING=0,EZ3.State.BACKFACE_CULLING=1,EZ3.State.FRONTFACE_CULLING=2,EZ3.State.BLENDING=3,EZ3.State.DEPTH_TEST=4,EZ3.VertexBufferAttribute=function(a,b,c){this.size=a,this.offset=4*b||0,this.normalized=c||!1},EZ3.AnimationFrame=function(a){var b=EZ3.Device;this._id=0,!b.requestAnimationFrame||a?(this._onRequestAnimationFrame=function(a){return window.setTimeout(a,1e3/60)},this._onCancelAnimationFrame=function(a){clearTimeout(a)}):(this._onRequestAnimationFrame=function(a){return window[b.requestAnimationFrame](a)},this._onCancelAnimationFrame=function(a){window[b.cancelAnimationFrame](a)})},EZ3.AnimationFrame.prototype.request=function(a){this._id=this._onRequestAnimationFrame(a)},EZ3.AnimationFrame.prototype.cancel=function(){this._onCancelAnimationFrame(this._id)},EZ3.Device=function(){this.ready=!1,this.onResize=new EZ3.Signal,this.operatingSystem=0,this.requestAnimationFrame=null,this.cancelAnimationFrame=null,this.touchDown=null,this.touchMove=null,this.touchUp=null,this.scroll=null,this.requestFullScreen=null,this.cancelFullScreen=null,this.fullScreenChange=null,this.fullScreenError=null,this.requestPointerLock=null,this.cancelPointerLock=null,this.pointerLockChange=null,this.pointerLockError=null},EZ3.Device=new EZ3.Device,EZ3.Device._check=function(){function a(){/Playstation Vita/.test(navigator.userAgent)?f.operatingSystem=EZ3.Device.OPERATING_SYSTEM.PSVITA:/Kindle/.test(navigator.userAgent)||/\bKF[A-Z][A-Z]+/.test(navigator.userAgent)||/Silk.*Mobile Safari/.test(navigator.userAgent)?f.operatingSystem=EZ3.Device.OPERATING_SYSTEM.KINDLE:/Android/.test(navigator.userAgent)?f.operatingSystem=EZ3.Device.OPERATING_SYSTEM.ANDROID:/CrOS/.test(navigator.userAgent)?f.operatingSystem=EZ3.Device.OPERATING_SYSTEM.CRHOMEOS:/iP[ao]d|iPhone/i.test(navigator.userAgent)?f.operatingSystem=EZ3.Device.OPERATING_SYSTEM.IOS:/Linux/.test(navigator.userAgent)?f.operatingSystem=EZ3.Device.OPERATING_SYSTEM.LINUX:/Mac OS/.test(navigator.userAgent)?f.operatingSystem=EZ3.Device.OPERATING_SYSTEM.MACOS:/Windows/.test(navigator.userAgent)&&(f.operatingSystem=EZ3.Device.OPERATING_SYSTEM.WINDOWS),(/Windows Phone/i.test(navigator.userAgent)||/IEMobile/i.test(navigator.userAgent))&&(f.operatingSystem=EZ3.Device.OPERATING_SYSTEM.WINDOWS_PHONE)}function b(){window.requestAnimationFrame?(f.requestAnimationFrame="requestAnimationFrame",f.cancelAnimationFrame="cancelAnimationFrame"):window.webkitRequestAnimationFrame?(f.requestAnimationFrame="webkitRequestAnimationFrame",f.cancelAnimationFrame="webkitCancelAnimationFrame"):window.mozRequestAnimationFrame?(f.requestAnimationFrame="mozRequestAnimationFrame",f.cancelAnimationFrame="mozCancelAnimationFrame"):window.msRequestAnimationFrame?(f.requestAnimationFrame="msRequestAnimationFrame",f.cancelAnimationFrame="msCancelAnimationFrame"):window.oRequestAnimationFrake&&(f.requestAnimationFrame="oRequestAnimationFrame",f.cancelAnimationFrame="oCancelAnimationFrame")}function c(){"ontouchstart"in document.documentElement||window.navigator.maxTouchPoints?(f.touchDown="touchstart",f.touchMove="touchmove",f.touchUp="touchend"):window.navigator.pointerEnabled?(f.touchDown="pointerdown",f.touchMove="pointermove",f.touchUp="pointerup"):window.navigator.msPointerEnabled&&(f.touchDown="MSPointerDown",f.touchMove="MSPointerMove",f.touchUp="MSPointerUp"),"onwheel"in window||"WheelEvent"in window?f.wheel="wheel":"onmousewheel"in window?f.wheel="mousewheel":"MouseScrollEvent"in window&&(f.wheel="DOMMouseScroll")}function d(){document.fullscreenEnabled?(f.requestFullScreen="requestFullscreen",f.cancelFullScreen="exitFullscreen",f.fullScreenChange="fullscreenchange",f.fullScreenError="fullscreenerror"):document.webkitFullscreenEnabled?(f.requestFullScreen="webkitRequestFullscreen",f.cancelFullScreen="webkitExitFullscreen",f.fullScreenChange="webkitfullscreenchange",f.fullScreenError="webkitfullscreenerror"):document.mozFullScreenEnabled?(f.requestFullScreen="mozRequestFullscreen",f.cancelFullScreen="mozCancelFullScreen",f.fullScreenChange="mozfullscreenchange",f.fullScreenError="mozfullscreenerror"):document.msFullscreenEnabled&&(f.requestFullScreen="msRequestFullscreen",f.cancelFullScreen="msExitFullscreen",f.fullScreenChange="MSFullscreenChange",f.fullScreenError="MSFullscreenError")}function e(){"pointerLockElement"in document?(f.requestPointerLock="requestPointerLock",f.cancelPointerLock="exitPointerLock",f.pointerLockChange="pointerlockchange",f.pointerLockCancel="pointerlockerror"):"webkitPointerLockElement"in document?(f.requestPointerLock="webkitRequestPointerLock",f.cancelPointerLock="webkitExitPointerLock",f.pointerLockChange="webkitpointerlockchange",f.pointerLockCancel="webkitpointerlockerror"):"mozPointerLockElement"in document&&(f.requestPointerLock="mozRequestPointerLock",f.cancelPointerLock="mozExitPointerLock",f.pointerLockChange="mozpointerlockchange",f.pointerLockCancel="mozpointerlockerror")}var f=this;a(),b(),d(),e(),c()},EZ3.Device._isReady=function(){var a;document.body?this.ready||(a=this,document.removeEventListener("deviceready",this._onReady),document.removeEventListener("DOMContentLoaded",this._onReady),window.removeEventListener("load",this._onReady),delete this._onReady,this._check(),delete this._check,this._onResize=function(){a.onResize.dispatch()},window.addEventListener("resize",this._onResize,!0),this.ready=!0,this._isReady.signal.dispatch(),this._isReady.signal.dispose(),delete this._isReady):window.setTimeout(this._isReady,20)},EZ3.Device.onReady=function(a,b,c){var d,e;this.ready?a.apply(b,c):this._isReady.signal?(e=this._isReady.signal.add(a,b),e.params=c):(d=this,this._isReady.signal=new EZ3.Signal,e=this._isReady.signal.add(a,b),e.params=c,this._onReady=function(){d._isReady()},"complete"===document.readyState||"interactive"===document.readyState?this._isReady():"undefined"==typeof window.cordova||navigator.isCocoonJS?(document.addEventListener("DOMContentLoaded",this._onReady,!1),window.addEventListener("load",this._onReady,!1)):document.addEventListener("deviceready",this._onReady,!1))},EZ3.Device.OPERATING_SYSTEM={},EZ3.Device.OPERATING_SYSTEM.WINDOWS=1,EZ3.Device.OPERATING_SYSTEM.MACOS=2,EZ3.Device.OPERATING_SYSTEM.LINUX=4,EZ3.Device.OPERATING_SYSTEM.IOS=8,EZ3.Device.OPERATING_SYSTEM.ANDROID=16,EZ3.Device.OPERATING_SYSTEM.WINDOWS_PHONE=32,EZ3.Device.OPERATING_SYSTEM.CRHOMEOS=64,EZ3.Device.OPERATING_SYSTEM.KINDLE=128,EZ3.Device.OPERATING_SYSTEM.PSVITA=256,EZ3.Time=function(){this.now=0,this.previous=0,this.elapsed=0,this.started=0},EZ3.Time.prototype.start=function(){this.started=this.now=Date.now()},EZ3.Time.prototype.update=function(){this.previous=this.now,this.now=Date.now(),this.elapsed=.001*(this.now-this.previous)},EZ3.Texture=function(){this._id=null,this.dirty=!0},EZ3.FreeCamera=function(a,b,c,d,e){EZ3.Camera.call(this,a,b,c,d,e)},EZ3.FreeCamera.prototype=Object.create(EZ3.Camera.prototype),EZ3.FreeCamera.prototype.constructor=EZ3.FreeCamera,EZ3.FreeCamera.prototype._update=function(){var a=EZ3.Math.toRadians(this._rotationAngles.x),b=EZ3.Math.toRadians(this._rotationAngles.y),c=(new EZ3.Matrix4).yawPitchRoll(a,b,0);this.up=new EZ3.Vector4(0,1,0,0).mulMat(c).toVec3(),this.look=new EZ3.Vector4(0,0,1,0).mulMat(c).toVec3(),this.right=new EZ3.Vector4(1,0,0,0).mulMat(c).toVec3(),this.target=(new EZ3.Vector3).add(this.position,this.look)},EZ3.FreeCamera.prototype.lift=function(a){var b=(new EZ3.Vector3).copy(this.up).scaleEqual(a);this.position.addEqual(b)},EZ3.FreeCamera.prototype.walk=function(a){var b=(new EZ3.Vector3).copy(this.look).scaleEqual(a);this.position.addEqual(b)},EZ3.FreeCamera.prototype.strafe=function(a){var b=(new EZ3.Vector3).copy(this.right).scaleEqual(a);this.position.addEqual(b)},EZ3.TargetCamera=function(a,b,c,d,e){EZ3.Camera.call(this,a,b,c,d,e),this.distance=1},EZ3.TargetCamera.prototype=Object.create(EZ3.Camera.prototype),EZ3.TargetCamera.prototype.constructor=EZ3.TargetCamera,EZ3.TargetCamera.prototype._update=function(){var a=EZ3.Math.toRadians(this._rotationAngles.x),b=EZ3.Math.toRadians(this._rotationAngles.y),c=(new EZ3.Matrix4).yawPitchRoll(a,b,0),d=new EZ3.Vector4(0,0,-1,0).mulMat(c).toVec3();this.distance=(new EZ3.Vector3).sub(this.position,this.target).length(),this.distance=Math.max(1,this.distance),d.scaleEqual(this.distance),this.position=(new EZ3.Vector3).add(this.target,d),this.look=(new EZ3.Vector3).sub(this.target,this.position),this.up=new EZ3.Vector4(0,1,0,0).mulMat(c).toVec3(),this.right=(new EZ3.Vector3).cross(this.look.normalize(),this.up)},EZ3.TargetCamera.prototype.pan=function(a,b){var c,d,e,f,g;c=a*EZ3.Camera.MOVE_SPEED,d=-b*EZ3.Camera.MOVE_SPEED,f=(new EZ3.Vector3).copy(this.right).scaleEqual(c),e=(new EZ3.Vector3).copy(this.up).scaleEqual(d),g=(new EZ3.Vector3).add(f,e),this.position.addEqual(g),this.target.addEqual(g)},EZ3.TargetCamera.prototype.zoom=function(a){var b=(new EZ3.Vector3).copy(this.look).scaleEqual(a);this.position.addEqual(b)},EZ3.Mesh=function(a,b){EZ3.Entity.call(this),this.updateNormalMatrix=!1,this.normal=new EZ3.Matrix3,this.geometry=a,this.material=b},EZ3.Mesh.prototype=Object.create(EZ3.Entity.prototype),EZ3.Mesh.prototype.constructor=EZ3.Mesh,EZ3.Mesh.prototype.updateEssentialBuffers=function(){this.geometry.dirty&&(this.geometry.generate(),this.geometry.dirty=!1),this.material.fill!==EZ3.Material.WIREFRAME||this.geometry.buffers.get("line")||this.geometry.processLinearIndices()},EZ3.Mesh.prototype.updateIlluminationBuffers=function(){this.geometry.buffers.get("normal")||this.geometry.processNormals(),this.material.bumpMap instanceof EZ3.Texture&&!this.geometry.buffers.get("tangent")&&this.geometry.processTangentsAndBitangents()},EZ3.Mesh.prototype.updateNormal=function(){this.updateNormalMatrix&&(this.normal.normalFromMat4(this.world),this.updateNormalMatrix=!1)},EZ3.Mesh.prototype.render=function(a,b,c,d){var e,f;this.material.fill===EZ3.Material.WIREFRAME?(f=this.geometry.buffers.get("line"),e=a.LINES):this.material.fill===EZ3.Material.POINTS?(f=this.geometry.buffers.get("position"),e=a.POINTS):(f=this.geometry.buffers.get("triangle"),e=a.TRIANGLES),f instanceof EZ3.IndexBuffer?(this.geometry.buffers.bind(a,b,c,d,f),a.drawElements(e,f.data.length,f.getType(a,d),0)):f instanceof EZ3.VertexBuffer&&(this.geometry.buffers.bind(a,b,c,d),a.drawArrays(e,0,f.data.length/3))},EZ3.MousePointer=function(a){EZ3.Pointer.call(this,a),this._buttons=[],this.wheel=new EZ3.Vector2,this.movement=new EZ3.Vector2,this.locked=!1},EZ3.MousePointer.prototype=Object.create(EZ3.Pointer.prototype),EZ3.MousePointer.prototype.constructor=EZ3.MousePointer,EZ3.MousePointer.prototype.processPress=function(a,b,c){this._buttons[a.button]||(this._buttons[a.button]=new EZ3.Switch(a.button)),this._buttons[a.button].processPress(),EZ3.Pointer.prototype.processPress.call(this,a),b.dispatch(this._buttons[a.button]),c.dispatch(this)},EZ3.MousePointer.prototype.processMove=function(a,b){this.locked?(this.movement.x=a.movementX||a.mozMovementX||0,this.movement.y=a.movementY||a.mozMovementY||0):EZ3.Pointer.prototype.processMove.call(this,a),b.dispatch(this)},EZ3.MousePointer.prototype.processUp=function(a,b){this._buttons[a.button]||(this._buttons[a.button]=new EZ3.Switch(a.button)),this._buttons[a.button].processUp(),b.dispatch(this._buttons[a.button])},EZ3.MousePointer.prototype.processWheel=function(a,b){this.wheel.x=a.wheelDeltaX||a.deltaX,this.wheel.y=a.wheelDeltaY||a.deltaY,b.dispatch(this.wheel)},EZ3.MousePointer.prototype.processLockChange=function(a){this.locked=!this.locked,a.dispatch(this.locked)},EZ3.MousePointer.prototype.getButton=function(a){return this._buttons[a]||(this._buttons[a]=new EZ3.Switch(a)),this._buttons[a]},EZ3.TouchPointer=function(a,b,c){EZ3.Pointer.call(this,a),EZ3.Switch.call(this,b),this.id=c||0},EZ3.TouchPointer.prototype=Object.create(EZ3.Pointer.prototype),EZ3["extends"](EZ3.TouchPointer.prototype,EZ3.Switch.prototype),EZ3.TouchPointer.prototype.constructor=EZ3.TouchPointer,EZ3.TouchPointer.prototype.processPress=function(a,b,c){EZ3.Pointer.prototype.processPress.call(this,a),EZ3.Switch.prototype.processPress.call(this),b.dispatch(this),c.dispatch(this)},EZ3.TouchPointer.prototype.processMove=function(a,b){EZ3.Pointer.prototype.processMove.call(this,a),b.dispatch(this)},EZ3.TouchPointer.prototype.processUp=function(a){
EZ3.Switch.prototype.processUp.call(this),a.dispatch(this)},EZ3.DirectionalLight=function(){EZ3.Light.call(this),this.target=new EZ3.Vector3},EZ3.DirectionalLight.prototype=Object.create(EZ3.Light.prototype),EZ3.DirectionalLight.prototype.constructor=EZ3.DirectionalLight,EZ3.DirectionalLight.prototype.updateUniforms=function(a,b,c){var d="uDirectionalLights["+c+"].",e=(new EZ3.Vector3).sub(this.position,this.target).normalize();EZ3.Light.prototype.updateUniforms.call(this,a,b,d),b.loadUniformf(a,d+"direction",3,e)},EZ3.PointLight=function(){EZ3.Light.call(this)},EZ3.PointLight.prototype=Object.create(EZ3.Light.prototype),EZ3.PointLight.prototype.constructor=EZ3.PointLight,EZ3.PointLight.prototype.updateUniforms=function(a,b,c){var d="uPointLights["+c+"].";EZ3.Light.prototype.updateUniforms.call(this,a,b,d),b.loadUniformf(a,d+"position",3,this.position)},EZ3.SpotLight=function(){EZ3.Light.call(this),this.target=new EZ3.Vector3,this.cutoff=.8},EZ3.SpotLight.prototype=Object.create(EZ3.Light.prototype),EZ3.SpotLight.prototype.constructor=EZ3.SpotLight,EZ3.SpotLight.prototype.updateUniforms=function(a,b,c){var d="uSpotLights["+c+"].",e=(new EZ3.Vector3).sub(this.position,this.target).normalize();EZ3.Light.prototype.updateUniforms.call(this,a,b,d),b.loadUniformf(a,d+"position",3,this.position),b.loadUniformf(a,d+"direction",3,e),b.loadUniformf(a,d+"cutoff",1,this.cutoff)},EZ3.MeshMaterial=function(){EZ3.Material.call(this,"mesh"),this.emissive=new EZ3.Vector3,this.emissiveMap=null,this.diffuse=new EZ3.Vector3(.8,.8,.8),this.diffuseMap=null,this.specular=new EZ3.Vector3(.2,.2,.2),this.specularMap=null,this.environmentMap=null,this.reflective=!1,this.refractive=!1,this.diffuseReflection=EZ3.MeshMaterial.LAMBERT,this.specularReflection=EZ3.MeshMaterial.BLINN_PHONG,this.normalMap=null,this.shininess=180,this.dirty=!0},EZ3.MeshMaterial.prototype=Object.create(EZ3.Material.prototype),EZ3.MeshMaterial.prototype.constructor=EZ3.Material,EZ3.MeshMaterial.prototype.updateProgram=function(a,b,c){var d,e,f=this._name,g=[],h="#define ";g.push("MAX_POINT_LIGHTS "+b.point.length),g.push("MAX_DIRECTIONAL_LIGHTS "+b.directional.length),g.push("MAX_SPOT_LIGHTS "+b.spot.length),this.emissiveMap instanceof EZ3.Texture2D&&g.push("EMISSIVE_MAP"),this.diffuseMap instanceof EZ3.Texture2D&&g.push("DIFFUSE_MAP"),this.normalMap instanceof EZ3.Texture2D&&g.push("NORMAL_MAP"),this.environmentMap instanceof EZ3.Cubemap&&(g.push("ENVIRONMENT_MAP"),this.reflective&&g.push("REFLECTION"),this.refractive&&g.push("REFRACTION")),this.diffuseReflection===EZ3.MeshMaterial.OREN_NAYAR?g.push("OREN_NAYAR"):g.push("LAMBERT"),this.specularReflection===EZ3.MeshMaterial.COOK_TORRANCE?g.push("COOK_TORRANCE"):this.specularReflection===EZ3.MeshMaterial.PHONG?g.push("PHONG"):g.push("BLINN_PHONG"),f+=g.join("."),h+=g.join("\n "+h)+"\n",c.program[f]?this.program=c.program[f]:(d=EZ3.ShaderLibrary.mesh.vertex,e=EZ3.ShaderLibrary.mesh.fragment,this.program=new EZ3.GLSLProgram(a,d,e,h),c.program[f]=this.program)},EZ3.MeshMaterial.prototype.updateUniforms=function(a,b){this.program.loadUniformf(a,"uEmissive",3,this.emissive),this.program.loadUniformf(a,"uDiffuse",3,this.diffuse),this.program.loadUniformf(a,"uSpecular",3,this.specular),this.program.loadUniformf(a,"uShininess",1,this.shininess),this.emissiveMap instanceof EZ3.Texture2D&&(this.emissiveMap.bind(a,b,0),this.emissiveMap.dirty&&(this.emissiveMap.update(a,a.RGBA,a.RGBA),this.emissiveMap.dirty=!1),this.program.loadUniformi(a,"uEmissiveSampler",EZ3.GLSLProgram.UNIFORM_SIZE_1D,0)),this.diffuseMap instanceof EZ3.Texture2D&&(this.diffuseMap.bind(a,b,1),this.diffuseMap.dirty&&(this.diffuseMap.update(a,a.RGBA,a.RGBA),this.diffuseMap.dirty=!1),this.program.loadUniformi(a,"uDiffuseSampler",EZ3.GLSLProgram.UNIFORM_SIZE_1D,1)),this.normalMap instanceof EZ3.Texture2D&&(this.normalMap.bind(a,b,2),this.normalMap.dirty&&(this.normalMap.update(a,a.RGBA,a.RGBA),this.normalMap.dirty=!1),this.program.loadUniformi(a,"uNormalSampler",EZ3.GLSLProgram.UNIFORM_SIZE_1D,2)),this.environmentMap instanceof EZ3.Cubemap&&(this.environmentMap.bind(a,b,3),this.environmentMap.dirty&&(this.environmentMap.update(a,a.RGBA,a.RGBA),this.environmentMap.dirty=!1),this.program.loadUniformi(a,"uEnvironmentSampler",EZ3.GLSLProgram.UNIFORM_SIZE_1D,3))},EZ3.MeshMaterial.LAMBERT=0,EZ3.MeshMaterial.OREN_NAYAR=1,EZ3.MeshMaterial.PHONG=2,EZ3.MeshMaterial.BLINN_PHONG=3,EZ3.MeshMaterial.COOK_TORRANCE=4,EZ3.ShaderMaterial=function(a,b,c){this.name=a,this.vertex=b,this.fragment=c},EZ3.ShaderMaterial.prototype=Object.create(EZ3.Material.prototype),EZ3.ShaderMaterial.prototype.constructor=EZ3.Material,EZ3.AstroidalEllipsoid=function(a,b){EZ3.Geometry.call(this),a instanceof EZ3.Vector3?this.radiuses=a:this.radiuses=new EZ3.Vector3(1,1,1),b instanceof EZ3.Vector2?this.resolution=b:this.resolution=new EZ3.Vector2(5,5),this.dirty=!0},EZ3.AstroidalEllipsoid.prototype=Object.create(EZ3.Geometry.prototype),EZ3.AstroidalEllipsoid.prototype.constructor=EZ3.AstroidalEllipsoid,EZ3.AstroidalEllipsoid.prototype.generate=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q=[],r=[],s=[],t=new EZ3.Vector3,u=!1;for(o=0;o<this.resolution.x;++o)for(p=0;p<this.resolution.y;++p)m=o/(this.resolution.x-1),n=p/(this.resolution.y-1),c=EZ3.Math.DOUBLE_PI*m-EZ3.Math.PI,d=EZ3.Math.PI*n-EZ3.Math.HALF_PI,e=Math.pow(Math.cos(c),3),f=Math.pow(Math.cos(d),3),g=Math.pow(Math.sin(c),3),h=Math.pow(Math.sin(d),3),t.x=this.radiuses.x*f*e,t.y=this.radiuses.y*h,t.z=this.radiuses.z*f*g,q.push(m),q.push(n),s.push(t.x),s.push(t.y),s.push(t.z);for(o=0;o<this.resolution.x-1;++o)for(p=0;p<this.resolution.y-1;++p)i=o*this.resolution.y+p,j=o*this.resolution.y+(p+1),k=(o+1)*this.resolution.y+p,l=(o+1)*this.resolution.y+(p+1),u||(b=r.length,u=u||i>EZ3.Math.MAX_USHORT||j>EZ3.Math.MAX_USHORT||k>EZ3.Math.MAX_USHORT||l>EZ3.Math.MAX_USHORT),r.push(i,j,l,i,l,k);a=new EZ3.IndexBuffer(r,!1,u),this.buffers.add("triangle",a),a=new EZ3.VertexBuffer(q,!1),a.addAttribute("uv",new EZ3.VertexBufferAttribute(2)),this.buffers.add("uv",a),a=new EZ3.VertexBuffer(s,!1),a.addAttribute("position",new EZ3.VertexBufferAttribute(3)),this.buffers.add("position",a)},EZ3.Box=function(a,b){EZ3.Geometry.call(this),a instanceof EZ3.Vector3?this.dimensions=a:this.dimensions=new EZ3.Vector3(1,1,1),b instanceof EZ3.Vector3?this.resolution=b:this.resolution=new EZ3.Vector3(1,1,1),this.dirty=!0},EZ3.Box.prototype=Object.create(EZ3.Geometry.prototype),EZ3.Box.prototype.constructor=EZ3.Box,EZ3.Box.prototype.generate=function(){function a(a,e,j,k,l,m,n){var o,q,r,s,t,u,v,w,x,y=b,z=c,A=.5*l,B=.5*m,C=i.length/3,D=new EZ3.Vector3;for("x"===a&&"y"===e||"y"===a&&"x"===e?v="z":"x"===a&&"z"===e||"z"===a&&"x"===e?(v="y",z=d):("z"===a&&"y"===e||"y"===a&&"z"===e)&&(v="x",y=d),o=l/y,q=m/z,w=0;z+1>w;w++)for(x=0;y+1>x;x++)D[a]=(x*o-A)*j,D[e]=(w*q-B)*k,D[v]=n,g.push(x/y,w/z),i.push(D.x,D.y,D.z);for(w=0;z>w;++w)for(x=0;y>x;++x)r=C+(w*(y+1)+x),s=C+(w*(y+1)+(x+1)),t=C+((w+1)*(y+1)+x),u=C+((w+1)*(y+1)+(x+1)),h.push(r,u,s,r,t,u),p||(f=h.length,p=p||r>EZ3.Math.MAX_USHORT||s>EZ3.Math.MAX_USHORT||t>EZ3.Math.MAX_USHORT||u>EZ3.Math.MAX_USHORT)}var b,c,d,e,f,g=[],h=[],i=[],j=this.dimensions.x,k=this.dimensions.y,l=this.dimensions.z,m=.5*j,n=.5*l,o=.5*k,p=!1;void 0!==this.resolution?(b=this.resolution.x,c=this.resolution.y,d=this.resolution.z):(b=1,c=1,d=1),a("z","y",-1,-1,l,k,+m),a("z","y",1,-1,l,k,-m),a("x","z",1,1,j,l,+o),a("x","z",1,-1,j,l,-o),a("x","y",1,-1,j,k,+n),a("x","y",-1,-1,j,k,-n),e=new EZ3.IndexBuffer(h,!1,p),this.buffers.add("triangle",e),e=new EZ3.VertexBuffer(g,!1),e.addAttribute("uv",new EZ3.VertexBufferAttribute(2)),this.buffers.add("uv",e),e=new EZ3.VertexBuffer(i,!1),e.addAttribute("position",new EZ3.VertexBufferAttribute(3)),this.buffers.add("position",e)},EZ3.Cone=function(a,b,c){EZ3.Geometry.call(this),this.base=a,this.height=b,c instanceof EZ3.Vector2?this.resolution=c:this.resolution=new EZ3.Vector2(5,5),this.dirty=!0},EZ3.Cone.prototype=Object.create(EZ3.Geometry.prototype),EZ3.Cone.prototype.constructor=EZ3.Cone,EZ3.Cone.prototype.generate=function(){var a,b,c,d,e,f,g,h,i,j,k,l=[],m=[],n=[],o=new EZ3.Vector3,p=this.height,q=(this.height-this.base)/this.resolution.x,r=!1;for(j=0;j<this.resolution.x;++j){for(k=0;k<this.resolution.y;++k)h=j/(this.resolution.x-1),i=k/(this.resolution.y-1),a=.5*Math.abs(this.height-p),o.x=a*Math.cos(EZ3.Math.DOUBLE_PI*i),o.y=p,o.z=a*Math.sin(EZ3.Math.DOUBLE_PI*i),n.push(o.x),n.push(o.y),n.push(o.z),l.push(h),l.push(i);if(p-=q,p<this.base)break}for(j=0;j<this.resolution.x-1;++j)for(k=0;k<this.resolution.y-1;++k)d=j*this.resolution.y+k,e=j*this.resolution.y+(k+1),f=(j+1)*this.resolution.y+k,g=(j+1)*this.resolution.y+(k+1),r||(c=m.length,r=r||d>EZ3.Math.MAX_USHORT||e>EZ3.Math.MAX_USHORT||f>EZ3.Math.MAX_USHORT||g>EZ3.Math.MAX_USHORT),m.push(d,e,g,d,g,f);b=new EZ3.IndexBuffer(m,!1,r),this.buffers.add("triangle",b),b=new EZ3.VertexBuffer(l,!1),b.addAttribute("uv",new EZ3.VertexBufferAttribute(2)),this.buffers.add("uv",b),b=new EZ3.VertexBuffer(n,!1),b.addAttribute("position",new EZ3.VertexBufferAttribute(3)),this.buffers.add("position",b)},EZ3.Cylinder=function(a,b,c,d){EZ3.Geometry.call(this),this.base=b,this.radius=a,this.height=c,d instanceof EZ3.Vector2?this.resolution=d:this.resolution=new EZ3.Vector2(5,5),this.dirty=!0},EZ3.Cylinder.prototype=Object.create(EZ3.Geometry.prototype),EZ3.Cylinder.prototype.constructor=EZ3.Cylinder,EZ3.Cylinder.prototype.generate=function(){var a,b,c,d,e,f,g,h,i,j,k=[],l=[],m=[],n=new EZ3.Vector3,o=this.height,p=(this.height-this.base)/this.resolution.x,q=!1;for(i=0;i<this.resolution.x;++i){for(j=0;j<this.resolution.y;++j)g=i/(this.resolution.x-1),h=j/(this.resolution.y-1),n.x=this.radius*Math.cos(EZ3.Math.DOUBLE_PI*h),n.y=o,n.z=this.radius*Math.sin(EZ3.Math.DOUBLE_PI*h),m.push(n.x),m.push(n.y),m.push(n.z),k.push(g),k.push(h);if(o-=p,o<this.base)break}for(i=0;i<this.resolution.x-1;++i)for(j=0;j<this.resolution.y-1;++j)c=i*this.resolution.y+j,d=i*this.resolution.y+(j+1),e=(i+1)*this.resolution.y+j,f=(i+1)*this.resolution.y+(j+1),q||(b=l.length,q=q||c>EZ3.Math.MAX_USHORT||d>EZ3.Math.MAX_USHORT||e>EZ3.Math.MAX_USHORT||f>EZ3.Math.MAX_USHORT),l.push(c,d,f,c,f,e);a=new EZ3.IndexBuffer(l,!1,q),this.buffers.add("triangle",a),a=new EZ3.VertexBuffer(k,!1),a.addAttribute("uv",new EZ3.VertexBufferAttribute(2)),this.buffers.add("uv",a),a=new EZ3.VertexBuffer(m,!1),a.addAttribute("position",new EZ3.VertexBufferAttribute(3)),this.buffers.add("position",a)},EZ3.Ellipsoid=function(a,b){EZ3.Geometry.call(this),a instanceof EZ3.Vector3?this.radiuses=a:this.radiuses=new EZ3.Vector3(3,1,3),b instanceof EZ3.Vector2?this.resolution=b:this.resolution=new EZ3.Vector2(5,5),this.dirty=!0},EZ3.Ellipsoid.prototype=Object.create(EZ3.Geometry.prototype),EZ3.Ellipsoid.prototype.constructor=EZ3.Ellipsoid,EZ3.Ellipsoid.prototype.generate=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m=[],n=[],o=[],p=new EZ3.Vector3,q=!1;for(k=0;k<this.resolution.x;++k)for(l=0;l<this.resolution.y;++l)i=k/(this.resolution.x-1),j=l/(this.resolution.y-1),c=EZ3.Math.DOUBLE_PI*i,d=EZ3.Math.PI*j,p.x=this.radiuses.x*Math.cos(c)*Math.sin(d),p.y=this.radiuses.y*Math.sin(d-EZ3.Math.HALF_PI),p.z=this.radiuses.z*Math.sin(c)*Math.sin(d),m.push(i),m.push(j),o.push(p.x),o.push(p.y),o.push(p.z);for(k=0;k<this.resolution.x-1;++k)for(l=0;l<this.resolution.y-1;++l)e=k*this.resolution.y+l,f=k*this.resolution.y+(l+1),g=(k+1)*this.resolution.y+l,h=(k+1)*this.resolution.y+(l+1),q||(b=n.length,q=q||e>EZ3.Math.MAX_USHORT||f>EZ3.Math.MAX_USHORT||g>EZ3.Math.MAX_USHORT||h>EZ3.Math.MAX_USHORT),n.push(e,f,h,e,h,g);a=new EZ3.IndexBuffer(n,!1,q),this.buffers.add("triangle",a),a=new EZ3.VertexBuffer(m,!1),a.addAttribute("uv",new EZ3.VertexBufferAttribute(2)),this.buffers.add("uv",a),a=new EZ3.VertexBuffer(o,!1),a.addAttribute("position",new EZ3.VertexBufferAttribute(3)),this.buffers.add("position",a)},EZ3.Grid=function(a){EZ3.Geometry.call(this),void 0!==a&&(a instanceof EZ3.Vector2?this.resolution=a:this.resolution=new EZ3.Vector2(2,2)),this.dirty=!0},EZ3.Grid.prototype=Object.create(EZ3.Geometry.prototype),EZ3.Grid.prototype.constructor=EZ3.Grid,EZ3.Grid.prototype.generate=function(){var a,b,c,d,e,f,g,h,i=[],j=[],k=[],l=!1;for(h=0;h<this.resolution.x+1;++h)for(g=0;g<this.resolution.y+1;++g)k.push(g),k.push(0),k.push(h),i.push(g/this.resolution.y),i.push(h/this.resolution.x);for(h=0;h<this.resolution.x;++h)for(g=0;g<this.resolution.y;++g)c=h*(this.resolution.x+1)+g,d=c+1,e=c+(this.resolution.x+1),f=e+1,l||(b=j.length,l=l||c>EZ3.Math.MAX_USHORT||d>EZ3.Math.MAX_USHORT||e>EZ3.Math.MAX_USHORT||f>EZ3.Math.MAX_USHORT),j.push(c,e,d,d,e,f);a=new EZ3.IndexBuffer(j,!1,l),this.buffers.add("triangle",a),a=new EZ3.VertexBuffer(i,!1),a.addAttribute("uv",new EZ3.VertexBufferAttribute(2)),this.buffers.add("uv",a),a=new EZ3.VertexBuffer(k,!1),a.addAttribute("position",new EZ3.VertexBufferAttribute(3)),this.buffers.add("position",a)},EZ3.Sphere=function(a,b){EZ3.Geometry.call(this),this.radius=a,b instanceof EZ3.Vector2?this.resolution=b:this.resolution=new EZ3.Vector2(5,5),this.dirty=!0},EZ3.Sphere.prototype=Object.create(EZ3.Geometry.prototype),EZ3.Sphere.prototype.constructor=EZ3.Sphere,EZ3.Sphere.prototype.generate=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m=new EZ3.Vector3,n=[],o=[],p=[],q=!1;for(k=0;k<this.resolution.x;k++)for(l=0;l<this.resolution.y;l++)i=k/(this.resolution.x-1),j=l/(this.resolution.y-1),c=EZ3.Math.DOUBLE_PI*i,d=EZ3.Math.PI*j,m.x=this.radius*Math.cos(c)*Math.sin(d),m.y=this.radius*Math.sin(d-EZ3.Math.HALF_PI),m.z=this.radius*Math.sin(c)*Math.sin(d),n.push(i),n.push(j),p.push(m.x),p.push(m.y),p.push(m.z);for(k=0;k<this.resolution.x-1;++k)for(l=0;l<this.resolution.y-1;++l)e=k*this.resolution.y+l,f=k*this.resolution.y+(l+1),g=(k+1)*this.resolution.y+l,h=(k+1)*this.resolution.y+(l+1),q||(b=o.length,q=q||e>EZ3.Math.MAX_USHORT||f>EZ3.Math.MAX_USHORT||g>EZ3.Math.MAX_USHORT||h>EZ3.Math.MAX_USHORT),o.push(e,f,h,e,h,g);a=new EZ3.IndexBuffer(o,!1,q),this.buffers.add("triangle",a),a=new EZ3.VertexBuffer(n,!1),a.addAttribute("uv",new EZ3.VertexBufferAttribute(2)),this.buffers.add("uv",a),a=new EZ3.VertexBuffer(p,!1),a.addAttribute("position",new EZ3.VertexBufferAttribute(3)),this.buffers.add("position",a)},EZ3.Torus=function(a,b){EZ3.Geometry.call(this),void 0!==a&&(a instanceof EZ3.Vector2?this.radiuses=a:this.radiuses=new EZ3.Vector2(.5,1)),void 0!==b&&(b instanceof EZ3.Vector2?this.resolution=b:this.resolution=new EZ3.Vector2(5,5)),this.dirty=!0},EZ3.Torus.prototype=Object.create(EZ3.Geometry.prototype),EZ3.Torus.prototype.constructor=EZ3.Torus,EZ3.Torus.prototype.generate=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r=[],s=[],t=[],u=new EZ3.Vector3,v=!1;for(o=0;o<this.resolution.x;++o)for(q=0;q<this.resolution.y;++q)m=o/(this.resolution.x-1),n=q/(this.resolution.y-1),g=EZ3.Math.DOUBLE_PI*m,h=EZ3.Math.DOUBLE_PI*n,c=Math.cos(g),d=Math.cos(h),e=Math.sin(g),f=Math.sin(h),u.x=(this.radiuses.x+this.radiuses.y*d)*c,u.y=this.radiuses.y*f,u.z=(this.radiuses.x+this.radiuses.y*d)*e,r.push(m),r.push(n),t.push(u.x),t.push(u.y),t.push(u.z);for(o=0;o<this.resolution.x-1;++o)for(p=0;p<this.resolution.y-1;++p)i=o*this.resolution.y+p,j=o*this.resolution.y+(p+1),k=(o+1)*this.resolution.y+p,l=(o+1)*this.resolution.y+(p+1),v||(b=s.length,v=v||i>EZ3.Math.MAX_USHORT||j>EZ3.Math.MAX_USHORT||k>EZ3.Math.MAX_USHORT||l>EZ3.Math.MAX_USHORT),s.push(i,j,l,i,l,k);a=new EZ3.IndexBuffer(s,!1,v),this.buffers.add("triangle",a),a=new EZ3.VertexBuffer(r,!1),a.addAttribute("uv",new EZ3.VertexBufferAttribute(2)),this.buffers.add("uv",a),a=new EZ3.VertexBuffer(t,!1),a.addAttribute("position",new EZ3.VertexBufferAttribute(3)),this.buffers.add("position",a)},EZ3.IndexBuffer=function(a,b,c){EZ3.Buffer.call(this,a,b),this.need32Bits=c||!1},EZ3.IndexBuffer.prototype=Object.create(EZ3.Buffer.prototype),EZ3.IndexBuffer.prototype.constructor=EZ3.IndexBuffer,EZ3.IndexBuffer.prototype.bind=function(a){this._id||(this._id=a.createBuffer()),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this._id)},EZ3.IndexBuffer.prototype.update=function(a,b){var c,d,e,f,g,h,i=this.dynamic?a.DYNAMIC_DRAW:a.STATIC_DRAW;if(this.need32Bits){if(!b.elementIndexUInt)return;g=4,d=Uint32Array}else g=2,d=Uint16Array;if(c=g*this.data.length,c!==this.length||i!==this.usage)this.usage=i,this.length=c,a.bufferData(a.ELEMENT_ARRAY_BUFFER,new d(this.data),i);else if(this.ranges.length)for(h=0;h<this.ranges.length;h++)e=g*this.ranges[h].left,f=this.data.slice(this.ranges[h].left,this.ranges[h].right),a.bufferSubData(a.ELEMENT_ARRAY_BUFFER,e,new d(f));else a.bufferSubData(a.ELEMENT_ARRAY_BUFFER,0,new d(this.data))},EZ3.IndexBuffer.prototype.getType=function(a,b){return b.elementIndexUInt&&this.need32Bits?a.UNSIGNED_INT:a.UNSIGNED_SHORT},EZ3.VertexBuffer=function(a,b){EZ3.Buffer.call(this,a,b),this._stride=0,this._attributes={}},EZ3.VertexBuffer.prototype=Object.create(EZ3.Buffer.prototype),EZ3.VertexBuffer.prototype.constructor=EZ3.VertexBuffer,EZ3.VertexBuffer.prototype.validate=function(a,b){var c;for(c in this._attributes)if(b[c]>=0)return!0;return!1},EZ3.VertexBuffer.prototype.bind=function(a,b,c){var d,e,f,g,h,i=a.FLOAT,j=this._stride;this._id||(this._id=a.createBuffer()),a.bindBuffer(a.ARRAY_BUFFER,this._id);for(h in this._attributes)f=b[h],g=this._attributes[h].size,e=this._attributes[h].offset,d=this._attributes[h].normalized,f>=0&&(c?(c.attribute[f]||(a.enableVertexAttribArray(f),c.attribute[f]=!0),a.vertexAttribPointer(f,g,i,d,j,e)):(a.enableVertexAttribArray(f),a.vertexAttribPointer(f,g,i,d,j,e)))},EZ3.VertexBuffer.prototype.update=function(a){var b,c,d,e=4,f=e*this.data.length,g=this.dynamic?a.DYNAMIC_DRAW:a.STATIC_DRAW;if(f!==this.length||g!==this.usage)this.usage=g,this.length=f,a.bufferData(a.ARRAY_BUFFER,new Float32Array(this.data),g);else if(this.ranges.length)for(d=0;d<this.ranges.length;d++)b=e*this.ranges[d].left,c=this.data.slice(this.ranges[d].left,this.ranges[d].right),a.bufferSubData(a.ARRAY_BUFFER,b,new Float32Array(c));else a.bufferSubData(a.ARRAY_BUFFER,0,new Float32Array(this.data))},EZ3.VertexBuffer.prototype.addAttribute=function(a,b){b instanceof EZ3.VertexBufferAttribute&&(this._stride+=4*b.size,this._attributes[a]=b)},EZ3.VertexBuffer.prototype.getAttribute=function(a){return this._attributes[a]},EZ3.Cubemap=function(a,b,c,d,e,f){EZ3.Texture.call(this),this._images=[],this._images[EZ3.Cubemap.POSITIVE_X]=a,this._images[EZ3.Cubemap.NEGATIVE_X]=b,this._images[EZ3.Cubemap.POSITIVE_Y]=c,this._images[EZ3.Cubemap.NEGATIVE_Y]=d,this._images[EZ3.Cubemap.POSITIVE_Z]=e,this._images[EZ3.Cubemap.NEGATIVE_Z]=f},EZ3.Cubemap.prototype=Object.create(EZ3.Texture.prototype),EZ3.Cubemap.prototype.contructor=EZ3.Cubemap,EZ3.Cubemap.prototype.bind=function(a,b,c){var d=a.TEXTURE0+c;this._id||(this._id=a.createTexture()),b.currentTextureSlot!==d&&(a.activeTexture(d),b.currentTextureSlot=d),b.texture[d]?(b.texture[d].id!==this._id||b.texture[d].type!==a.TEXTURE_CUBE_MAP)&&(b.texture[d].id=this._id,b.texture[d].type=a.TEXTURE_CUBE_MAP,a.bindTexture(b.texture[d].type,b.texture[d].id)):(b.texture[d]={id:this._id,type:a.TEXTURE_CUBE_MAP},a.bindTexture(b.texture[d].type,b.texture[d].id))},EZ3.Cubemap.prototype.update=function(a,b,c){var d,e,f;for(f=0;6>f;f++)e=a.TEXTURE_CUBE_MAP_POSITIVE_X+f,d=this._images[EZ3.Cubemap.POSITIVE_X+f],a.texImage2D(e,0,b,c,a.UNSIGNED_BYTE,d);a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,a.LINEAR),a.generateMipmap(a.TEXTURE_CUBE_MAP)},EZ3.Cubemap.POSITIVE_X=0,EZ3.Cubemap.NEGATIVE_X=1,EZ3.Cubemap.POSITIVE_Y=2,EZ3.Cubemap.NEGATIVE_Y=3,EZ3.Cubemap.POSITIVE_Z=4,EZ3.Cubemap.NEGATIVE_Z=5,EZ3.Texture2D=function(a){EZ3.Texture.call(this),this._image=a},EZ3.Texture2D.prototype=Object.create(EZ3.Texture.prototype),EZ3.Texture2D.prototype.constructor=EZ3.Texture2D,EZ3.Texture2D.prototype.bind=function(a,b,c){var d=a.TEXTURE0+c;this._id||(this._id=a.createTexture()),b.currentTextureSlot!==d&&(a.activeTexture(d),b.currentTextureSlot=d),b.texture[d]?(b.texture[d].id!==this._id||b.texture[d].type!==a.TEXTURE_2D)&&(b.texture[d].id=this._id,b.texture[d].type=a.TEXTURE_2D,a.bindTexture(b.texture[d].type,b.texture[d].id)):(b.texture[d]={id:this._id,type:a.TEXTURE_2D},a.bindTexture(b.texture[d].type,b.texture[d].id))},EZ3.Texture2D.prototype.update=function(a,b,c){function d(a){return 0===(a&a-1)}function e(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1}var f,g;d(this._image.width)&&d(this._image.height)||(f=document.createElement("canvas"),f.width=e(this._image.width),f.height=e(this._image.height),g=f.getContext("2d"),g.drawImage(this._image,0,0,this._image.width,this._image.height,0,0,f.width,f.height),this._image=f),a.texImage2D(a.TEXTURE_2D,0,b,c,a.UNSIGNED_BYTE,this._image),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.REPEAT),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.REPEAT),a.generateMipmap(a.TEXTURE_2D)};