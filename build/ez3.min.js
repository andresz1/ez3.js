/*! ez3 08-02-2016 */
var EZ3=function(){};EZ3=new EZ3,EZ3["extends"]=function(a,b){var c;for(c in b)a[c]=b[c]},EZ3.toFileName=function(a){return a.split("/").pop()},EZ3.toFileExtension=function(a){return a.split("/").pop().split(".").pop()},EZ3.toBaseUrl=function(a){var b=a.split("/");return a.substr(0,a.length-b[b.length-1].length)},EZ3.Control=function(a){this.entity=a},EZ3.Control.prototype.constructor=EZ3.Control,EZ3.Engine=function(a,b,c){var d=EZ3.Device;this._animationFrame=null,this._renderer=null,this.time=null,this.input=null,this.screens=null,d.onReady(this._init,this,[a,b,c])},EZ3.Engine.prototype._init=function(a,b,c){var d=a.getBoundingClientRect();this._animationFrame=new EZ3.AnimationFrame(!1),this._renderer=new EZ3.Renderer(a,c),this.time=new EZ3.Time,this.input=new EZ3.InputManager(a,d),this.screens=new EZ3.ScreenManager(a,d,this._renderer,this.time,this.input,b),this._renderer.initContext(),this.time.start(),this._update()},EZ3.Engine.prototype._update=function(){this.screens.update(),this.time.update(),this._animationFrame.request(this._update.bind(this))},EZ3.Entity=function(){var a=this;this._cache={},this.parent=null,this.children=[],this.model=new EZ3.Matrix4,this.world=new EZ3.Matrix4,this.scale=new EZ3.Vector3(1,1,1),this.rotation=new EZ3.Euler,this.position=new EZ3.Vector3,this.quaternion=new EZ3.Quaternion,this.rotation.onChange.add(function(){a.quaternion.setFromEuler(a.rotation)}),this.quaternion.onChange.add(function(){a.rotation.setFromQuaternion(a.quaternion)})},EZ3.Entity.prototype.add=function(a){a.parent&&a.parent.remove(a),a.parent=this,this.children.push(a)},EZ3.Entity.prototype.remove=function(a){var b=this.children.indexOf(a);~b&&this.children.splice(b,1)},EZ3.Entity.prototype.lookAt=function(a,b){var c=!1;a=a||new EZ3.Vector3,b=b||new EZ3.Vector3(0,1,0),a.isDiff(this._cache.target)&&(this._cache.target=a.clone(),c=!0),b.isDiff(this._cache.up)&&(this._cache.up=b.clone(),c=!0),this.position.isDiff(this._cache.position)&&(c=!0),c&&this.quaternion.setFromRotationMatrix((new EZ3.Matrix4).lookAt(this.position,a,b))},EZ3.Entity.prototype.updateWorld=function(){var a=!1,b=!1,c=!1,d=!1,e=!1;this.position.isDiff(this._cache.position)&&(this._cache.position=this.position.clone(),c=!0),this.quaternion.isDiff(this._cache.quaternion)&&(this._cache.quaternion=this.quaternion.clone(),d=!0),this.scale.isDiff(this._cache.scale)&&(this._cache.scale=this.scale.clone(),a=!0),(c||d||a)&&this.model.compose(this.position,this.quaternion,this.scale),this.parent?(b=this.model.isDiff(this._cache.model),e=this.parent.world.isDiff(this._cache.parentWorld),(e||b)&&(b&&(this._cache.model=this.model.clone()),e&&(this._cache.parentWorld=this.parent.world.clone()),this.world.mul(this.parent.world,this.model))):(b=this.model.isDiff(this._cache.model),b&&(this.world=this.model.clone(),this._cache.model=this.model.clone()))},EZ3.Entity.prototype.traverse=function(a){var b,c,d,e=[];for(e.push(this);e.length;)for(b=e.pop(),c=b.children.slice(),a(b),d=c.length-1;d>=0;d--)e.push(c[d])},EZ3.Entity.prototype.updateWorldTraverse=function(){this.traverse(function(a){a.updateWorld()})},EZ3.Entity.prototype.getWorldPosition=function(){return this.world.getPosition()},EZ3.Entity.prototype.getWorldRotation=function(){return this.world.getRotation()},EZ3.Entity.prototype.getWorldScale=function(){return this.world.getScale()},EZ3.Entity.prototype.getWorldDirection=function(){return new EZ3.Vector3(0,0,1).mulQuaternion(this.getWorldRotation())},EZ3.Entity.prototype.getBoundingBox=function(){var a=new EZ3.Box;return this.traverse(function(b){var c;b instanceof EZ3.Mesh&&(c=b.geometry,c instanceof EZ3.PrimitiveGeometry&&c.updateData(),c.updateBoundingVolumes(),a.union(c.boundingBox))}),a},EZ3.Signal=function(){var a=this;this._bindings=[],this._prevParams=null,this.dispatch=function(){EZ3.Signal.prototype.dispatch.apply(a,arguments)}},EZ3.Signal.prototype._shouldPropagate=!0,EZ3.Signal.prototype.memorize=!1,EZ3.Signal.prototype.active=!0,EZ3.Signal.prototype._registerListener=function(a,b,c,d){var e,f,g=this._indexOfListener(a,c);return-1!==g?(e=this._bindings[g],e.isOnce!==b&&(f="You cannot add",f+=b?"":"Once",f+="() then add",f+=b?"Once":"",f+="() the same listener without removing the relationship first.",console.warn(f))):(e=new EZ3.SignalBinding(this,a,b,c,d),this._addBinding(e)),this.memorize&&this._prevParams&&e.execute(this._prevParams),e},EZ3.Signal.prototype._addBinding=function(a){var b=this._bindings.length;do--b;while(this._bindings[b]&&a._priority<=this._bindings[b]._priority);this._bindings.splice(b+1,0,a)},EZ3.Signal.prototype._indexOfListener=function(a,b){for(var c,d=this._bindings.length;d--;)if(c=this._bindings[d],c.listener===a&&c.context===b)return d;return-1},EZ3.Signal.prototype.has=function(a,b){return-1!==this._indexOfListener(a,b)},EZ3.Signal.prototype.add=function(a,b,c){return this._registerListener(a,!1,b,c)},EZ3.Signal.prototype.addOnce=function(a,b,c){return this._registerListener(a,!0,b,c)},EZ3.Signal.prototype.remove=function(a,b){var c=this._indexOfListener(a,b);return-1!==c&&(this._bindings[c]._destroy(),this._bindings.splice(c,1)),a},EZ3.Signal.prototype.removeAll=function(a){var b=this._bindings.length;if(a)for(;b--;)this._bindings[b].context===a&&(this._bindings[b]._destroy(),this._bindings.splice(b,1));else{for(;b--;)this._bindings[b]._destroy();this._bindings.length=0}},EZ3.Signal.prototype.getNumListeners=function(){return this._bindings.length},EZ3.Signal.prototype.halt=function(){this._shouldPropagate=!1},EZ3.Signal.prototype.dispatch=function(a){var b,c,d;if(this.active&&(b=Array.prototype.slice.call(arguments),d=this._bindings.length,this.memorize&&(this._prevParams=b),d)){c=this._bindings.slice(),this._shouldPropagate=!0;do d--;while(c[d]&&this._shouldPropagate&&c[d].execute(b)!==!1)}},EZ3.Signal.prototype.forget=function(){this._prevParams=null},EZ3.Signal.prototype.dispose=function(){this.removeAll(),delete this._bindings,delete this._prevParams},EZ3.SignalBinding=function(a,b,c,d,e){this._signal=a,this._priority=void 0!==e?e:0,this.listener=b,this.isOnce=c,this.context=d},EZ3.SignalBinding.prototype.active=!0,EZ3.SignalBinding.prototype.params=null,EZ3.SignalBinding.prototype._destroy=function(){delete this._signal,delete this.listener,delete this.context},EZ3.SignalBinding.prototype.execute=function(a){var b,c;return this.active&&this.listener&&(c=this.params?this.params.concat(a):a,b=this.listener.apply(this.context,c),this.isOnce&&this.detach()),b},EZ3.SignalBinding.prototype.detach=function(){return this.isBound()?this._signal.remove(this.listener,this.context):null},EZ3.SignalBinding.prototype.isBound=function(){return!!this._signal&&!!this.listener},EZ3.Framebuffer=function(a){this._id=null,this._cache={},this.size=a,this.texture=null},EZ3.Framebuffer.prototype.constructor=EZ3.Framebuffer,EZ3.Framebuffer.prototype.bind=function(a,b){this._id||(this._id=a.createFramebuffer()),a.bindFramebuffer(a.FRAMEBUFFER,this._id),b.viewport(new EZ3.Vector2,this.size)},EZ3.Framebuffer.prototype.update=function(a){this.texture.bind(a),this.texture.update(a),this.texture.attach(a),a.checkFramebufferStatus(a.FRAMEBUFFER)!==a.FRAMEBUFFER_COMPLETE&&console.warn("EZ3.Framebuffer.update: update is not completed.")},EZ3.Framebuffer.unbind=function(a){a.bindFramebuffer(a.FRAMEBUFFER,null)},EZ3.Geometry=function(){this.buffers=new EZ3.ArrayBuffer,this.boundingSphere=null,this.boundingBox=null},EZ3.Geometry.prototype.computeBoundingVolumes=function(){var a,b,c,d=this.buffers.getPositions();if(d){for(d=d.data,a=new EZ3.Box,b=new EZ3.Vector3,c=0,i=0;i<d.length;i+=3)b.set(d[i],d[i+1],d[i+2]),a.expand(b);for(center=a.getCenter(),i=0;i<d.length;i+=3)b.set(d[i],d[i+1],d[i+2]),c=Math.max(c,center.distance(b));this.boundingBox=a,this.boundingSphere=new EZ3.Sphere(center,c)}},EZ3.Geometry.prototype.computeLines=function(){var a,b,c,d=this.buffers.getTriangles();if(d){for(d=d.data,a=d.need32Bits,b=[],c=0;c<d.length;c+=3)b.push(d[c],d[c+1],d[c]),b.push(d[c+2],d[c+1],d[c+2]);this.buffers.setLines(b,a)}},EZ3.Geometry.prototype.computeNormals=function(){var a,b,c,d,e,f,g,h,i,j,k,l=this.buffers.getTriangles(),m=this.buffers.getPositions();if(l&&m){for(l=l.data,m=m.data,a=[],b=[],c=new EZ3.Vector3,d=new EZ3.Vector3,e=new EZ3.Vector3,f=new EZ3.Vector3,g=new EZ3.Vector3,k=0;k<m.length/3;k++)b.push(new EZ3.Vector3);for(k=0;k<l.length;k+=3)h=3*l[k],i=3*l[k+1],j=3*l[k+2],c.set(m[h],m[h+1],m[h+2]),d.set(m[i],m[i+1],m[i+2]),e.set(m[j],m[j+1],m[j+2]),f.sub(d,c),g.sub(e,c),g.cross(f),b[l[k]].add(g),b[l[k+1]].add(g),b[l[k+2]].add(g);for(k=0;k<b.length;k++)b[k].normalize(),a.push(b[k].x,b[k].y,b[k].z);this.buffers.setNormals(a)}},EZ3.Geometry.prototype.updateBoundingVolumes=function(){this.boundingSphere&&this.boundingBox||this.computeBoundingVolumes()},EZ3.Geometry.prototype.updateLines=function(){this.buffers.getLines()||this.computeLines()},EZ3.Geometry.prototype.updateNormals=function(){this.buffers.getNormals()||this.computeNormals()},EZ3.ArrayBuffer=function(){this._id=null,this._triangular=null,this._linear=null,this._vertex={}},EZ3.ArrayBuffer.prototype.constructor=EZ3.ArrayBuffer,EZ3.ArrayBuffer.prototype.bind=function(a,b,c,d,e){var f,g;if(d.vertexArrayObject){this._id||(this._id=d.vertexArrayObject.createVertexArrayOES()),d.vertexArrayObject.bindVertexArrayOES(this._id);for(g in this._vertex)f=this._vertex[g],f.isValid(a,b)&&f.needUpdate&&(f.bind(a,b),f.update(a),f.needUpdate=!1)}else for(g in this._vertex)f=this._vertex[g],f.isValid(a,b)&&(f.bind(a,b,c),f.needUpdate&&(f.update(a),f.needUpdate=!1));if(e===EZ3.IndexBuffer.TRIANGULAR)f=this._triangular;else{if(e!==EZ3.IndexBuffer.LINEAR)return;f=this._linear}f.bind(a),f.needUpdate&&(f.update(a,d),f.needUpdate=!1)},EZ3.ArrayBuffer.prototype.setLines=function(a,b,c){var d=this._linear;d?(d.data=a,void 0!==c&&(d.dynamic=c),void 0!==b&&(d.need32Bits=b),d.needUpdate=!0):(c=void 0!==c?c:!1,b=void 0!==b?b:!1,d=new EZ3.IndexBuffer(a,c,b),this._linear=d)},EZ3.ArrayBuffer.prototype.setTriangles=function(a,b,c){var d=this._triangular;d?(d.data=a,void 0!==c&&(d.dynamic=c),void 0!==b&&(d.need32Bits=b),d.needUpdate=!0):(c=void 0!==c?c:!1,b=void 0!==b?b:!1,d=new EZ3.IndexBuffer(a,c,b),this._triangular=d)},EZ3.ArrayBuffer.prototype.setPositions=function(a,b){var c=this._vertex.position;return c?(c.data=a,void 0!==b&&(c.dynamic=b),c.needUpdate=!0):(b=void 0!==b?b:!1,c=new EZ3.VertexBuffer(a,b),c.addAttribute("position",new EZ3.VertexBufferAttribute(3)),this._vertex.position=c),c},EZ3.ArrayBuffer.prototype.setNormals=function(a,b){var c=this._vertex.normal;return c?(c.data=a,void 0!==b&&(c.dynamic=b),c.needUpdate=!0):(b=void 0!==b?b:!1,c=new EZ3.VertexBuffer(a,b),c.addAttribute("normal",new EZ3.VertexBufferAttribute(3)),this._vertex.normal=c),c},EZ3.ArrayBuffer.prototype.setUVs=function(a,b){var c=this._vertex.uv;return c?(c.data=a,void 0!==b&&(c.dynamic=b),c.needUpdate=!0):(b=void 0!==b?b:!1,c=new EZ3.VertexBuffer(a,b),c.addAttribute("uv",new EZ3.VertexBufferAttribute(2)),this._vertex.uv=c),c},EZ3.ArrayBuffer.prototype.setVertexBuffer=function(a,b){return this._vertex[a]=b,b},EZ3.ArrayBuffer.prototype.getTriangles=function(){return this._triangular},EZ3.ArrayBuffer.prototype.getLines=function(){return this._linear},EZ3.ArrayBuffer.prototype.getPositions=function(){return this._vertex.position},EZ3.ArrayBuffer.prototype.getNormals=function(){return this._vertex.normal},EZ3.ArrayBuffer.prototype.getUVs=function(){return this._vertex.uv},EZ3.ArrayBuffer.prototype.getVertexBuffer=function(a){return this._vertex[a]},EZ3.Buffer=function(a,b){this._id=null,this._cache={},this._ranges=[],this.data=a||[],this.dynamic=void 0!==b?b:!1,this.needUpdate=!0},EZ3.Buffer.prototype.constructor=EZ3.Buffer,EZ3.Buffer.prototype.bind=function(a,b){this._id||(this._id=a.createBuffer()),a.bindBuffer(b,this._id)},EZ3.Buffer.prototype.update=function(a,b,c){var d,e,f,g,h=c*this.data.length,i=!1;if(d=b===a.ARRAY_BUFFER?Float32Array:4===c?Uint32Array:Uint16Array,this._cache.length!==h&&(this._cache.length=h,i=!0),this._cache.dynamic!==this.dynamic&&(this._cache.dynamic=this.dynamic,i=!0),i)this._ranges=[],a.bufferData(b,new d(this.data),this.dynamic?a.DYNAMIC_DRAW:a.STATIC_DRAW);else if(this._ranges.length){for(g=0;g<this._ranges.length;g+=2)e=c*this._ranges[g],f=this.data.slice(this._ranges[g],this._ranges[g+1]),a.bufferSubData(b,e,new d(f));this._ranges=[]}else a.bufferSubData(b,0,new d(this.data))},EZ3.Buffer.prototype.addUpdateRange=function(a,b){this._ranges.push(a,b)},EZ3.VertexBufferAttribute=function(a,b,c){this.size=a,this.offset=void 0!==b?4*b:0,this.normalized=void 0!==c?c:!1},EZ3.InputManager=function(a,b){this.keyboard=new EZ3.Keyboard,this.mouse=new EZ3.Mouse(a,b),this.touch=new EZ3.Touch(a,b),this.enable()},EZ3.InputManager.prototype.enable=function(){this.keyboard.enable(),this.mouse.enable(),this.touch.enable()},EZ3.InputManager.prototype.disable=function(){this.keyboard.disable(),this.mouse.disable(),this.touch.disable()},EZ3.Keyboard=function(){this._keys=[],this.enabled=!1,this.onKeyPress=new EZ3.Signal,this.onKeyDown=new EZ3.Signal,this.onKeyUp=new EZ3.Signal},EZ3.Keyboard.prototype.constructor=EZ3.Keyboard,EZ3.Keyboard.prototype._processKeyDown=function(a){this._keys[a.keyCode]||(this._keys[a.keyCode]=new EZ3.Switch(a.keyCode)),this._keys[a.keyCode].processDown()&&this.onKeyPress.dispatch(this._keys[a.keyCode]),this.onKeyDown.dispatch(this._keys[a.keyCode])},EZ3.Keyboard.prototype._processKeyUp=function(a){this._keys[a.keyCode]||(this._keys[a.keyCode]=new EZ3.Switch(a.keyCode)),this._keys[a.keyCode].processUp(),this.onKeyUp.dispatch(this._keys[a.keyCode])},EZ3.Keyboard.prototype.enable=function(){var a=this;this.enabled=!0,this._onKeyDown=function(b){a._processKeyDown(b)},this._onKeyUp=function(b){a._processKeyUp(b)},window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1)},EZ3.Keyboard.prototype.disable=function(){this.enabled=!1,window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),delete this._onKeyDown,delete this._onKeyUp},EZ3.Keyboard.prototype.getKey=function(a){return this._keys[a]||(this._keys[a]=new EZ3.Switch(a)),this._keys[a]},EZ3.Keyboard.A="A".charCodeAt(0),EZ3.Keyboard.B="B".charCodeAt(0),EZ3.Keyboard.C="C".charCodeAt(0),EZ3.Keyboard.D="D".charCodeAt(0),EZ3.Keyboard.E="E".charCodeAt(0),EZ3.Keyboard.F="F".charCodeAt(0),EZ3.Keyboard.G="G".charCodeAt(0),EZ3.Keyboard.H="H".charCodeAt(0),EZ3.Keyboard.I="I".charCodeAt(0),EZ3.Keyboard.J="J".charCodeAt(0),EZ3.Keyboard.K="K".charCodeAt(0),EZ3.Keyboard.L="L".charCodeAt(0),EZ3.Keyboard.M="M".charCodeAt(0),EZ3.Keyboard.N="N".charCodeAt(0),EZ3.Keyboard.O="O".charCodeAt(0),EZ3.Keyboard.P="P".charCodeAt(0),EZ3.Keyboard.Q="Q".charCodeAt(0),EZ3.Keyboard.R="R".charCodeAt(0),EZ3.Keyboard.S="S".charCodeAt(0),EZ3.Keyboard.T="T".charCodeAt(0),EZ3.Keyboard.U="U".charCodeAt(0),EZ3.Keyboard.V="V".charCodeAt(0),EZ3.Keyboard.W="W".charCodeAt(0),EZ3.Keyboard.X="X".charCodeAt(0),EZ3.Keyboard.Y="Y".charCodeAt(0),EZ3.Keyboard.Z="Z".charCodeAt(0),EZ3.Keyboard.ZERO="0".charCodeAt(0),EZ3.Keyboard.ONE="1".charCodeAt(0),EZ3.Keyboard.TWO="2".charCodeAt(0),EZ3.Keyboard.THREE="3".charCodeAt(0),EZ3.Keyboard.FOUR="4".charCodeAt(0),EZ3.Keyboard.FIVE="5".charCodeAt(0),EZ3.Keyboard.SIX="6".charCodeAt(0),EZ3.Keyboard.SEVEN="7".charCodeAt(0),EZ3.Keyboard.EIGHT="8".charCodeAt(0),EZ3.Keyboard.NINE="9".charCodeAt(0),EZ3.Keyboard.NUMPAD_0=96,EZ3.Keyboard.NUMPAD_1=97,EZ3.Keyboard.NUMPAD_2=98,EZ3.Keyboard.NUMPAD_3=99,EZ3.Keyboard.NUMPAD_4=100,EZ3.Keyboard.NUMPAD_5=101,EZ3.Keyboard.NUMPAD_6=102,EZ3.Keyboard.NUMPAD_7=103,EZ3.Keyboard.NUMPAD_8=104,EZ3.Keyboard.NUMPAD_9=105,EZ3.Keyboard.NUMPAD_MULTIPLY=106,EZ3.Keyboard.NUMPAD_ADD=107,EZ3.Keyboard.NUMPAD_ENTER=108,EZ3.Keyboard.NUMPAD_SUBTRACT=109,EZ3.Keyboard.NUMPAD_DECIMAL=110,EZ3.Keyboard.NUMPAD_DIVIDE=111,EZ3.Keyboard.F1=112,EZ3.Keyboard.F2=113,EZ3.Keyboard.F3=114,EZ3.Keyboard.F4=115,EZ3.Keyboard.F5=116,EZ3.Keyboard.F6=117,EZ3.Keyboard.F7=118,EZ3.Keyboard.F8=119,EZ3.Keyboard.F9=120,EZ3.Keyboard.F10=121,EZ3.Keyboard.F11=122,EZ3.Keyboard.F12=123,EZ3.Keyboard.F13=124,EZ3.Keyboard.F14=125,EZ3.Keyboard.F15=126,EZ3.Keyboard.COLON=186,EZ3.Keyboard.EQUALS=187,EZ3.Keyboard.COMMA=188,EZ3.Keyboard.UNDERSCORE=189,EZ3.Keyboard.PERIOD=190,EZ3.Keyboard.QUESTION_MARK=191,EZ3.Keyboard.TILDE=192,EZ3.Keyboard.OPEN_BRACKET=219,EZ3.Keyboard.BACKWARD_SLASH=220,EZ3.Keyboard.CLOSED_BRACKET=221,EZ3.Keyboard.QUOTES=222,EZ3.Keyboard.BACKSPACE=8,EZ3.Keyboard.TAB=9,EZ3.Keyboard.CLEAR=12,EZ3.Keyboard.ENTER=13,EZ3.Keyboard.SHIFT=16,EZ3.Keyboard.CONTROL=17,EZ3.Keyboard.ALT=18,EZ3.Keyboard.CAPS_LOCK=20,EZ3.Keyboard.ESC=27,EZ3.Keyboard.SPACEBAR=32,EZ3.Keyboard.PAGE_UP=33,EZ3.Keyboard.PAGE_DOWN=34,EZ3.Keyboard.END=35,EZ3.Keyboard.HOME=36,EZ3.Keyboard.LEFT=37,EZ3.Keyboard.UP=38,EZ3.Keyboard.RIGHT=39,EZ3.Keyboard.DOWN=40,EZ3.Keyboard.PLUS=43,EZ3.Keyboard.MINUS=44,EZ3.Keyboard.INSERT=45,EZ3.Keyboard.DELETE=46,EZ3.Keyboard.HELP=47,EZ3.Keyboard.NUM_LOCK=144,EZ3.Mouse=function(a,b){this._domElement=a,this._bounds=b,this.enabled=!1,this.pointer=new EZ3.MousePointer,this.onPress=new EZ3.Signal,this.onMove=new EZ3.Signal,this.onUp=new EZ3.Signal,this.onWheel=new EZ3.Signal,this.onLockChange=new EZ3.Signal},EZ3.Mouse.prototype.constructor=EZ3.Mouse,EZ3.Mouse.prototype._processMousePress=function(a){this.pointer.processPress(a,this._domElement,this._bounds,this.onPress,this.onMove)},EZ3.Mouse.prototype._processMouseMove=function(a){this.pointer.processMove(a,this._domElement,this._bounds,this.onMove)},EZ3.Mouse.prototype._processMouseUp=function(a){this.pointer.processUp(a,this.onUp)},EZ3.Mouse.prototype._processMouseWheel=function(a){this.pointer.processWheel(a,this.onWheel)},EZ3.Mouse.prototype._processMouseLockChange=function(){var a=EZ3.Device;this.pointer.locked&&(document.removeEventListener(a.pointerLockChange,this._onMouseLockChange,!0),delete this._onMouseLockChange),this.pointer.processLockChange(this.onLockChange)},EZ3.Mouse.prototype.requestPointerLock=function(){var a,b=EZ3.Device;b.requestPointerLock&&!this.pointer.locked&&(a=this,this._onMouseLockChange=function(b){a._processMouseLockChange(b)},document.addEventListener(b.pointerLockChange,this._onMouseLockChange,!0),this._domElement[b.requestPointerLock]())},EZ3.Mouse.prototype.exitPointerLock=function(){var a=EZ3.Device;a.exitPointerLock&&this.pointer.locked&&document[a.exitPointerLock]()},EZ3.Mouse.prototype.enable=function(){var a=this,b=EZ3.Device;this.enabled=!0,this._onMousePress=function(b){a._processMousePress(b)},this._onMouseMove=function(b){a._processMouseMove(b)},this._onMouseUp=function(b){a._processMouseUp(b)},this._domElement.addEventListener("mousedown",this._onMousePress,!0),this._domElement.addEventListener("mousemove",this._onMouseMove,!0),this._domElement.addEventListener("mouseup",this._onMouseUp,!0),b.wheel&&(this._onMouseWheel=function(b){a._processMouseWheel(b)},this._domElement.addEventListener(b.wheel,this._onMouseWheel,!0))},EZ3.Mouse.prototype.disable=function(){var a=EZ3.Device;this.enabled=!1,this._domElement.removeEventListener("mousedown",this._onMouserDown,!0),this._domElement.removeEventListener("mousemove",this._onMouseMove,!0),this._domElement.removeEventListener("mouseup",this._onMouseUp,!0),delete this._onMousePress,delete this._onMouseMove,delete this._onMouseUp,a.wheel&&(this._domElement.removeEventListener(a.wheel,this._onMouseWheel,!0),delete this._onMouseWheel)},EZ3.Mouse.LEFT_BUTTON=0,EZ3.Mouse.MIDDLE_BUTTON=1,EZ3.Mouse.RIGHT_BUTTON=2,EZ3.Mouse.BACK_BUTTON=3,EZ3.Mouse.FORWARD_BUTTON=4,EZ3.Pointer=function(){this.last={page:new EZ3.Vector2,client:new EZ3.Vector2,screen:new EZ3.Vector2,position:new EZ3.Vector2},this.current={page:new EZ3.Vector2,client:new EZ3.Vector2,screen:new EZ3.Vector2,position:new EZ3.Vector2},this.entered=!1},EZ3.Pointer.prototype.constructor=EZ3.Pointer,EZ3.Pointer.prototype.processPress=function(a,b,c){EZ3.Pointer.prototype.processMove.call(this,a,b,c)},EZ3.Pointer.prototype.processMove=function(a,b,c){var d=Math.round((a.clientX-c.left)/(c.right-c.left)*b.width),e=Math.round((a.clientY-c.top)/(c.bottom-c.top)*b.height);this.last.page.copy(this.current.position),this.last.client.copy(this.current.client),this.last.screen.copy(this.current.screen),this.last.position.copy(this.current.position),this.current.page.set(a.pageX,a.pageY),this.current.client.set(a.clientX,a.clientY),this.current.screen.set(a.screenX,a.screenY),this.current.position.set(d,e)},EZ3.Switch=function(a){this._state=!1,this.code=a},EZ3.Switch.prototype.constructor=EZ3.Switch,EZ3.Switch.prototype.processPress=function(){this._state=!0},EZ3.Switch.prototype.processDown=function(){var a=this.isUp();return this._state=!0,a},EZ3.Switch.prototype.processUp=function(){this._state=!1},EZ3.Switch.prototype.isDown=function(){return this._state},EZ3.Switch.prototype.isUp=function(){return!this._state},EZ3.Touch=function(a,b){this._domElement=a,this._bounds=b,this._pointers=[],this.enabled=!1,this.onPress=new EZ3.Signal,this.onMove=new EZ3.Signal,this.onUp=new EZ3.Signal},EZ3.Touch.prototype.constructor=EZ3.Touch,EZ3.Touch.prototype._getPointerIndex=function(a){var b;for(b=0;b<this._pointers.length;b++)if(a===this._pointers[b].id)return b;return-1},EZ3.Touch.prototype._processTouchPress=function(a){var b,c,d;for(a.preventDefault(),c=0;c<a.changedTouches.length;c++){for(b=null,d=0;d<EZ3.Touch.MAX_NUM_OF_POINTERS;d++){if(!this._pointers[d]){b=a.changedTouches[c],this._pointers[d]=new EZ3.TouchPointer(d,b.identifier);break}if(this._pointers[d].isUp()){b=a.changedTouches[c],this._pointers[d].id=b.identifier;break}}b&&this._pointers[d].processPress(b,this._domElement,this._bounds,this.onPress,this.onMove)}},EZ3.Touch.prototype._processTouchMove=function(a){var b,c;for(a.preventDefault(),b=0;b<a.changedTouches.length;b++)c=this._getPointerIndex(a.changedTouches[b].identifier),c>=0&&this._pointers[c].processMove(a.changedTouches[b],this._domElement,this._bounds,this.onMove)},EZ3.Touch.prototype._processTouchUp=function(a){var b,c;for(a.preventDefault(),b=0;b<a.changedTouches.length;b++)c=this._getPointerIndex(a.changedTouches[b].identifier),c>=0&&this._pointers[c].processUp(this.onUp)},EZ3.Touch.prototype.enable=function(){var a,b=EZ3.Device;b.touchDown&&(a=this,this.enabled=!0,this._onTouchPress=function(b){a._processTouchPress(b)},this._onTouchMove=function(b){a._processTouchMove(b)},this._onTouchUp=function(b){a._processTouchUp(b)},this._domElement.addEventListener(b.touchDown,this._onTouchPress,!1),this._domElement.addEventListener(b.touchMove,this._onTouchMove,!1),this._domElement.addEventListener(b.touchUp,this._onTouchUp,!1))},EZ3.Touch.prototype.disable=function(){var a=EZ3.Device;a.touchDown&&(this.enabled=!1,this._domElement.removeEventListener(a.touchDown,this._onTouchPress,!1),this._domElement.removeEventListener(a.touchMove,this._onTouchMove,!1),this._domElement.removeEventListener(a.touchUp,this._onTouchUp,!1),delete this._onTouchPress,delete this._onTouchMove,delete this._onTouchUp)},EZ3.Touch.prototype.getPointer=function(a){return this._pointers[a]||(this._pointers[a]=new EZ3.TouchPointer(a)),this._pointers[a]},EZ3.Touch.POINTER_1=0,EZ3.Touch.POINTER_2=1,EZ3.Touch.POINTER_3=2,EZ3.Touch.POINTER_4=3,EZ3.Touch.POINTER_5=4,EZ3.Touch.POINTER_6=5,EZ3.Touch.POINTER_7=6,EZ3.Touch.POINTER_8=7,EZ3.Touch.POINTER_9=8,EZ3.Touch.POINTER_10=9,EZ3.Touch.MAX_NUM_OF_POINTERS=10,EZ3.Light=function(){this.diffuse=new EZ3.Vector3(1,1,1),this.specular=new EZ3.Vector3(1,1,1),this.shadowBias=5e-5,this.shadowDarkness=.2},EZ3.Light.prototype=Object.create(EZ3.Entity.prototype),EZ3.Light.prototype.constructor=EZ3.Light,EZ3.Light.prototype.updateUniforms=function(a,b,c){b.loadUniformFloat(a,c+"diffuse",this.diffuse),b.loadUniformFloat(a,c+"specular",this.specular)},EZ3.AssetManager=function(){this._assets={}},EZ3.AssetManager.prototype.add=function(a,b){return this._assets[a]=b,this._assets[a]},EZ3.AssetManager.prototype.get=function(a){var b,c=this._assets[a];if(c)return c;for(b in this._assets)if(EZ3.toFileName(b)===a)return this._assets[b]},EZ3.Cache=function(){this._files={}},EZ3.Cache=new EZ3.Cache,EZ3.Cache.add=function(a,b){return this._files[a]=b,this._files[a]},EZ3.Cache.get=function(a){return this._files[a]},EZ3.File=function(a){this.data=a||null},EZ3.File.prototype.constructor=EZ3.File,EZ3.Request=function(a,b,c,d){this.url=a,this.asset=b,this.cached=void 0!==c?c:!0,this.crossOrigin=void 0!==d?d:!1},EZ3.Request.prototype.constructor=EZ3.Request,EZ3.RequestManager=function(){this._requests={},this._assets=new EZ3.AssetManager,this.started=!1,this.toSend=0,this.loaded=0,this.failed=0,this.onComplete=new EZ3.Signal,this.onProgress=new EZ3.Signal},EZ3.RequestManager.prototype._processLoad=function(a,b,c){var d;b instanceof EZ3.File&&c&&(d=EZ3.Cache,d.add(a,b)),this.loaded++,this._assets.add(a,b),this._processProgress(a,b)},EZ3.RequestManager.prototype._processError=function(a){this.failed++,this._processProgress(a)},EZ3.RequestManager.prototype._processProgress=function(a,b){var c,d,e;this.onProgress.dispatch(a,b,this.loaded,this.failed,this.toSend),this.toSend===this.loaded+this.failed&&(e=this._assets,c=this.loaded,d=this.failed,this._requests={},this._assets=new EZ3.AssetManager,this.toSend=0,this.loaded=0,this.failed=0,this.started=!1,this.onComplete.dispatch(e,d,c))},EZ3.RequestManager.prototype.addFileRequest=function(a,b,c,d){var e=EZ3.Cache,f=e.get(a);return f?(this._assets.add(a,f),f):(this._requests[a]||(this._requests[a]=new EZ3.FileRequest(a,b,c,d),this.toSend++),this._requests[a].asset)},EZ3.RequestManager.prototype.addImageRequest=function(a,b,c){var d=EZ3.Cache,e=d.get(a);if(e)return this._assets.add(a,e),e;if(!this._requests[a]){var f=EZ3.toFileExtension(a);"tga"===f?this._requests[a]=new EZ3.TGARequest(a,b,c):this._requests[a]=new EZ3.ImageRequest(a,b,c),this.toSend++}return this._requests[a].asset},EZ3.RequestManager.prototype.addEntityRequest=function(a,b,c){if(!this._requests[a]){var d=EZ3.toFileExtension(a);if("obj"===d)this._requests[a]=new EZ3.OBJRequest(a,b,c);else if("off"===d)this._requests[a]=new EZ3.OFFRequest(a,b,c);else if("mdl"===d)this._requests[a]=new EZ3.MDLRequest(a,b,c);else{if("md2"!==d)return;this._requests[a]=new EZ3.MD2Request(a,b,c)}this.toSend++}return this._requests[a].asset},EZ3.RequestManager.prototype.send=function(){var a,b;this.toSend||(a=this._assets,this._assets=new EZ3.AssetManager,this.onComplete.dispatch(a,0,0)),this.started=!0;for(b in this._requests)this._requests[b].send(this._processLoad.bind(this),this._processError.bind(this))},EZ3.RequestManager.prototype.file=EZ3.RequestManager.prototype.addFileRequest,EZ3.RequestManager.prototype.image=EZ3.RequestManager.prototype.addImageRequest,EZ3.RequestManager.prototype.entity=EZ3.RequestManager.prototype.addEntityRequest,EZ3.RequestManager.prototype.start=EZ3.RequestManager.prototype.send,EZ3.Material=function(a){this._id=a||null,this.program=null,this.fill=EZ3.Material.SOLID,this.visible=!0,this.depthTest=!0,this.transparent=!1,this.faceCulling=EZ3.Material.BACK_CULLING,this.blending=EZ3.Material.STANDARD_BLENDING},EZ3.Material.prototype.updateStates=function(a,b){this.depthTest?b.enable(a.DEPTH_TEST):b.disable(a.DEPTH_TEST),this.faceCulling!==EZ3.Material.NO_CULLING?(b.enable(a.CULL_FACE),this.faceCulling===EZ3.Material.FRONT_CULLING?b.cullFace(a.FRONT):b.cullFace(a.BACK)):b.disable(a.CULL_FACE),this.transparent?(b.enable(a.BLEND),this.blending===EZ3.Material.ADDITIVE_BLENDING?(b.blendEquation(a.FUNC_ADD),b.blendFunc(a.SRC_ALPHA,a.ONE)):this.blending===EZ3.Material.SUBTRACTIVE_BLENDING?(b.blendEquation(a.FUNC_ADD),b.blendFunc(a.ZERO,a.ONE_MINUS_SRC_COLOR)):this.blending===EZ3.Material.MULTIPLICATIVE_BLENDING?(b.blendEquation(a.FUNC_ADD),b.blendFunc(a.ZERO,a.SRC_COLOR)):(b.blendEquation(a.FUNC_ADD),b.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA))):b.disable(a.BLEND)},EZ3.Material.SOLID=0,EZ3.Material.POINTS=1,EZ3.Material.WIREFRAME=2,EZ3.Material.NO_CULLING=0,EZ3.Material.BACK_CULLING=1,EZ3.Material.FRONT_CULLING=2,EZ3.Material.STANDARD_BLENDING=0,EZ3.Material.ADDITIVE_BLENDING=1,EZ3.Material.SUBTRACTIVE_BLENDING=2,EZ3.Material.MULTIPLICATIVE_BLENDING=3,EZ3.Box=function(a,b){this.min=void 0!==a?a:new EZ3.Vector3(1/0),this.max=void 0!==b?b:new EZ3.Vector3(-(1/0))},EZ3.Box.prototype.constructor=EZ3.Box,EZ3.Box.prototype.expand=function(a){return this.min.min(a),this.max.max(a),this},EZ3.Box.prototype.union=function(a){return this.min.min(a.min),this.max.max(a.max),this},EZ3.Box.prototype.applyMatrix4=function(a){var b,c=[];for(c.push(new EZ3.Vector3(this.min.x,this.min.y,this.min.z).mulMatrix4(a)),c.push(new EZ3.Vector3(this.min.x,this.min.y,this.max.z).mulMatrix4(a)),c.push(new EZ3.Vector3(this.min.x,this.max.y,this.min.z).mulMatrix4(a)),c.push(new EZ3.Vector3(this.min.x,this.max.y,this.max.z).mulMatrix4(a)),c.push(new EZ3.Vector3(this.max.x,this.min.y,this.min.z).mulMatrix4(a)),c.push(new EZ3.Vector3(this.max.x,this.min.y,this.max.z).mulMatrix4(a)),c.push(new EZ3.Vector3(this.max.x,this.max.y,this.min.z).mulMatrix4(a)),c.push(new EZ3.Vector3(this.max.x,this.max.y,this.max.z).mulMatrix4(a)),this.min.set(1/0),this.max.set(-(1/0)),b=0;8>b;b++)this.expand(c[b]);return this},EZ3.Box.prototype.getCenter=function(){return(new EZ3.Vector3).add(this.max,this.min).scale(.5)},EZ3.Box.prototype.set=function(a,b){return this.min.copy(a),this.max.copy(b),this},EZ3.Box.prototype.copy=function(a){return this.min.copy(a.min),this.max.copy(a.max),this},EZ3.Box.prototype.clone=function(){return new EZ3.Box(this.min,this.max)},EZ3.Euler=function(a,b,c,d){this._x=void 0!==a?a:0,this._y=void 0!==b?b:0,this._z=void 0!==c?c:0,this._order=void 0!==d?d:EZ3.Euler.XYZ,this.onChange=new EZ3.Signal},EZ3.Euler.prototype.constructor=EZ3.Euler,EZ3.Euler.prototype.set=function(a,b,c,d){return this._x=a,this._y=b,this._z=c,this._order=d||this._order,this.onChange.dispatch(),this},EZ3.Euler.prototype.clone=function(){return new this.constructor(this._x,this._y,this._z,this._order)},EZ3.Euler.prototype.copy=function(a){return this._x=a.x,this._y=a.y,this._z=a.z,this._order=a.order,this.onChange.dispatch(),this},EZ3.Euler.prototype.setFromRotationMatrix=function(a,b,c){var d=a.elements,e=d[0],f=d[1],g=d[2],h=d[4],i=d[5],j=d[6],k=d[8],l=d[9],m=d[10];return b=void 0!==b?b:this._order,b===EZ3.Euler.XYZ?(this._y=Math.asin(EZ3.Math.clamp(k,-1,1)),Math.abs(k)<.99999?(this._x=Math.atan2(-l,m),this._z=Math.atan2(-h,e)):(this._x=Math.atan2(j,i),this._z=0)):b===EZ3.Euler.YXZ?(this._x=Math.asin(-EZ3.Math.clamp(l,-1,1)),Math.abs(l)<.99999?(this._y=Math.atan2(k,m),this._z=Math.atan2(f,i)):(this._y=Math.atan2(-g,e),this._z=0)):b===EZ3.Euler.ZXY?(this._x=Math.asin(EZ3.Math.clamp(j,-1,1)),Math.abs(j)<.99999?(this._y=Math.atan2(-g,m),this._z=Math.atan2(-h,i)):(this._y=0,this._z=Math.atan2(f,e))):b===EZ3.Euler.ZYX?(this._y=Math.asin(-EZ3.Math.clamp(g,-1,1)),Math.abs(g)<.99999?(this._x=Math.atan2(j,m),this._z=Math.atan2(f,e)):(this._x=0,this._z=Math.atan2(-h,i))):b===EZ3.Euler.YZX?(this._z=Math.asin(EZ3.Math.clamp(f,-1,1)),Math.abs(f)<.99999?(this._x=Math.atan2(-l,i),this._y=Math.atan2(-g,e)):(this._x=0,this._y=Math.atan2(k,m))):b===EZ3.Euler.XZY&&(this._z=Math.asin(-EZ3.Math.clamp(h,-1,1)),Math.abs(h)<.99999?(this._x=Math.atan2(j,i),this._y=Math.atan2(k,e)):(this._x=Math.atan2(-l,m),this._y=0)),c&&this.onChange.dispatch(),this},EZ3.Euler.prototype.setFromQuaternion=function(a,b,c){return this.setFromRotationMatrix((new EZ3.Matrix4).setFromQuaternion(a),b,c)},EZ3.Euler.prototype.setFromVector3=function(a,b){return this._set(a.x,a.y,a.z,b)},EZ3.Euler.prototype.isEqual=function(a){return void 0!==a?this._x===a.x&&this._y===a.y&&this._z===a.z&&this._order===a.order:!1},EZ3.Euler.prototype.isDiff=function(a){return!this.isEqual(a)},EZ3.Euler.prototype.toVector3=function(){return new EZ3.Vector3(this._x,this._y,this._z)},EZ3.Euler.prototype.toString=function(){return"EZ3.Euler["+this._x+", "+this._y+", "+this._z+", "+this._order+"]";
},Object.defineProperty(EZ3.Euler.prototype,"x",{get:function(){return this._x},set:function(a){this._x=a,this.onChange.dispatch()}}),Object.defineProperty(EZ3.Euler.prototype,"y",{get:function(){return this._y},set:function(a){this._y=a,this.onChange.dispatch()}}),Object.defineProperty(EZ3.Euler.prototype,"z",{get:function(){return this._z},set:function(a){this._z=a,this.onChange.dispatch()}}),Object.defineProperty(EZ3.Euler.prototype,"order",{get:function(){return this._order},set:function(a){this._order=a,this.onChange.dispatch()}}),EZ3.Euler.XYZ=1,EZ3.Euler.YZX=2,EZ3.Euler.ZXY=3,EZ3.Euler.XZY=4,EZ3.Euler.YXZ=5,EZ3.Euler.ZYX=6,EZ3.Frustum=function(a,b,c,d,e,f){this.planes=[void 0!==a?a:new EZ3.Plane,void 0!==b?b:new EZ3.Plane,void 0!==c?c:new EZ3.Plane,void 0!==d?d:new EZ3.Plane,void 0!==e?e:new EZ3.Plane,void 0!==f?f:new EZ3.Plane]},EZ3.Frustum.prototype.constructor=EZ3.Frustum,EZ3.Frustum.prototype.set=function(a,b,c,d,e,f){var g=this.planes;return g[0].copy(a),g[1].copy(b),g[2].copy(c),g[3].copy(d),g[4].copy(e),g[5].copy(f),this},EZ3.Frustum.prototype.copy=function(a){for(var b=this.planes,c=0;6>c;c++)b[c].copy(a.planes[c]);return this},EZ3.Frustum.prototype.setFromMatrix4=function(a){var b=this.planes,c=a.elements,d=c[0],e=c[1],f=c[2],g=c[3],h=c[4],i=c[5],j=c[6],k=c[7],l=c[8],m=c[9],n=c[10],o=c[11],p=c[12],q=c[13],r=c[14],s=c[15];return b[0].set(new EZ3.Vector3(g-d,k-h,o-l),s-p).normalize(),b[1].set(new EZ3.Vector3(g+d,k+h,o+l),s+p).normalize(),b[2].set(new EZ3.Vector3(g+e,k+i,o+m),s+q).normalize(),b[3].set(new EZ3.Vector3(g-e,k-i,o-m),s-q).normalize(),b[4].set(new EZ3.Vector3(g-f,k-j,o-n),s-r).normalize(),b[5].set(new EZ3.Vector3(g+f,k+j,o+n),s+r).normalize(),this},EZ3.Frustum.prototype.intersectsMesh=function(a){var b=a.geometry,c=new EZ3.Sphere;return b.updateBoundingVolumes(),c.copy(b.boundingSphere),c.applyMatrix4(a.world),this.intersectsSphere(c)},EZ3.Frustum.prototype.intersectsSphere=function(a){for(var b=this.planes,c=a.center,d=-a.radius,e=0;6>e;e++)if(b[e].distanceToPoint(c)<d)return!1;return!0},EZ3.Frustum.prototype.intersectsBox=function(a){for(var b=new EZ3.Vector3,c=new EZ3.Vector3,d=this.planes,e=0;6>e;e++){var f=d[e];if(b.x=f.normal.x>0?a.min.x:a.max.x,c.x=f.normal.x>0?a.max.x:a.min.x,b.y=f.normal.y>0?a.min.y:a.max.y,c.y=f.normal.y>0?a.max.y:a.min.y,b.z=f.normal.z>0?a.min.z:a.max.z,c.z=f.normal.z>0?a.max.z:a.min.z,f.distanceToPoint(b)<0&&f.distanceToPoint(c)<0)return!1}return!0},EZ3.Math=function(){this.PI=Math.PI,this.HALF_PI=.5*this.PI,this.DOUBLE_PI=2*this.PI,this.MAX_UINT=Math.pow(2,32)-1,this.MAX_USHORT=Math.pow(2,16)-1},EZ3.Math=new EZ3.Math,EZ3.Math.isPowerOfTwo=function(a){return 0===(a&a-1)},EZ3.Math.toRadians=function(a){return a*EZ3.Math.PI/180},EZ3.Math.toDegrees=function(a){return 180*a/EZ3.Math.PI},EZ3.Math.nextHighestPowerOfTwo=function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1},EZ3.Math.clamp=function(a,b,c){return Math.min(c,Math.max(a,b))},EZ3.Matrix3=function(a){this.elements=null,"number"==typeof a?this.elements=[a,0,0,0,a,0,0,0,a]:a instanceof Array&&9===a.length?this.elements=[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8]]:this.identity()},EZ3.Matrix3.prototype.constructor=EZ3.Matrix3,EZ3.Matrix3.prototype.add=function(a,b){var c,d;return void 0!==b?(c=a.elements,d=b.elements):(c=this.elements,d=a.elements),this.elements[0]=c[0]+d[0],this.elements[1]=c[1]+d[1],this.elements[2]=c[2]+d[2],this.elements[3]=c[3]+d[3],this.elements[4]=c[4]+d[4],this.elements[5]=c[5]+d[5],this.elements[6]=c[6]+d[6],this.elements[7]=c[7]+d[7],this.elements[8]=c[8]+d[8],this},EZ3.Matrix3.prototype.sub=function(a,b){var c,d;return void 0!==b?(c=a.elements,d=b.elements):(c=this.elements,d=a.elements),this.elements[0]=c[0]-d[0],this.elements[1]=c[1]-d[1],this.elements[2]=c[2]-d[2],this.elements[3]=c[3]-d[3],this.elements[4]=c[4]-d[4],this.elements[5]=c[5]-d[5],this.elements[6]=c[6]-d[6],this.elements[7]=c[7]-d[7],this.elements[8]=c[8]-d[8],this},EZ3.Matrix3.prototype.scale=function(a,b){var c;return c=void 0!==b?b.elements:this.elements,this.elements[0]=c[0]*a,this.elements[1]=c[1]*a,this.elements[2]=c[2]*a,this.elements[3]=c[3]*a,this.elements[4]=c[4]*a,this.elements[5]=c[5]*a,this.elements[6]=c[6]*a,this.elements[7]=c[7]*a,this.elements[8]=c[8]*a,this},EZ3.Matrix3.prototype.mul=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=this.elements,w=a.elements;return void 0!==b?(c=b.elements,d=w[0],e=w[1],f=w[2],g=w[3],h=w[4],i=w[5],j=w[6],k=w[7],l=w[8],m=c[0],n=c[1],o=c[2],p=c[3],q=c[4],r=c[5],s=c[6],t=c[7],u=c[8]):(d=v[0],e=v[1],f=v[2],g=v[3],h=v[4],i=v[5],j=v[6],k=v[7],l=v[8],m=w[0],n=w[1],o=w[2],p=w[3],q=w[4],r=w[5],s=w[6],t=w[7],u=w[8]),this.elements[0]=d*m+e*p+f*s,this.elements[1]=d*n+e*q+f*t,this.elements[2]=d*o+e*r+f*u,this.elements[3]=g*m+h*p+i*s,this.elements[4]=g*n+h*q+i*t,this.elements[5]=g*o+h*r+i*u,this.elements[6]=j*m+k*p+l*s,this.elements[7]=j*n+k*q+l*t,this.elements[8]=j*o+k*r+l*u,this},EZ3.Matrix3.prototype.transpose=function(a){var b,c=void 0!==a?a.elements:this.elements;return b=c[1],c[1]=c[3],c[3]=b,b=c[2],c[2]=c[6],c[6]=b,b=c[5],c[5]=c[7],c[7]=b,this.elements[0]=c[0],this.elements[1]=c[1],this.elements[2]=c[2],this.elements[3]=c[3],this.elements[4]=c[4],this.elements[5]=c[5],this.elements[6]=c[6],this.elements[7]=c[7],this.elements[8]=c[8],this},EZ3.Matrix3.prototype.setFromQuaternion=function(a){var b=2*a.x,c=2*a.y,d=2*a.z,e=a.x*b,f=a.y*c,g=a.z*d,h=a.x*c,i=a.y*d,j=a.x*d,k=a.s*b,l=a.s*c,m=a.s*d;return this.elements[0]=1-f-g,this.elements[1]=h-m,this.elements[2]=j+l,this.elements[3]=h+m,this.elements[4]=1-e-g,this.elements[5]=i-k,this.elements[6]=j-l,this.elements[7]=i+k,this.elements[8]=1-e-f,this},EZ3.Matrix3.prototype.inverse=function(a){var b,c=a.elements;return this.elements[0]=c[10]*c[5]-c[6]*c[9],this.elements[1]=-c[10]*c[1]+c[2]*c[9],this.elements[2]=c[6]*c[1]-c[2]*c[5],this.elements[3]=-c[10]*c[4]+c[6]*c[8],this.elements[4]=c[10]*c[0]-c[2]*c[8],this.elements[5]=-c[6]*c[0]+c[2]*c[4],this.elements[6]=c[9]*c[4]-c[5]*c[8],this.elements[7]=-c[9]*c[0]+c[1]*c[8],this.elements[8]=c[5]*c[0]-c[1]*c[4],b=c[0]*this.elements[0]+c[1]*this.elements[3]+c[2]*this.elements[6],0===b?this.identity():(this.scale(1/b),this)},EZ3.Matrix3.prototype.normalFromMat4=function(a){return this.inverse(a).transpose(),this},EZ3.Matrix3.prototype.identity=function(){return this.elements=[1,0,0,0,1,0,0,0,1],this},EZ3.Matrix3.prototype.clone=function(){return new EZ3.Matrix3(this.elements)},EZ3.Matrix3.prototype.copy=function(a){return this.elements=a.elements,this},EZ3.Matrix3.prototype.toArray=function(){return this.elements},EZ3.Matrix3.prototype.toString=function(){return"Matrix3[\n"+this.elements[0].toFixed(4)+", "+this.elements[3].toFixed(4)+", "+this.elements[6].toFixed(4)+"\n"+this.elements[1].toFixed(4)+", "+this.elements[4].toFixed(4)+", "+this.elements[7].toFixed(4)+"\n"+this.elements[2].toFixed(4)+", "+this.elements[5].toFixed(4)+", "+this.elements[8].toFixed(4)+"\n]"},EZ3.Matrix3.prototype.isEqual=function(a){return void 0!==a?a.elements[0]===this.elements[0]&&a.elements[1]===this.elements[1]&&a.elements[2]===this.elements[2]&&a.elements[3]===this.elements[3]&&a.elements[4]===this.elements[4]&&a.elements[5]===this.elements[5]&&a.elements[6]===this.elements[6]&&a.elements[7]===this.elements[7]&&a.elements[8]===this.elements[8]:!1},EZ3.Matrix3.prototype.isDiff=function(a){return!this.isEqual(a)},EZ3.Matrix4=function(a){this.elements=null,"number"==typeof a?this.elements=[a,0,0,0,0,a,0,0,0,0,a,0,0,0,0,a]:a instanceof Array&&16===a.length?this.elements=[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]]:this.identity()},EZ3.Matrix4.prototype.constructor=EZ3.Matrix4,EZ3.Matrix4.prototype.transpose=function(a){var b,c,d,e,f,g,h;return void 0!==a?(h=a.elements,b=h[1],c=h[2],d=h[3],e=h[6],f=h[7],g=h[11],this.elements[1]=h[4],this.elements[2]=h[8],this.elements[3]=h[12],this.elements[4]=b,this.elements[6]=h[9],this.elements[7]=h[13],this.elements[8]=c,this.elements[9]=e,this.elements[11]=h[14],this.elements[12]=d,this.elements[13]=f,this.elements[14]=g):(h=this.elements,this.elements[0]=h[0],this.elements[1]=h[4],this.elements[2]=h[8],this.elements[3]=h[12],this.elements[4]=h[1],this.elements[5]=h[5],this.elements[6]=h[9],this.elements[7]=h[13],this.elements[8]=h[2],this.elements[9]=h[6],this.elements[10]=h[10],this.elements[11]=h[14],this.elements[12]=h[3],this.elements[13]=h[7],this.elements[14]=h[11],this.elements[15]=h[15]),this},EZ3.Matrix4.prototype.inverse=function(a){var b=this.elements,c=void 0!==a?a.elements:this.elements,d=c[0],e=c[4],f=c[8],g=c[12],h=c[1],i=c[5],j=c[9],k=c[13],l=c[2],m=c[6],n=c[10],o=c[14],p=c[3],q=c[7],r=c[11],s=c[15];b[0]=j*o*q-k*n*q+k*m*r-i*o*r-j*m*s+i*n*s,b[4]=g*n*q-f*o*q-g*m*r+e*o*r+f*m*s-e*n*s,b[8]=f*k*q-g*j*q+g*i*r-e*k*r-f*i*s+e*j*s,b[12]=g*j*m-f*k*m-g*i*n+e*k*n+f*i*o-e*j*o,b[1]=k*n*p-j*o*p-k*l*r+h*o*r+j*l*s-h*n*s,b[5]=f*o*p-g*n*p+g*l*r-d*o*r-f*l*s+d*n*s,b[9]=g*j*p-f*k*p-g*h*r+d*k*r+f*h*s-d*j*s,b[13]=f*k*l-g*j*l+g*h*n-d*k*n-f*h*o+d*j*o,b[2]=i*o*p-k*m*p+k*l*q-h*o*q-i*l*s+h*m*s,b[6]=g*m*p-e*o*p-g*l*q+d*o*q+e*l*s-d*m*s,b[10]=e*k*p-g*i*p+g*h*q-d*k*q-e*h*s+d*i*s,b[14]=g*i*l-e*k*l-g*h*m+d*k*m+e*h*o-d*i*o,b[3]=j*m*p-i*n*p-j*l*q+h*n*q+i*l*r-h*m*r,b[7]=e*n*p-f*m*p+f*l*q-d*n*q-e*l*r+d*m*r,b[11]=f*i*p-e*j*p-f*h*q+d*j*q+e*h*r-d*i*r,b[15]=e*j*l-f*i*l+f*h*m-d*j*m-e*h*n+d*i*n;var t=d*b[0]+h*b[4]+l*b[8]+p*b[12];return t?(this.multiplyScalar(1/t),this):this.identity},EZ3.Matrix4.prototype.multiplyScalar=function(a){var b=this.elements;return b[0]*=a,b[4]*=a,b[8]*=a,b[12]*=a,b[1]*=a,b[5]*=a,b[9]*=a,b[13]*=a,b[2]*=a,b[6]*=a,b[10]*=a,b[14]*=a,b[3]*=a,b[7]*=a,b[11]*=a,b[15]*=a,this},EZ3.Matrix4.prototype.mul=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;return void 0!==b?(c=b.elements,d=a.elements):(c=a.elements,d=this.elements),e=c[0],f=c[1],g=c[2],h=c[3],i=c[4],j=c[5],k=c[6],l=c[7],m=c[8],n=c[9],o=c[10],p=c[11],q=c[12],r=c[13],s=c[14],t=c[15],u=d[0],v=d[1],w=d[2],x=d[3],y=d[4],z=d[5],A=d[6],B=d[7],C=d[8],D=d[9],E=d[10],F=d[11],G=d[12],H=d[13],I=d[14],J=d[15],this.elements[0]=e*u+f*y+g*C+h*G,this.elements[1]=e*v+f*z+g*D+h*H,this.elements[2]=e*w+f*A+g*E+h*I,this.elements[3]=e*x+f*B+g*F+h*J,this.elements[4]=i*u+j*y+k*C+l*G,this.elements[5]=i*v+j*z+k*D+l*H,this.elements[6]=i*w+j*A+k*E+l*I,this.elements[7]=i*x+j*B+k*F+l*J,this.elements[8]=m*u+n*y+o*C+p*G,this.elements[9]=m*v+n*z+o*D+p*H,this.elements[10]=m*w+n*A+o*E+p*I,this.elements[11]=m*x+n*B+o*F+p*J,this.elements[12]=q*u+r*y+s*C+t*G,this.elements[13]=q*v+r*z+s*D+t*H,this.elements[14]=q*w+r*A+s*E+t*I,this.elements[15]=q*x+r*B+s*F+t*J,this},EZ3.Matrix4.prototype.setPosition=function(a,b){var c=void 0!==b?b.elements:this.elements,d=a.x,e=a.y,f=a.z;return c[12]=d,c[13]=e,c[14]=f,this},EZ3.Matrix4.prototype.translate=function(a,b){var c=void 0!==b?b.elements:this.elements,d=a.x,e=a.y,f=a.z,g=c[0],h=c[1],i=c[2],j=c[3],k=c[4],l=c[5],m=c[6],n=c[7],o=c[8],p=c[9],q=c[10],r=c[11];return this.elements[0]=g,this.elements[1]=h,this.elements[2]=i,this.elements[3]=j,this.elements[4]=k,this.elements[5]=l,this.elements[6]=m,this.elements[7]=n,this.elements[8]=o,this.elements[9]=p,this.elements[10]=q,this.elements[11]=r,this.elements[12]=g*d+k*e+o*f+this.elements[12],this.elements[13]=h*d+l*e+p*f+this.elements[13],this.elements[14]=i*d+m*e+q*f+this.elements[14],this.elements[15]=j*d+n*e+r*f+this.elements[15],this},EZ3.Matrix4.prototype.scale=function(a,b){var c=a.x,d=a.y,e=a.z,f=void 0!==b?b.elements:this.elements;return this.elements[0]=f[0]*c,this.elements[1]=f[1]*c,this.elements[2]=f[2]*c,this.elements[3]=f[3]*c,this.elements[4]=f[4]*d,this.elements[5]=f[5]*d,this.elements[6]=f[6]*d,this.elements[7]=f[7]*d,this.elements[8]=f[8]*e,this.elements[9]=f[9]*e,this.elements[10]=f[10]*e,this.elements[11]=f[11]*e,this.elements[12]=f[12],this.elements[13]=f[13],this.elements[14]=f[14],this.elements[15]=f[15],this},EZ3.Matrix4.prototype.setFromQuaternion=function(a){var b=2*a.x,c=2*a.y,d=2*a.z,e=a.x*b,f=a.y*c,g=a.z*d,h=a.x*c,i=a.y*d,j=a.x*d,k=a.w*b,l=a.w*c,m=a.w*d;return this.elements[0]=1-f-g,this.elements[1]=h-m,this.elements[2]=j+l,this.elements[3]=0,this.elements[4]=h+m,this.elements[5]=1-e-g,this.elements[6]=i-k,this.elements[7]=0,this.elements[8]=j-l,this.elements[9]=i+k,this.elements[10]=1-e-f,this.elements[11]=0,this.elements[12]=0,this.elements[13]=0,this.elements[14]=0,this.elements[15]=1,this},EZ3.Matrix4.prototype.frustum=function(a,b,c,d,e,f){var g=this.elements,h=2*e/(b-a),i=2*e/(d-c),j=(b+a)/(b-a),k=(d+c)/(d-c),l=-(f+e)/(f-e),m=-2*f*e/(f-e);return g[0]=h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=i,g[6]=0,g[7]=0,g[8]=j,g[9]=k,g[10]=l,g[11]=-1,g[12]=0,g[13]=0,g[14]=m,g[15]=0,this},EZ3.Matrix4.prototype.perspective=function(a,b,c,d){var e=c*Math.tan(EZ3.Math.toRadians(.5*a)),f=-e,g=e*b,h=f*b;return this.frustum(h,g,f,e,c,d)},EZ3.Matrix4.prototype.orthographic=function(a,b,c,d,e,f){var g=b-a,h=c-d,i=f-e,j=(b+a)/g,k=(c+d)/h,l=(f+e)/i;return this.elements[0]=2/g,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=0,this.elements[5]=2/h,this.elements[6]=0,this.elements[7]=0,this.elements[8]=0,this.elements[9]=0,this.elements[10]=-2/i,this.elements[11]=0,this.elements[12]=-j,this.elements[13]=-k,this.elements[14]=-l,this.elements[15]=1,this},EZ3.Matrix4.prototype.lookAt=function(a,b,c){var d=this.elements,e=new EZ3.Vector3,f=new EZ3.Vector3,g=new EZ3.Vector3;return g.sub(a,b).normalize(),0===g.length()&&(g.z=1),e.cross(c,g).normalize(),0===e.length()&&(g.x+=1e-4,e.cross(c,g).normalize()),f.cross(g,e),d[0]=e.x,d[1]=f.x,d[2]=g.x,d[3]=0,d[4]=e.y,d[5]=f.y,d[6]=g.y,d[7]=0,d[8]=e.z,d[9]=f.z,d[10]=g.z,d[11]=0,d[12]=-e.dot(a),d[13]=-f.dot(a),d[14]=-g.dot(a),d[15]=1,this},EZ3.Matrix4.prototype.identity=function(){return this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this},EZ3.Matrix4.prototype.yawPitchRoll=function(a,b,c){var d=Math.cos(a),e=Math.sin(a),f=Math.cos(c),g=Math.sin(c),h=Math.cos(b),i=Math.sin(b);return this.elements[0]=d*f+e*i*g,this.elements[1]=g*h,this.elements[2]=-e*f+d*i*g,this.elements[3]=0,this.elements[4]=-d*g+e*i*f,this.elements[5]=f*h,this.elements[6]=g*e+d*i*f,this.elements[7]=0,this.elements[8]=e*h,this.elements[9]=-i,this.elements[10]=d*h,this.elements[11]=0,this.elements[12]=0,this.elements[13]=0,this.elements[14]=0,this.elements[15]=1,this},EZ3.Matrix4.prototype.determinant=function(){var a=this.elements,b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return e*(n*k*h-j*o*h-n*g*l+f*o*l+j*g*p-f*k*p)+i*(b*k*p-b*o*l+n*c*l-j*c*p+j*o*d-n*k*d)+m*(b*o*h-b*g*p-n*c*h+f*c*p+n*g*d-f*o*d)+q*(-j*g*d-b*k*h+b*g*l+j*c*h-f*c*l+f*k*d)},EZ3.Matrix4.prototype.compose=function(a,b,c){return this.setFromQuaternion(b),this.setPosition(a),this.scale(c),this},EZ3.Matrix4.prototype.getPosition=function(){var a=this.elements,b=new EZ3.Vector3(a[12],a[13],a[14]);return b},EZ3.Matrix4.prototype.getRotation=function(){var a,b,c,d=this.getScale(),e=new EZ3.Matrix4(this.elements);return this.determinant()<0&&(d.x=-d.x),a=1/d.x,b=1/d.y,c=1/d.z,e.elements[0]*=a,e.elements[1]*=a,e.elements[2]*=a,e.elements[4]*=b,e.elements[5]*=b,e.elements[6]*=b,e.elements[8]*=c,e.elements[9]*=c,e.elements[10]*=c,(new EZ3.Quaternion).setFromRotationMatrix(e)},EZ3.Matrix4.prototype.getScale=function(){var a=this.elements,b=new EZ3.Vector3,c=new EZ3.Vector3;return b.x=c.set(a[0],a[1],a[2]).length(),b.y=c.set(a[4],a[5],a[6]).length(),b.z=c.set(a[8],a[9],a[10]).length(),b},EZ3.Matrix4.prototype.getMaxScaleOnAxis=function(){var a=this.getScale();return Math.max(a.x,a.y,a.z)},EZ3.Matrix4.prototype.clone=function(){return new EZ3.Matrix4(this.toArray())},EZ3.Matrix4.prototype.copy=function(a){return this.elements[0]=a.elements[0],this.elements[1]=a.elements[1],this.elements[2]=a.elements[2],this.elements[3]=a.elements[3],this.elements[4]=a.elements[4],this.elements[5]=a.elements[5],this.elements[6]=a.elements[6],this.elements[7]=a.elements[7],this.elements[8]=a.elements[8],this.elements[9]=a.elements[9],this.elements[10]=a.elements[10],this.elements[11]=a.elements[11],this.elements[12]=a.elements[12],this.elements[13]=a.elements[13],this.elements[14]=a.elements[14],this.elements[15]=a.elements[15],this},EZ3.Matrix4.prototype.toArray=function(){return this.elements},EZ3.Matrix4.prototype.toString=function(){return"Matrix4[\n"+this.elements[0].toFixed(4)+", "+this.elements[4].toFixed(4)+", "+this.elements[8].toFixed(4)+", "+this.elements[12].toFixed(4)+"\n"+this.elements[1].toFixed(4)+", "+this.elements[5].toFixed(4)+", "+this.elements[9].toFixed(4)+", "+this.elements[13].toFixed(4)+"\n"+this.elements[2].toFixed(4)+", "+this.elements[6].toFixed(4)+", "+this.elements[10].toFixed(4)+", "+this.elements[14].toFixed(4)+"\n"+this.elements[3].toFixed(4)+", "+this.elements[7].toFixed(4)+", "+this.elements[11].toFixed(4)+", "+this.elements[15].toFixed(4)+"\n]"},EZ3.Matrix4.prototype.toMatrix3=function(a){var b=void 0!==a?a.elements:this.elements,c=new EZ3.Matrix3;return c.elements=[b[0],b[3],b[6],b[1],b[4],b[7],b[2],b[5],b[8]],c},EZ3.Matrix4.prototype.isEqual=function(a){return void 0!==a?a.elements[0]===this.elements[0]&&a.elements[1]===this.elements[1]&&a.elements[2]===this.elements[2]&&a.elements[3]===this.elements[3]&&a.elements[4]===this.elements[4]&&a.elements[5]===this.elements[5]&&a.elements[6]===this.elements[6]&&a.elements[7]===this.elements[7]&&a.elements[8]===this.elements[8]&&a.elements[9]===this.elements[9]&&a.elements[10]===this.elements[10]&&a.elements[11]===this.elements[11]&&a.elements[12]===this.elements[12]&&a.elements[13]===this.elements[13]&&a.elements[14]===this.elements[14]&&a.elements[15]===this.elements[15]:!1},EZ3.Matrix4.prototype.isDiff=function(a){return!this.isEqual(a)},EZ3.Plane=function(a,b){this.normal=void 0!==a?a:new EZ3.Vector3(1,0,0),this.constant=void 0!==b?b:0},EZ3.Plane.prototype.constructor=EZ3.Plane,EZ3.Plane.prototype.distanceToPoint=function(a){return this.normal.dot(a)+this.constant},EZ3.Plane.prototype.normalize=function(){var a=1/this.normal.length();return this.normal.scale(a),this.constant*=a,this},EZ3.Plane.prototype.set=function(a,b){return this.normal.copy(a),this.constant=b,this},EZ3.Plane.prototype.copy=function(a){return this.normal.copy(a.normal),this.constant=a.constant,this},EZ3.Quaternion=function(a,b,c,d){this._x=void 0!==a?a:0,this._y=void 0!==b?b:0,this._z=void 0!==c?c:0,this._w=void 0!==d?d:1,this.onChange=new EZ3.Signal},EZ3.Quaternion.prototype.constructor=EZ3.Quaternion,EZ3.Quaternion.prototype.add=function(a,b){return void 0!==b?(this._w=a.w+b.w,this._x=a.x+b.x,this._y=a.y+b.y,this._z=a.z+b.z):(this._w+=a.w,this._x+=a.x,this._y+=a.y,this._z+=a.z),this.onChange.dispatch(),this},EZ3.Quaternion.prototype.sub=function(a,b){return void 0!==b?(this._w=a.w-b.w,this._x=a.x-b.x,this._y=a.y-b.y,this._z=a.z-b.z):(this._w-=a.w,this._x-=a.x,this._y-=a.y,this._z-=a.z),this.onChange.dispatch(),this},EZ3.Quaternion.prototype.scale=function(a,b){return void 0!==b?(this._x=b.x*a,this._y=b.y*a,this._z=b.z*a,this._w=b.w*a):(this._x*=a,this._y*=a,this._z*=a,this._w*=a),this.onChange.dispatch(),this},EZ3.Quaternion.prototype.mul=function(a,b){var c,d,e,f,g,h,i,j;return c=a.x,d=a.y,e=a.z,f=a.w,void 0!==b?(g=b.x,h=b.y,i=b.z,j=b.w):(g=this._x,h=this._y,i=this._z,j=this._w),this._x=c*j+f*g+d*i-e*h,this._y=d*j+f*h+e*g-c*i,this._z=e*j+f*i+c*h-d*g,this._w=f*j-c*g-d*h-e*i,this.onChange.dispatch(),this},EZ3.Quaternion.prototype.normalize=function(a){var b,c,d,e,f;return void 0!==a?(b=Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z+a.w*a.w),b>0?(b=1/b,a.scale(b),this._x=a.x,this._y=a.y,this._z=a.z,this._w=a.w):(this._x=0,this._y=0,this._z=0,this._w=1)):(d=this._x*this._x,e=this._y*this._y,f=this._z*this._z,c=this._w*this._w,b=Math.sqrt(c+d+e+f),b>0?(b=1/b,this._scale(b)):(this._x=0,this._y=0,this._z=0,this._w=1)),this.onChange.dispatch(),this},EZ3.Quaternion.prototype.inverse=function(a){return void 0!==a?(this._x=-a.x,this._y=-a.y,this._z=-a.z,this._w=a.w):(this._x=-this._x,this._y=-this._y,this._z=-this._z,this._w=this._w),this.onChange.dispatch(),this},EZ3.Quaternion.prototype.length=function(){var a=this._x*this._x,b=this._y*this._y,c=this._z*this._z,d=this._w*this._w;return Math.sqrt(d+a+b+c)},EZ3.Quaternion.prototype.set=function(a,b,c,d){return this._x=a,this._y=b,this._z=c,this._w=d,this.onChange.dispatch(),this},EZ3.Quaternion.prototype.copy=function(a){return this._x=a.x,this._y=a.y,this._z=a.z,this._w=a.w,this.onChange.dispatch(),this},EZ3.Quaternion.prototype.clone=function(){return new EZ3.Quaternion(this._x,this._y,this._z,this._w)},EZ3.Quaternion.prototype.isEqual=function(a){return void 0!==a?this.x===a.x&&this.y===a.y&&this.z===a.z&&this.w===a.w:!1},EZ3.Quaternion.prototype.isDiff=function(a){return!this.isEqual(a)},EZ3.Quaternion.prototype.setFromAxisAngle=function(a,b){var c=Math.sin(.5*b);return this._x=c*a.x,this._y=c*a.y,this._z=c*a.z,this._w=Math.cos(.5*b),this.onChange.dispatch(),this},EZ3.Quaternion.prototype.setFromRotationMatrix=function(a){var b,c=a.elements,d=c[0],e=c[4],f=c[8],g=c[1],h=c[5],i=c[9],j=c[2],k=c[6],l=c[10],m=d+h+l;return m>0?(b=.5/Math.sqrt(m+1),this._w=.25/b,this._x=(k-i)*b,this._y=(f-j)*b,this._z=(g-e)*b):d>h&&d>l?(b=2*Math.sqrt(1+d-h-l),this._w=(k-i)/b,this._x=.25*b,this._y=(e+g)/b,this._z=(f+j)/b):h>l?(b=2*Math.sqrt(1+h-d-l),this._w=(f-j)/b,this._x=(e+g)/b,this._y=.25*b,this._z=(i+k)/b):(b=2*Math.sqrt(1+l-d-h),this._w=(g-e)/b,this._x=(f+j)/b,this._y=(i+k)/b,this._z=.25*b),this.onChange.dispatch(),this},EZ3.Quaternion.prototype.setFromEuler=function(a,b){var c=Math.cos(a.x/2),d=Math.cos(a.y/2),e=Math.cos(a.z/2),f=Math.sin(a.x/2),g=Math.sin(a.y/2),h=Math.sin(a.z/2),i=a.order;return i===EZ3.Euler.XYZ?(this._x=f*d*e+c*g*h,this._y=c*g*e-f*d*h,this._z=c*d*h+f*g*e,this._w=c*d*e-f*g*h):i===EZ3.Euler.YXZ?(this._x=f*d*e+c*g*h,this._y=c*g*e-f*d*h,this._z=c*d*h-f*g*e,this._w=c*d*e+f*g*h):i===EZ3.Euler.ZXY?(this._x=f*d*e-c*g*h,this._y=c*g*e+f*d*h,this._z=c*d*h+f*g*e,this._w=c*d*e-f*g*h):i===EZ3.Euler.ZYX?(this._x=f*d*e-c*g*h,this._y=c*g*e+f*d*h,this._z=c*d*h-f*g*e,this._w=c*d*e+f*g*h):i===EZ3.Euler.YZX?(this._x=f*d*e+c*g*h,this._y=c*g*e+f*d*h,this._z=c*d*h-f*g*e,this._w=c*d*e-f*g*h):i===EZ3.Euler.XZY&&(this._x=f*d*e-c*g*h,this._y=c*g*e-f*d*h,this._z=c*d*h+f*g*e,this._w=c*d*e+f*g*h),b&&this.onChange.dispatch(),this},EZ3.Quaternion.prototype.toMatrix3=function(a,b){var c,d,e,f,g,h,i,j,k,l=new EZ3.Matrix3;return void 0!==b?(c=2*b.y*b.y,d=2*b.x*b.y,e=2*b.x*b.z,f=2*b.y*b.z,g=2*b.z*b.z,h=2*b.w*b.z,i=2*b.w*b.y,j=2*b.w*b.x,k=2*b.x*b.x):(c=2*this._y*this._y,d=2*this._x*this._y,e=2*this._x*this._z,f=2*this._y*this._z,g=2*this._z*this._z,h=2*this._w*this._z,i=2*this._w*this._y,j=2*this._w*this._x,k=2*this._x*this._x),l.elements[0]=-c-g+1,l.elements[1]=d-a*h,l.elements[2]=e+a*i,l.elements[3]=d+a*h,l.elements[4]=-k-g+1,l.elements[5]=f-a*j,l.elements[6]=e-a*i,l.elements[7]=f+a*j,l.elements[8]=-k-c+1,l},EZ3.Quaternion.prototype.toString=function(){var a=this._x.toFixed(4),b=this._y.toFixed(4),c=this._z.toFixed(4),d=this._w.toFixed(4);return"Quaternion["+a+", "+b+", "+c+", "+d+" ]"},Object.defineProperty(EZ3.Quaternion.prototype,"x",{get:function(){return this._x},set:function(a){this._x=a,this.onChange.dispatch()}}),Object.defineProperty(EZ3.Quaternion.prototype,"y",{get:function(){return this._y},set:function(a){this._y=a,this.onChange.dispatch()}}),Object.defineProperty(EZ3.Quaternion.prototype,"z",{get:function(){return this._z},set:function(a){this._z=a,this.onChange.dispatch()}}),Object.defineProperty(EZ3.Quaternion.prototype,"w",{get:function(){return this._w},set:function(a){this._w=a,this.onChange.dispatch()}}),EZ3.Sphere=function(a,b){this.center=void 0!==a?a:new EZ3.Vector3,this.radius=void 0!==b?b:0},EZ3.Sphere.prototype.constructor=EZ3.Sphere,EZ3.Sphere.prototype.applyMatrix4=function(a){return this.center.mulMatrix4(a),this.radius=this.radius*a.getMaxScaleOnAxis(),this},EZ3.Sphere.prototype.set=function(a,b){return this.center.copy(a),this.radius=b,this},EZ3.Sphere.prototype.copy=function(a){return this.center.copy(a.center),this.radius=a.radius,this},EZ3.Sphere.prototype.clone=function(){return new EZ3.Sphere(this.center,this.radius)},EZ3.Vector2=function(a,b){void 0!==a?(this.x=a,this.y=void 0!==b?b:a):(this.x=0,this.y=0)},EZ3.Vector2.prototype.constructor=EZ3.Vector2,EZ3.Vector2.prototype.add=function(a,b){return void 0!==b?(this.x=a.x+b.x,this.y=a.y+b.y):(this.x+=a.x,this.y+=a.y),this},EZ3.Vector2.prototype.sub=function(a,b){return void 0!==b?(this.x=a.x-b.x,this.y=a.y-b.y):(this.x-=a.x,this.y-=a.y),this},EZ3.Vector2.prototype.set=function(a,b){return this.x=a,this.y=b,this},EZ3.Vector2.prototype.scale=function(a,b){return void 0!==b?(this.x=b.x*a,this.y=b.y*a):(this.x*=a,this.y*=a),this},EZ3.Vector2.prototype.dot=function(a){return void 0!==a?a.x*this.x+a.y*this.y:-1},EZ3.Vector2.prototype.max=function(a,b){return void 0!==b?(this.x=a.x>b.x?a.x:b.x,this.y=a.y>b.y?a.y:b.y):(this.x<a.x&&(this.x=a.x),this.y<a.y&&(this.y=a.y)),this},EZ3.Vector2.prototype.min=function(a,b){return void 0!==b?(this.x=a.x<b.x?a.x:b.x,this.y=a.y<b.y?a.y:b.y):(this.x>a.x&&(this.x=a.x),this.y>a.y&&(this.y=a.y)),this},EZ3.Vector2.prototype.length=function(){return Math.sqrt(this.dot(this))},EZ3.Vector2.prototype.normalize=function(a){var b;return void 0!==a?(b=a.length(),b>0?(b=1/b,a.scale(b),this.x=a.x,this.y=a.y):(this.x=0,this.y=0)):(b=this.length(),b>0?(b=1/b,this.scale(b)):(this.x=0,this.y=0)),this},EZ3.Vector2.prototype.negate=function(a){return void 0!==a?(this.x=-a.x,this.y=-a.y):(this.x=-this.x,this.y=-this.y),this},EZ3.Vector2.prototype.copy=function(a){return this.x=a.x,this.y=a.y,this},EZ3.Vector2.prototype.clone=function(){return new EZ3.Vector2(this.x,this.y)},EZ3.Vector2.prototype.isEqual=function(a){return void 0!==a?this.x===a.x&&this.y===a.y:!1},EZ3.Vector2.prototype.isDiff=function(a){return!this.isEqual(a)},EZ3.Vector2.prototype.isZeroVector=function(a){return void 0!==a?0===a.x&&0===a.y:0===this.x&&0===this.y},EZ3.Vector2.prototype.toArray=function(){return[this.x,this.y]},EZ3.Vector2.prototype.toString=function(){return"Vector2["+this.x.toFixed(4)+", "+this.y.toFixed(4)+"]"},EZ3.Vector3=function(a,b,c){"number"==typeof a?(this.x=a,this.y="number"==typeof b?b:a,this.z="number"==typeof c?c:a):(this.x=0,this.y=0,this.z=0)},EZ3.Vector3.prototype.constructor=EZ3.Vector3,EZ3.Vector3.prototype.add=function(a,b){return void 0!==b?(this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z):(this.x+=a.x,this.y+=a.y,this.z+=a.z),this},EZ3.Vector3.prototype.sub=function(a,b){return void 0!==b?(this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z):(this.x-=a.x,this.y-=a.y,this.z-=a.z),this},EZ3.Vector3.prototype.set=function(a,b,c){return this.x=a,this.y="number"==typeof b?b:a,this.z="number"==typeof c?c:a,this},EZ3.Vector3.prototype.scale=function(a,b){return void 0!==b?(this.x=b.x*a,this.y=b.y*a,this.z=b.z*a):(this.x*=a,this.y*=a,this.z*=a),this},EZ3.Vector3.prototype.dot=function(a){return void 0!==a?a.x*this.x+a.y*this.y+a.z*this.z:-1},EZ3.Vector3.prototype.max=function(a,b){return void 0!==b?(this.x=a.x>b.x?a.x:b.x,this.y=a.y>b.y?a.y:b.y,this.z=a.z>b.z?a.z:b.z):(this.x<a.x&&(this.x=a.x),this.y<a.y&&(this.y=a.y),this.z<a.z&&(this.z=a.z)),this},EZ3.Vector3.prototype.min=function(a,b){return void 0!==b?(this.x=a.x<b.x?a.x:b.x,this.y=a.y<b.y?a.y:b.y,this.z=a.z<b.z?a.z:b.z):(this.x>a.x&&(this.x=a.x),this.y>a.y&&(this.y=a.y),this.z>a.z&&(this.z=a.z)),this},EZ3.Vector3.prototype.cross=function(a,b){var c,d,e;return void 0!==b?(c=a.y*b.z-a.z*b.y,d=a.z*b.x-a.x*b.z,e=a.x*b.y-a.y*b.x):(c=a.y*this.z-a.z*this.y,d=a.z*this.x-a.x*this.z,e=a.x*this.y-a.y*this.x),this.x=c,this.y=d,this.z=e,this},EZ3.Vector3.prototype.mulMatrix3=function(a,b){var c,d,e,f=a.elements;return void 0!==b?(c=b.x,d=b.y,e=b.z):(c=this.x,d=this.y,e=this.z),this.x=c*f[0]+d*f[3]+e*f[6],this.y=c*f[1]+d*f[4]+e*f[7],this.z=c*f[2]+d*f[5]+e*f[8],this},EZ3.Vector3.prototype.mulMatrix4=function(a,b){var c,d,e,f=a.elements;return void 0!==b?(c=b.x,d=b.y,e=b.z):(c=this.x,d=this.y,e=this.z),this.x=c*f[0]+d*f[4]+e*f[8]+f[12],this.y=c*f[1]+d*f[5]+e*f[9]+f[13],this.z=c*f[2]+d*f[6]+e*f[10]+f[14],this},EZ3.Vector3.prototype.mulQuaternion=function(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,g=a.z,h=a.w,i=h*b+f*d-g*c,j=h*c+g*b-e*d,k=h*d+e*c-f*b,l=-e*b-f*c-g*d;return this.x=i*h+l*-e+j*-g-k*-f,this.y=j*h+l*-f+k*-e-i*-g,this.z=k*h+l*-g+i*-f-j*-e,this},EZ3.Vector3.prototype.length=function(){return Math.sqrt(this.dot(this))},EZ3.Vector3.prototype.distance=function(a,b){var c,d,e;return void 0!==b?(c=a.x-b.x,d=a.y-b.y,e=a.z-b.z):(c=this.x-a.x,d=this.y-a.y,e=this.z-a.z),Math.sqrt(c*c+d*d+e*e)},EZ3.Vector3.prototype.normalize=function(a){var b;return void 0!==a?(b=a.length(),b>0?(a.scale(1/b),this.x=a.x,this.y=a.y,this.z=a.z):(this.x=0,this.y=0,this.z=0),this):(b=this.length(),b>0?(this.scale(1/b),this):void 0)},EZ3.Vector3.prototype.negate=function(a){return void 0!==a?(this.x=-a.x,this.y=-a.y,this.z=-a.z):(this.x=-this.x,this.y=-this.y,this.z=-this.z),this},EZ3.Vector3.prototype.clone=function(){return new EZ3.Vector3(this.x,this.y,this.z)},EZ3.Vector3.prototype.copy=function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this},EZ3.Vector3.prototype.setPositionFromWorldMatrix=function(a){return void 0!==a&&(this.x=a.elements[12],this.y=a.elements[13],this.z=a.elements[14]),this},EZ3.Vector3.prototype.setFromViewProjectionMatrix=function(a){var b=a.elements,c=this.x,d=this.y,e=this.z,f=1/(b[3]*c+b[7]*d+b[11]*e+b[15]);return this.x=(b[0]*c+b[4]*d+b[8]*e+b[12])*f,this.y=(b[1]*c+b[5]*d+b[9]*e+b[13])*f,this.z=(b[2]*c+b[6]*d+b[10]*e+b[14])*f,this},EZ3.Vector3.prototype.isEqual=function(a){return void 0!==a?this.x===a.x&&this.y===a.y&&this.z===a.z:!1},EZ3.Vector3.prototype.isZeroVector=function(a){return void 0!==a?0===a.x&&0===a.y&&0===a.z:0===this.x&&0===this.y&&0===this.z},EZ3.Vector3.prototype.isDiff=function(a){return!this.isEqual(a)},EZ3.Vector3.prototype.toArray=function(){return[this.x,this.y,this.z]},EZ3.Vector3.prototype.toString=function(){var a=this.x.toFixed(4),b=this.y.toFixed(4),c=this.z.toFixed(4);return"Vector3["+a+", "+b+", "+c+"]"},EZ3.Vector3.prototype.toVector2=function(){return new EZ3.Vector2(this.x,this.y)},EZ3.Vector4=function(a,b,c,d){"number"==typeof a?(this.x=a,this.y="number"==typeof b?b:a,this.z="number"==typeof c?c:a,this.w="number"==typeof d?d:a):(this.x=0,this.y=0,this.z=0,this.w=0)},EZ3.Vector4.prototype.constructor=EZ3.Vector4,EZ3.Vector4.prototype.add=function(a,b){return void 0!==b?(this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this.w=a.w+b.w):(this.x+=a.x,this.y+=a.y,this.z+=a.z,this.w+=a.w),this},EZ3.Vector4.prototype.sub=function(a,b){return void 0!==b?(this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this.w=a.w-b.w):(this.x-=a.x,this.y-=a.y,this.z-=a.z,this.w-=a.w),this},EZ3.Vector4.prototype.set=function(a,b,c,d){this.x=a,this.y=b,this.z=c,this.w=d},EZ3.Vector4.prototype.scale=function(a,b){return void 0!==b?(this.x=b.x*a,this.y=b.y*a,this.z=b.z*a,this.w=b.w*a):(this.x*=a,this.y*=a,this.z*=a,this.w*=a),this},EZ3.Vector4.prototype.dot=function(a){return void 0!==a?a.x*this.x+a.y*this.y+a.z*this.z+a.w*this.w:-1},EZ3.Vector4.prototype.max=function(a,b){return void 0!==b?(this.x=a.x>b.x?a.x:b.x,this.y=a.y>b.y?a.y:b.y,this.z=a.z>b.z?a.z:b.z,this.w=a.w>b.w?a.w:b.w):(this.x<a.x&&(this.x=a.x),this.y<a.y&&(this.y=a.y),this.z<a.z&&(this.z=a.z),this.w<a.w&&(this.w=a.w)),this},EZ3.Vector4.prototype.min=function(a,b){return void 0!==b?(this.x=a.x<b.x?a.x:b.x,this.y=a.y<b.y?a.y:b.y,this.z=a.z<b.z?a.z:b.z,this.w=a.w<b.w?a.w:b.w):(this.x>a.x&&(this.x=a.x),this.y>a.y&&(this.y=a.y),this.z>a.z&&(this.z=a.z),this.w>a.w&&(this.w=a.w)),this},EZ3.Vector4.prototype.mulMatrix4=function(a,b){var c,d,e,f,g;return void 0!==a?(g=a.elements,void 0!==b?(c=b.x,d=b.y,e=b.z,f=b.w):(c=this.x,d=this.y,e=this.z,f=this.w),this.x=c*g[0]+d*g[4]+e*g[8]+f*g[12],this.y=c*g[1]+d*g[5]+e*g[9]+f*g[13],this.z=c*g[2]+d*g[6]+e*g[10]+f*g[14],this.w=c*g[3]+d*g[7]+e*g[11]+f*g[15]):(this.x=0,this.y=0,this.z=0,this.w=0),this},EZ3.Vector4.prototype.length=function(){return Math.sqrt(this.dot(this));
},EZ3.Vector4.prototype.normalize=function(a){var b;if(void 0!==a)b=a.length(),b>0?(a.scale(1/b),this.x=a.x,this.y=a.y,this.z=a.z,this.w=a.w):(this.x=0,this.y=0,this.z=0,this.w=0);else{if(b=this.length(),b>0)return this.scale(1/b),this;this.x=0,this.y=0,this.z=0,this.w=0}return this},EZ3.Vector4.prototype.negate=function(a){return void 0!==a?(this.x=-a.x,this.y=-a.y,this.z=-a.z,this.w=-a.w):(this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w),this},EZ3.Vector4.prototype.copy=function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this.w=a.w,this},EZ3.Vector4.prototype.clone=function(){return new EZ3.Vector4(this.x,this.y,this.z,this.w)},EZ3.Vector4.prototype.isEqual=function(a){return void 0!==a?this.x===a.x&&this.y===a.y&&this.z===a.z&&this.w===a.w:!1},EZ3.Vector4.prototype.isZeroVector=function(a){var b,c,d,e;return void 0!==a?(b=0===a.x,c=0===a.y,d=0===a.z,e=0===a.w):(b=0===this.x,c=0===this.y,d=0===this.z,e=0===this.w),b&&c&&d&&e},EZ3.Vector4.prototype.isDiff=function(a){return!this.isEqual(a)},EZ3.Vector4.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},EZ3.Vector4.prototype.toString=function(){var a=this.x.toFixed(4),b=this.y.toFixed(4),c=this.z.toFixed(4),d=this.w.toFixed(4);return"Vector4["+a+", "+b+", "+c+", "+d+"]"},EZ3.Vector4.prototype.toVector2=function(){return new EZ3.Vector2(this.x,this.y)},EZ3.Vector4.prototype.toVector3=function(){return new EZ3.Vector3(this.x,this.y,this.z)},EZ3.Body=function(a,b,c,d,e,f){this._body=a.add({type:b,pos:c,size:d,rot:e,move:f})},Object.defineProperty(EZ3.Body.prototype,"position",{get:function(){return this._body.getPosition()}}),Object.defineProperty(EZ3.Body.prototype,"quaternion",{get:function(){return this._body.getQuaternion()}}),Object.defineProperty(EZ3.Body.prototype,"density",{get:function(){return this._body.shapes.density},set:function(a){this._body.shapes.density=a,this._body.setupMass(1,a>0)}}),Object.defineProperty(EZ3.Body.prototype,"friction",{get:function(){return this._body.shapes.friction},set:function(a){this._body.shapes.friction=a}}),Object.defineProperty(EZ3.Body.prototype,"restitution",{get:function(){return this._body.shapes.restitution},set:function(a){this._body.shapes.restitution=a}}),EZ3.Body.BOX=1,EZ3.Body.SPHERE=2,EZ3.Body.CYLINDER=3,EZ3.Link=function(){},EZ3.World=function(){this._world=new OIMO.World(1/60,2,8),this._world.gravity=new OIMO.Vec3(0,-9.8,0),this._meshes=[]},EZ3.World.prototype.add=function(a,b,c){var d,e=a.getBoundingBox().applyMatrix4(a.world),f=e.getCenter(),g=a.position.clone().sub(f),h=new EZ3.Vector3;b===EZ3.Body.SPHERE?(b="sphere",h.sub(e.max,e.min),h=[.5*Math.max(h.x,h.y,h.z)],d=[0,0,0]):(b="box",h=h.sub(e.max,e.min).max(new EZ3.Vector3(1)).toArray(),d=[0,0,0]),f=f.toArray(),console.log(f),console.log(h),a.body=new EZ3.Body(this._world,b,f,h,d,c),a.delta=g,this._meshes.push(a)},EZ3.World.prototype.joint=function(){},EZ3.World.prototype.update=function(){var a,b;for(this._world.step(),b=0;b<this._meshes.length;b++)a=this._meshes[b],a.position.copy(a.body.position).add(a.delta),console.log(a.body.quaternion)},Object.defineProperty(EZ3.World.prototype,"gravity",{get:function(){return this._world.gravity},set:function(a){this._world.gravity.copy(a)}}),EZ3.GLSLProgram=function(a,b,c,d){this._id=null,this._cache={},this._shaders=[],this.uniforms={},this.attributes={},this._create(a,b,c,d)},EZ3.GLSLProgram.prototype._compile=function(a,b,c){var d,e=a.createShader(b);a.shaderSource(e,c),a.compileShader(e),a.getShaderParameter(e,a.COMPILE_STATUS)?b===a.VERTEX_SHADER?this._shaders[EZ3.GLSLProgram.VERTEX]=e:b===a.FRAGMENT_SHADER&&(this._shaders[EZ3.GLSLProgram.FRAGMENT]=e):(d="EZ3.GLSLProgram shader info log: ",d+=a.getShaderInfoLog(e),d+="\n",console.warn(d))},EZ3.GLSLProgram.prototype._create=function(a,b,c,d){var e;d=d?d:"",this._compile(a,a.VERTEX_SHADER,d+b),this._compile(a,a.FRAGMENT_SHADER,d+c),this._id=a.createProgram(),a.attachShader(this._id,this._shaders[EZ3.GLSLProgram.VERTEX]),a.attachShader(this._id,this._shaders[EZ3.GLSLProgram.FRAGMENT]),a.linkProgram(this._id),a.getProgramParameter(this._id,a.LINK_STATUS)?(this._loadUniforms(a),this._loadAttributes(a),a.deleteShader(this._shaders[EZ3.GLSLProgram.VERTEX]),a.deleteShader(this._shaders[EZ3.GLSLProgram.FRAGMENT])):(e="EZ3.GLSLProgram linking program error info log: ",e+=a.getProgramInfoLog(this._id,a.LINK_STATUS),e+="\n",console.warn(e))},EZ3.GLSLProgram.prototype._loadUniforms=function(a){var b,c,d=a.getProgramParameter(this._id,a.ACTIVE_UNIFORMS);for(c=0;d>c;c++)b=a.getActiveUniform(this._id,c).name,this.uniforms[b]=a.getUniformLocation(this._id,b)},EZ3.GLSLProgram.prototype._loadAttributes=function(a){var b,c,d=a.getProgramParameter(this._id,a.ACTIVE_ATTRIBUTES);for(c=0;d>c;c++)b=a.getActiveAttrib(this._id,c).name,this.attributes[b]=a.getAttribLocation(this._id,b)},EZ3.GLSLProgram.prototype.bind=function(a){a.useProgram(this._id)},EZ3.GLSLProgram.prototype.loadUniformInteger=function(a,b,c){var d=this.uniforms[b];d&&("number"==typeof c&&this._cache[b]!==c?(a.uniform1i(d,c),this._cache[b]=c):c instanceof EZ3.Vector2&&c.isDiff(this._cache[b])?(a.uniform2iv(d,c.toArray()),this._cache[b]=c.clone()):c instanceof EZ3.Vector3&&c.isDiff(this._cache[b])?(a.uniform3iv(d,c.toArray()),this._cache[b]=c.clone()):c instanceof EZ3.Vector4&&c.isDiff(this._cache[b])&&(a.uniform4iv(d,c.toArray()),this._cache[b]=c.clone()))},EZ3.GLSLProgram.prototype.loadUniformFloat=function(a,b,c){var d=this.uniforms[b];d&&("number"==typeof c&&this._cache[b]!==c?(a.uniform1f(d,c),this._cache[b]=c):c instanceof EZ3.Vector2&&c.isDiff(this._cache[b])?(a.uniform2fv(d,c.toArray()),this._cache[b]=c.clone()):c instanceof EZ3.Vector3&&c.isDiff(this._cache[b])?(a.uniform3fv(d,c.toArray()),this._cache[b]=c.clone()):c instanceof EZ3.Vector4&&c.isDiff(this._cache[b])&&(a.uniform4fv(d,c.toArray()),this._cache[b]=c.clone()))},EZ3.GLSLProgram.prototype.loadUniformMatrix=function(a,b,c){var d=this.uniforms[b];d&&(c instanceof EZ3.Matrix3&&c.isDiff(this._cache[b])?(a.uniformMatrix3fv(d,!1,c.toArray()),this._cache[b]=c.clone()):c instanceof EZ3.Matrix4&&c.isDiff(this._cache[b])&&(a.uniformMatrix4fv(d,!1,c.toArray()),this._cache[b]=c.clone()))},EZ3.GLSLProgram.prototype.loadUniformSamplerArray=function(a,b,c){var d=this.uniforms[b];d&&c instanceof Array&&this._cache[b]!==c.toString()&&(this._cache[b]=c.toString(),a.uniform1iv(d,c))},EZ3.GLSLProgram.VERTEX=0,EZ3.GLSLProgram.FRAGMENT=1,EZ3.Renderer=function(a,b){this.canvas=a,this.options=b,this.context=null,this.state=null,this.extensions=null,this.capabilities=null},EZ3.Renderer.prototype._processContextLost=function(a){a.preventDefault()},EZ3.Renderer.prototype._renderMesh=function(a,b,c){var d,e,f=this.context,g=a.material.program,h=new EZ3.Matrix4;for(this.state.bindProgram(g),a.material.updateStates(f,this.state),a.material.updateUniforms(f,this.state,this.capabilities),h.mul(b.view,a.world),g.loadUniformFloat(f,"uEyePosition",b.getWorldPosition()),g.loadUniformMatrix(f,"uModel",a.world),g.loadUniformMatrix(f,"uModelView",h),g.loadUniformMatrix(f,"uProjection",b.projection),g.loadUniformMatrix(f,"uNormal",a.normal),e=0;e<c.spot.length;e++)d=c.spot[e],d.updateUniforms(f,this.state,this.capabilities,g,e,a.shadowReceiver,c.spot.length);for(e=0;e<c.point.length;e++)d=c.point[e],d.updateUniforms(f,this.state,this.capabilities,g,e,a.shadowReceiver,c.point.length);for(e=0;e<c.directional.length;e++)d=c.directional[e],d.updateUniforms(f,this.state,this.capabilities,g,e,a.shadowReceiver,c.directional.length);a.render(f,this.state,this.extensions,g.attributes),this.state.usedTextureSlots=0},EZ3.Renderer.prototype._renderMeshDepth=function(a,b,c,d){var e=this.context,f=new EZ3.Matrix4;f.mul(c,b.world),a.loadUniformMatrix(e,"uModelView",f),a.loadUniformMatrix(e,"uProjection",d),b.render(e,this.state,this.extensions,a.attributes)},EZ3.Renderer.prototype._renderOmnidirectionalDepth=function(a,b,c){var d,e,f,g,h,i,j,k,l=this.context;for(i=0;i<c.length;i++)for(d=c[i],d.depthFramebuffer.bind(l,this.state),d.depthFramebuffer.update(l),j=0;6>j;j++)for(f=d.getView(j),g=d.projection,e=d.getFrustum(j),d.depthFramebuffer.texture.attach(l,j),this.clear(),k=0;k<b.length;k++)h=b[k],e.intersectsMesh(h)&&this._renderMeshDepth(a,h,f,g)},EZ3.Renderer.prototype._renderDirectionalDepth=function(a,b,c){var d,e,f,g,h=this.context;for(f=0;f<c.length;f++)for(d=c[f],d.depthFramebuffer.bind(h,this.state),d.depthFramebuffer.update(h),this.clear(),g=0;g<b.length;g++)e=b[g],d.frustum.intersectsMesh(e)&&this._renderMeshDepth(a,e,d.view,d.projection)},EZ3.Renderer.prototype._renderDepth=function(a,b){var c,d,e,f=this.context;this.state.disable(f.BLEND),this.state.enable(f.CULL_FACE),this.state.cullFace(f.FRONT),this.state.programs.depth||(c=EZ3.ShaderLibrary.depth.vertex,d=EZ3.ShaderLibrary.depth.fragment,this.state.programs.depth=new EZ3.GLSLProgram(f,c,d)),e=this.state.programs.depth,this.state.bindProgram(e),this._renderDirectionalDepth(e,a,b.directional),this._renderDirectionalDepth(e,a,b.spot),this._renderOmnidirectionalDepth(e,a,b.point),EZ3.Framebuffer.unbind(f)},EZ3.Renderer.prototype.initContext=function(){var a,b=this,c=["webgl","experimental-webgl","webkit-3d","moz-webgl"];for(a=0;a<c.length;a++){try{this.context=this.canvas.getContext(c[a],this.options)}catch(d){}if(this.context)break}if(!this.context)throw new Error("Unable to initialize WebGL with selected options.");this.state=new EZ3.RendererState(this.context),this.extensions=new EZ3.RendererExtensions(this.context),this.capabilities=new EZ3.RendererCapabilities(this.context),this._onContextLost=function(a){b._processContextLost(a)},this.canvas.addEventListener("webglcontextlost",this._onContextLost,!1)},EZ3.Renderer.prototype.clearColor=function(a){var b=this.context;b.clearColor(a.x,a.y,a.z,a.w)},EZ3.Renderer.prototype.clear=function(){var a=this.context;a.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT)},EZ3.Renderer.prototype.render=function(a,b,c,d){var e,f,g=this.context,h={common:[],opaque:[],transparent:[],shadowCasters:[]},i={point:[],directional:[],spot:[]},j=new EZ3.Vector3,k=!1;for(c.updateWorldTraverse(),c.traverse(function(a){a instanceof EZ3.Light?(k=!1,a instanceof EZ3.PointLight?(a.updateFrustums(),i.point.push(a)):(a.updateFrustum(),a instanceof EZ3.DirectionalLight?i.directional.push(a):a instanceof EZ3.SpotLight&&i.spot.push(a))):a instanceof EZ3.Mesh&&h.common.push(a)}),d.parent||d.updateWorld(),d.updateFrustum(),f=0;f<h.common.length;f++)e=h.common[f],e.material.visible&&(e.geometry instanceof EZ3.PrimitiveGeometry&&e.geometry.updateData(),e.shadowCaster&&h.shadowCasters.push(e),d.frustum.intersectsMesh(e)&&(e.updateLines(),k||(e.geometry.updateNormals(),e.updateNormal()),e.updateProgram(g,this.state,i),j.setPositionFromWorldMatrix(e.world).setFromViewProjectionMatrix(d.viewProjection).z,e.material.transparent?h.transparent.push({mesh:e,depth:j}):h.opaque.push({mesh:e,depth:j})));for(h.opaque.sort(function(a,b){return a.depth!==b.depth?a.depth-b.depth:void 0}),h.transparent.sort(function(a,b){return a.depth!==b.depth?b.depth-a.depth:void 0}),k||this._renderDepth(h.shadowCasters,i),this.state.viewport(a,b),f=0;f<h.opaque.length;f++)this._renderMesh(h.opaque[f].mesh,d,i);for(f=0;f<h.transparent.length;f++)this._renderMesh(h.transparent[f].mesh,d,i)},EZ3.RendererCapabilities=function(a){this.maxTextureSlots=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS)-1},EZ3.RendererExtensions=function(a){this.elementIndexUInt=a.getExtension("OES_element_index_uint"),this.vertexArrayObject=a.getExtension("OES_vertex_array_object"),this.standardDerivates=a.getExtension("OES_standard_derivatives")},EZ3.RendererState=function(a){this._context=a,this._states={},this._blendEquation={},this._blendFunc={},this._textureSlots={},this._attributeLayouts={},this._viewport={},this._program=null,this._cullFace=null,this._depthFunc=null,this._textureSlot=null,this.programs={},this.usedTextureSlots=0,this.textureArraySlots=[]},EZ3.RendererState.prototype.constructor=EZ3.State,EZ3.RendererState.prototype.enable=function(a){var b=this._context;this._states[a]||(this._states[a]=!0,b.enable(a))},EZ3.RendererState.prototype.disable=function(a){var b=this._context;this._states[a]&&(this._states[a]=!1,b.disable(a))},EZ3.RendererState.prototype.enableVertexAttribArray=function(a){var b=this._context;this._attributeLayouts[a]||(b.enableVertexAttribArray(a),this._attributeLayouts[a]=!0)},EZ3.RendererState.prototype.createProgram=function(a,b,c,d){var e=this._context;return this.programs[a]||(this.programs[a]=new EZ3.GLSLProgram(e,b,c,d)),this.programs[a]},EZ3.RendererState.prototype.bindProgram=function(a){var b=this._context;this._program!==a&&(this._program=a,a.bind(b))},EZ3.RendererState.prototype.bindTexture=function(a,b){var c,d=this._context,e=d.TEXTURE0+this.usedTextureSlots;this._textureSlot!==e&&(d.activeTexture(e),this._textureSlot=e),this._textureSlots[e]?(c=!1,this._textureSlots[e].id!==b&&(this._textureSlots[e].id=b,c=!0),this._textureSlots[e].target!==a&&(this._textureSlots[e].target=a,c=!0),c&&d.bindTexture(a,b)):(this._textureSlots[e]={id:b,target:a},d.bindTexture(a,b))},EZ3.RendererState.prototype.viewport=function(a,b){var c=this._context,d=!1;a.isDiff(this._viewport.position)&&(this._viewport.position=a.clone(),d=!0),b.isDiff(this._viewport.size)&&(this._viewport.size=b.clone(),d=!0),d&&c.viewport(a.x,a.y,b.x,b.y)},EZ3.RendererState.prototype.depthFunc=function(a){var b=this._context;this._depthFunc!==a&&(this._depthFunc=a,b.depthFunc(a))},EZ3.RendererState.prototype.cullFace=function(a){var b=this._context;this._cullFace!==a&&(this._cullFace=a,b.cullFace(a))},EZ3.RendererState.prototype.blendEquation=function(a,b){var c=this._context,d=!1;b=void 0!==b?b:a,this._blendEquation.modeRGB!==a&&(this._blendEquation.modeRGB=a,d=!0),this._blendEquation.modeAlpha!==b&&(this._blendEquation.modeAlpha=b,d=!0),d&&c.blendEquationSeparate(a,b)},EZ3.RendererState.prototype.blendFunc=function(a,b,c,d){var e=this._context,f=!1;c=void 0!==c?c:a,d=void 0!==d?d:b,this._blendFunc.srcRGB!==a&&(this._blendFunc.srcRGB=a,f=!0),this._blendFunc.dstRGB!==b&&(this._blendFunc.dstRGB=b,f=!0),this._blendFunc.srcAlpha!==c&&(this._blendFunc.srcAlpha=c,f=!0),this._blendFunc.dstAlpha!==d&&(this._blendFunc.dstAlpha=d,f=!0),f&&e.blendFuncSeparate(a,b,c,d)},EZ3.ShaderLibrary=function(){this.mesh={},this.depth={}},EZ3.ShaderLibrary=new EZ3.ShaderLibrary,EZ3.ShaderLibrary.depth.vertex="precision highp float;\n\nattribute vec3 position;\n\nuniform mat4 uModelView;\nuniform mat4 uProjection;\n\nvoid main() {\n  gl_Position = uProjection * uModelView * vec4(position, 1.0);\n}\n",EZ3.ShaderLibrary.mesh.vertex="precision highp float;\r\n\r\nattribute vec3 position;\r\nattribute vec3 normal;\r\nattribute vec2 uv;\r\n\r\nattribute vec3 morph1;\r\nattribute vec3 morph2;\r\n\r\nuniform mat4 uModel;\r\nuniform mat3 uNormal;\r\nuniform mat4 uModelView;\r\nuniform mat4 uProjection;\r\n\r\n#ifdef MORPH_TARGET\r\n  uniform float uInfluence1;\r\n  uniform float uInfluence2;\r\n#endif\r\n\r\nvarying vec3 vPosition;\r\nvarying vec3 vNormal;\r\nvarying vec2 vUv;\r\n\r\nvoid main() {\r\n  vec3 transformed = position;\r\n\r\n  #ifdef MORPH_TARGET\r\n    transformed += (morph1 - position) * uInfluence1;\r\n    transformed += (morph2 - position) * uInfluence2;\r\n  #endif\r\n\r\n  vPosition = vec3(uModel * vec4(transformed, 1.0));\r\n  vNormal = normalize(uNormal * normal);\r\n  vUv = uv;\r\n\r\n\r\n  gl_PointSize = 3.0;\r\n  gl_Position = uProjection * uModelView * vec4(transformed, 1.0);\r\n}\r\n",EZ3.ShaderLibrary.depth.fragment="precision highp float;\n\nvec4 pack(const in float depth) {\n  const vec4 bitShift = vec4(255.0 * 255.0 * 255.0, 255.0 * 255.0, 255.0, 1.0);\n	const vec4 bitMask = vec4(0.0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);\n\n	vec4 res = fract(depth * bitShift);\n	res -= res.xxyz * bitMask;\n\n	return res;\n}\n\nvoid main() {\n  gl_FragColor = pack(gl_FragCoord.z);\n}\n",EZ3.ShaderLibrary.mesh.fragment="precision highp float;\r\n\r\nstruct PointLight {\r\n	vec3 position;\r\n	vec3 diffuse;\r\n	vec3 specular;\r\n	float shadowBias;\r\n	float shadowDarkness;\r\n};\r\n\r\nstruct DirectionalLight {\r\n	vec3 direction;\r\n	vec3 diffuse;\r\n	vec3 specular;\r\n	mat4 shadow;\r\n	float shadowBias;\r\n	float shadowDarkness;\r\n};\r\n\r\nstruct SpotLight {\r\n	vec3 position;\r\n	vec3 direction;\r\n	float cutoff;\r\n	vec3 diffuse;\r\n	vec3 specular;\r\n	mat4 shadow;\r\n	float shadowBias;\r\n	float shadowDarkness;\r\n};\r\n\r\nuniform vec3 uEmissive;\r\nuniform vec3 uDiffuse;\r\nuniform vec3 uSpecular;\r\nuniform float uShininess;\r\nuniform float uOpacity;\r\nuniform vec3 uEyePosition;\r\n\r\n#if MAX_POINT_LIGHTS > 0\r\n  uniform PointLight uPointLights[MAX_POINT_LIGHTS];\r\n\r\n	#ifdef SHADOW_MAP\r\n		uniform samplerCube uPointShadowSampler[MAX_POINT_LIGHTS];\r\n	#endif\r\n#endif\r\n\r\n#if MAX_DIRECTIONAL_LIGHTS > 0\r\n  uniform DirectionalLight uDirectionalLights[MAX_DIRECTIONAL_LIGHTS];\r\n\r\n	#ifdef SHADOW_MAP\r\n		uniform sampler2D uDirectionalShadowSampler[MAX_DIRECTIONAL_LIGHTS];\r\n	#endif\r\n#endif\r\n\r\n#if MAX_SPOT_LIGHTS > 0\r\n  uniform SpotLight uSpotLights[MAX_SPOT_LIGHTS];\r\n\r\n	#ifdef SHADOW_MAP\r\n		uniform sampler2D uSpotShadowSampler[MAX_SPOT_LIGHTS];\r\n	#endif\r\n#endif\r\n\r\n#ifdef EMISSIVE_MAP\r\n	uniform sampler2D uEmissiveSampler;\r\n#endif\r\n\r\n#ifdef DIFFUSE_MAP\r\n	uniform sampler2D uDiffuseSampler;\r\n#endif\r\n\r\n#ifdef SPECULAR_MAP\r\n	uniform sampler2D uSpecularSampler;\r\n#endif\r\n\r\n#ifdef ENVIRONMENT_MAP\r\n	uniform samplerCube uEnvironmentSampler;\r\n#endif\r\n\r\n#ifdef REFRACTION\r\n	uniform float uRefractiveIndex;\r\n#endif\r\n\r\nvarying vec3 vPosition;\r\nvarying vec3 vNormal;\r\nvarying vec2 vUv;\r\n\r\n#ifdef LAMBERT\r\n	float lambert(in vec3 s, in vec3 n) {\r\n		return max(dot(s, n), 0.0);\r\n	}\r\n#endif\r\n\r\n#ifdef OREN_NAYAR\r\n	uniform float uAlbedo;\r\n	uniform float uDiffuseRoughness;\r\n\r\n	float orenNayar(in vec3 v, in vec3 s, in vec3 n) {\r\n		float PI = acos(-1.0);\r\n\r\n		float SdotV = dot(s, v);\r\n		float SdotN = dot(s, n);\r\n		float NdotV = dot(n, v);\r\n\r\n		float S = SdotV - SdotN * NdotV;\r\n		float T = mix(1.0, max(SdotN, NdotV), step(0.0, S));\r\n		float sigma2 = uDiffuseRoughness * uDiffuseRoughness;\r\n\r\n		float A = 1.0 + sigma2 * (uAlbedo / (sigma2 + 0.13) + 0.5 / (sigma2 + 0.33));\r\n		float B = 0.45 * sigma2 / (sigma2 + 0.09);\r\n\r\n		return uAlbedo * max(0.0, SdotN) * (A + B * S / T) / PI;\r\n	}\r\n#endif\r\n\r\n#ifdef PHONG\r\n	float phong(in vec3 v, in vec3 s, in vec3 n) {\r\n		return pow(max(dot(reflect(-s, n), v), 0.0), uShininess);\r\n	}\r\n#endif\r\n\r\n#ifdef BLINN_PHONG\r\n	float blinnPhong(in vec3 v, in vec3 s, in vec3 n) {\r\n		return pow(max(dot(normalize(s + v), n), 0.0), uShininess);\r\n	}\r\n#endif\r\n\r\n#ifdef COOK_TORRANCE\r\n	uniform float uFresnel;\r\n	uniform float uSpecularRoughness;\r\n\r\n	float beckmannDistribution(in float NdotH) {\r\n		float PI = acos(-1.0);\r\n		float cos2Beta = NdotH * NdotH;\r\n		float tan2Beta = (cos2Beta - 1.0) / cos2Beta;\r\n		float div =  PI * uSpecularRoughness * uSpecularRoughness * cos2Beta * cos2Beta;\r\n\r\n		return exp(tan2Beta / (uSpecularRoughness * uSpecularRoughness)) / div;\r\n	}\r\n\r\n	float cookTorrance(in vec3 v, in vec3 s, in vec3 n) {\r\n		vec3 h = normalize(s + v);\r\n\r\n		float VdotN = max(dot(v, n), 0.000001);\r\n		float SdotN = max(dot(s, n), 0.000001);\r\n		float VdotH = max(dot(v, h), 0.000001);\r\n		float SdotH = max(dot(s, h), 0.000001);\r\n		float NdotH = max(dot(n, h), 0.000001);\r\n\r\n		float G1 = (2.0 * NdotH * VdotN) / VdotH;\r\n		float G2 = (2.0 * NdotH * SdotN) / SdotH;\r\n		float G = min(1.0, min(G1, G2));\r\n\r\n		float D = beckmannDistribution(NdotH);\r\n		float F = pow(1.0 - VdotN, uFresnel);\r\n		float PI = acos(-1.0);\r\n\r\n	  return  G * F * D / max(PI * VdotN, 0.0);\r\n	}\r\n#endif\r\n\r\n#ifdef NORMAL_MAP\r\n	#extension GL_OES_standard_derivatives : enable\r\n\r\n	uniform sampler2D uNormalSampler;\r\n\r\n	vec3 pertubNormal(in vec3 v) {\r\n		vec3 q0 = dFdx(v);\r\n		vec3 q1 = dFdy(v);\r\n\r\n		vec2 st0 = dFdx(vUv);\r\n		vec2 st1 = dFdy(vUv);\r\n\r\n		vec3 s = normalize(q0 * st1.t - q1 * st0.t);\r\n		vec3 t = normalize(-q0 * st1.s + q1 * st0.s);\r\n		vec3 n = normalize(vNormal);\r\n\r\n		vec3 d = texture2D(uNormalSampler, vUv).xyz * 2.0 - 1.0;\r\n\r\n		return normalize(mat3(s, t, n) * d);\r\n	}\r\n#endif\r\n\r\n#ifdef SHADOW_MAP\r\n	bool isBounded(in float coordinate) {\r\n		return coordinate >= 0.0 && coordinate <= 1.0;\r\n	}\r\n\r\n	float unpack(in vec4 color) {\r\n		const vec4 bitShift = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);\r\n	  return dot(color, bitShift);\r\n	}\r\n\r\n	#if (MAX_POINT_LIGHTS > 0)\r\n		float omnidirectionalShadow(in vec3 lightPosition, in float bias, in float darkness, in samplerCube sampler) {\r\n			vec3 direction = vPosition - lightPosition;\r\n			float vertexDepth = clamp(length(direction), 0.0, 1.0);\r\n			float shadowMapDepth = unpack(textureCube(sampler, direction)) + bias;\r\n\r\n			return (vertexDepth > shadowMapDepth) ? darkness : 1.0;\r\n		}\r\n	#endif\r\n\r\n	#if (MAX_DIRECTIONAL_LIGHTS > 0) || (MAX_SPOT_LIGHTS > 0)\r\n		float directionalShadow(in mat4 shadowMatrix, in float bias, in float darkness, in sampler2D sampler) {\r\n			vec4 lightCoordinates = shadowMatrix * vec4(vPosition, 1.0);\r\n			vec3 shadowCoordinates = lightCoordinates.xyz / lightCoordinates.w;\r\n\r\n			if(isBounded(shadowCoordinates.x) && isBounded(shadowCoordinates.y) && isBounded(shadowCoordinates.z)) {\r\n				float vertexDepth = shadowCoordinates.z;\r\n				float shadowMapDepth = unpack(texture2D(sampler, shadowCoordinates.xy)) + bias;\r\n\r\n				return (vertexDepth > shadowMapDepth) ? darkness : 1.0;\r\n			}\r\n\r\n			return 1.0;\r\n		}\r\n	#endif\r\n#endif\r\n\r\nfloat computeDiffuseReflection(in vec3 v, in vec3 s, in vec3 n) {\r\n	float diffuse = 1.0;\r\n\r\n	#ifdef LAMBERT\r\n		diffuse = lambert(s, n);\r\n	#endif\r\n\r\n	#ifdef OREN_NAYAR\r\n		diffuse = orenNayar(v, s, n);\r\n	#endif\r\n\r\n	return diffuse;\r\n}\r\n\r\nfloat computeSpecularReflection(in vec3 v, in vec3 s, in vec3 n) {\r\n	float specular = 1.0;\r\n\r\n	#ifdef BLINN_PHONG\r\n		specular = blinnPhong(v, s, n);\r\n	#endif\r\n\r\n	#ifdef COOK_TORRANCE\r\n		specular = cookTorrance(v, s, n);\r\n	#endif\r\n\r\n	#ifdef PHONG\r\n		specular = phong(v, s, n);\r\n	#endif\r\n\r\n	return specular;\r\n}\r\n\r\nvoid main() {\r\n	float shadow = 1.0;\r\n\r\n	float diffuseReflection;\r\n	float specularReflection;\r\n\r\n	vec3 emissive = uEmissive;\r\n	vec3 diffuse = vec3(0.0);\r\n	vec3 specular = vec3(0.0);\r\n\r\n	vec3 v = normalize(uEyePosition - vPosition);\r\n\r\n	#ifdef FLAT\r\n		vec3 fdx = dFdx(vPosition);\r\n		vec3 fdy = dFdy(vPosition);\r\n		vec3 n = normalize(cross(fdx, fdy));\r\n	#else\r\n		vec3 n = vNormal;\r\n	#endif\r\n\r\n	#ifdef NORMAL_MAP\r\n		n = pertubNormal(-v);\r\n	#endif\r\n\r\n	#if MAX_POINT_LIGHTS > 0\r\n	  for(int i = 0; i < MAX_POINT_LIGHTS; i++) {\r\n			vec3 s = normalize(uPointLights[i].position - vPosition);\r\n\r\n			diffuseReflection = computeDiffuseReflection(v, s, n);\r\n\r\n			if (diffuseReflection > 0.0) {\r\n\r\n				specularReflection = computeSpecularReflection(v, s, n);\r\n\r\n				#ifdef SHADOW_MAP\r\n					vec3 lightPosition = uPointLights[i].position;\r\n					float shadowBias = uPointLights[i].shadowBias;\r\n					float shadowDarkness = uPointLights[i].shadowDarkness;\r\n\r\n					shadow = omnidirectionalShadow(lightPosition, shadowBias, shadowDarkness, uPointShadowSampler[i]);\r\n				#endif\r\n\r\n				diffuse += uPointLights[i].diffuse * uDiffuse * diffuseReflection * shadow;\r\n				specular += uPointLights[i].specular * uSpecular * specularReflection * shadow;\r\n			}\r\n	  }\r\n	#endif\r\n\r\n	#if MAX_DIRECTIONAL_LIGHTS > 0\r\n	  for(int i = 0; i < MAX_DIRECTIONAL_LIGHTS; i++) {\r\n			vec3 s = uDirectionalLights[i].direction;\r\n\r\n			diffuseReflection = computeDiffuseReflection(v, s, n);\r\n\r\n			if (diffuseReflection > 0.0) {\r\n\r\n				specularReflection = computeSpecularReflection(v, s, n);\r\n\r\n				#ifdef SHADOW_MAP\r\n					mat4 shadowMatrix = uDirectionalLights[i].shadow;\r\n					float shadowBias = uDirectionalLights[i].shadowBias;\r\n					float shadowDarkness = uDirectionalLights[i].shadowDarkness;\r\n\r\n					shadow = directionalShadow(shadowMatrix, shadowBias, shadowDarkness, uDirectionalShadowSampler[i]);\r\n				#endif\r\n\r\n				diffuse += uDirectionalLights[i].diffuse * uDiffuse * diffuseReflection * shadow;\r\n				specular += uDirectionalLights[i].specular * uSpecular * specularReflection * shadow;\r\n			}\r\n	  }\r\n	#endif\r\n\r\n	#if MAX_SPOT_LIGHTS > 0\r\n	  for(int i = 0; i < MAX_SPOT_LIGHTS; i++) {\r\n			vec3 s = normalize(uSpotLights[i].position - vPosition);\r\n			float angle = max(dot(s, uSpotLights[i].direction), 0.0);\r\n\r\n			if(angle > uSpotLights[i].cutoff) {\r\n\r\n				diffuseReflection = computeDiffuseReflection(v, s, n);\r\n\r\n				if (diffuseReflection > 0.0) {\r\n\r\n					specularReflection = computeSpecularReflection(v, s, n);\r\n\r\n					#ifdef SHADOW_MAP\r\n						mat4 shadowMatrix = uSpotLights[i].shadow;\r\n						float shadowBias = uSpotLights[i].shadowBias;\r\n						float shadowDarkness = uSpotLights[i].shadowDarkness;\r\n\r\n						shadow = directionalShadow(shadowMatrix, shadowBias, shadowDarkness, uSpotShadowSampler[i]);\r\n					#endif\r\n\r\n					diffuse += uSpotLights[i].diffuse * uDiffuse * diffuseReflection * shadow;\r\n					specular += uSpotLights[i].specular * uSpecular * specularReflection * shadow;\r\n				}\r\n			}\r\n	  }\r\n	#endif\r\n\r\n	#ifdef EMISSIVE_MAP\r\n	  emissive *= texture2D(uEmissiveSampler, vUv).rgb;\r\n	#endif\r\n\r\n	#ifdef DIFFUSE_MAP\r\n		diffuse *= texture2D(uDiffuseSampler, vUv).rgb;\r\n	#endif\r\n\r\n	#ifdef SPECULAR_MAP\r\n		specular *= texture2D(uSpecularSampler, vUv).rgb;\r\n	#endif\r\n\r\n	#ifdef REFLECTION\r\n		vec3 reflection = reflect(-v, n);\r\n		diffuse *= textureCube(uEnvironmentSampler, reflection).rgb;\r\n	#endif\r\n\r\n	#ifdef REFRACTION\r\n		vec3 refraction = refract(-v, n, uRefractiveIndex);\r\n		diffuse *= textureCube(uEnvironmentSampler, refraction).rgb;\r\n	#endif\r\n\r\n	gl_FragColor = vec4(emissive + diffuse + specular, uOpacity);\r\n}\r\n",EZ3.Screen=function(a,b){this.position=a,this.size=b,this.load=new EZ3.RequestManager,this.scene=new EZ3.Scene,this.camera=null,this.world=null},EZ3.ScreenManager=function(a,b,c,d,e,f){this._screens=[],this.canvas=a,this.bounds=b,this.renderer=c,this.time=d,this.input=e,this.clearColor=new EZ3.Vector4(0,0,0,1),this.fullScreeneded=!1,f&&this.add("default",f)},EZ3.ScreenManager.prototype._addScreenEventListeners=function(a){var b,c,d,e=EZ3.Device,f={keyboard:{onKeyPress:"onKeyPress",onKeyDown:"onKeyDown",onKeyUp:"onKeyUp"},mouse:{onPress:"onMousePress",onMove:"onMouseMove",onUp:"onMouseUp",onWheel:"onMouseWheel"},touch:{onPress:"onTouchPress",onMove:"onTouchMove",onUp:"onTouchUp"}};for(c in f){b=f[c];for(d in b)a[b[d]]&&this.input[c][d].add(a[b[d]],a)}a.onResize&&e.onResize.add(a.onResize,a)},EZ3.ScreenManager.prototype._removeScreenEventListeners=function(a){var b,c,d,e=EZ3.Device,f={keyboard:["onKeyPress","onKeyDown","onKeyUp"],mouse:["onPress","onMove","onUp"],touch:["onPress","onMove","onUp"]};for(c in f)for(b=f[c],d=0;d<b.length;d++)a.input[c][b[d]].removeAll(a);e.onResize.removeAll(a)},EZ3.ScreenManager.prototype._processFullScreenChange=function(){var a=EZ3.Device;this.fullScreened=!this.fullScreened,this.fullScreened||(this.canvas.removeEventListener(a.fullScreenChange,this._onFullScreenChange,!0),delete this._onFullScreenChange)},EZ3.ScreenManager.prototype.add=function(a,b){var c,d;if(!(b instanceof EZ3.Screen)){if("function"==typeof b)c=b,b=new c;else if("object"!=typeof b)return;b.load=new EZ3.RequestManager,b.scene=new EZ3.Scene,b.camera=null,b.position||(b.position=new EZ3.Vector2),b.size||(b.size=new EZ3.Vector2(this.canvas.width,this.canvas.height))}return b.id=a,b.manager=this,b.preload?(b.preload(),b.onLoadProgress&&b.load.onProgress.add(b.onLoadProgress,b),d=function(a,c,e){b.onLoadProgress&&b.load.onProgress.remove(b.onLoadProgress,b),b.load.onComplete.remove(d,this),b.create.call(b,a,c,e),this._addScreenEventListeners(b),this._screens.unshift(b)},b.load.onComplete.add(d,this),b.load.start()):(b.create(),this._addScreenEventListeners(b),this._screens.unshift(b)),b},EZ3.ScreenManager.prototype.get=function(a){var b;for(b=0;b<this._screens.length;b++)if(this._screens[b].id===a)return this._screens[b]},EZ3.ScreenManager.prototype.remove=function(a){var b;for(b=0;b<this._screens.length;b++)if(this._screens[b].id===a)return this._removeScreenEventListeners(this._screens[b]),this._screens.splice(b,1)},EZ3.ScreenManager.prototype.update=function(){var a,b;for(this.renderer.clearColor(this.clearColor),this.renderer.clear(),b=0;b<this._screens.length;b++)a=this._screens[b],this.renderer.render(a.position,a.size,a.scene,a.camera),a.world&&a.world.update(),this._screens[b].update()},EZ3.ScreenManager.prototype.requestFullScreen=function(){var a,b=EZ3.Device;b.requestFullScreen&&!this.fullScreened&&(a=this,this._onFullScreenChange=function(b){a._processFullScreenChange(b)},this.canvas.addEventListener(b.fullScreenChange,this._onFullScreenChange,!0),this.canvas[b.requestFullScreen]())},EZ3.ScreenManager.prototype.exitFullScreen=function(){var a=EZ3.Device;a.exitFullScreen&&this.fullScreened&&document[a.exitFullScreen]()},EZ3.AnimationFrame=function(a){var b=EZ3.Device;this._id=0,!b.requestAnimationFrame||a?(this._onRequestAnimationFrame=function(a){return window.setTimeout(a,1e3/60)},this._onCancelAnimationFrame=function(a){clearTimeout(a)}):(this._onRequestAnimationFrame=function(a){return window[b.requestAnimationFrame](a)},this._onCancelAnimationFrame=function(a){window[b.cancelAnimationFrame](a)})},EZ3.AnimationFrame.prototype.request=function(a){this._id=this._onRequestAnimationFrame(a)},EZ3.AnimationFrame.prototype.cancel=function(){this._onCancelAnimationFrame(this._id)},EZ3.Device=function(){this.ready=!1,this.onResize=new EZ3.Signal,this.operatingSystem=0,this.requestAnimationFrame=null,this.cancelAnimationFrame=null,this.touchDown=null,this.touchMove=null,this.touchUp=null,this.wheel=null,this.requestFullScreen=null,this.exitFullScreen=null,this.fullScreenChange=null,this.fullScreenError=null,this.requestPointerLock=null,this.exitPointerLock=null,this.pointerLockChange=null,this.pointerLockError=null,EZ3.Device.WINDOWS=1,EZ3.Device.MACOS=2,EZ3.Device.LINUX=4,EZ3.Device.IOS=8,EZ3.Device.ANDROID=16,EZ3.Device.WINDOWS_PHONE=32,EZ3.Device.CRHOMEOS=64,EZ3.Device.KINDLE=128,EZ3.Device.PSVITA=256},EZ3.Device=new EZ3.Device,EZ3.Device._check=function(){function a(){/Playstation Vita/.test(navigator.userAgent)?f.operatingSystem=EZ3.Device.PSVITA:/Kindle/.test(navigator.userAgent)||/\bKF[A-Z][A-Z]+/.test(navigator.userAgent)||/Silk.*Mobile Safari/.test(navigator.userAgent)?f.operatingSystem=EZ3.Device.KINDLE:/Android/.test(navigator.userAgent)?f.operatingSystem=EZ3.Device.ANDROID:/CrOS/.test(navigator.userAgent)?f.operatingSystem=EZ3.Device.CRHOMEOS:/iP[ao]d|iPhone/i.test(navigator.userAgent)?f.operatingSystem=EZ3.Device.IOS:/Linux/.test(navigator.userAgent)?f.operatingSystem=EZ3.Device.LINUX:/Mac OS/.test(navigator.userAgent)?f.operatingSystem=EZ3.Device.MACOS:/Windows/.test(navigator.userAgent)&&(f.operatingSystem=EZ3.Device.WINDOWS),(/Windows Phone/i.test(navigator.userAgent)||/IEMobile/i.test(navigator.userAgent))&&(f.operatingSystem=EZ3.Device.WINDOWS_PHONE)}function b(){window.requestAnimationFrame?(f.requestAnimationFrame="requestAnimationFrame",f.cancelAnimationFrame="cancelAnimationFrame"):window.webkitRequestAnimationFrame?(f.requestAnimationFrame="webkitRequestAnimationFrame",f.cancelAnimationFrame="webkitCancelAnimationFrame"):window.mozRequestAnimationFrame?(f.requestAnimationFrame="mozRequestAnimationFrame",f.cancelAnimationFrame="mozCancelAnimationFrame"):window.msRequestAnimationFrame?(f.requestAnimationFrame="msRequestAnimationFrame",
f.cancelAnimationFrame="msCancelAnimationFrame"):window.oRequestAnimationFrake&&(f.requestAnimationFrame="oRequestAnimationFrame",f.cancelAnimationFrame="oCancelAnimationFrame")}function c(){"ontouchstart"in document.documentElement||window.navigator.maxTouchPoints?(f.touchDown="touchstart",f.touchMove="touchmove",f.touchUp="touchend"):window.navigator.pointerEnabled?(f.touchDown="pointerdown",f.touchMove="pointermove",f.touchUp="pointerup"):window.navigator.msPointerEnabled&&(f.touchDown="MSPointerDown",f.touchMove="MSPointerMove",f.touchUp="MSPointerUp"),"onwheel"in window||"WheelEvent"in window?f.wheel="wheel":"onmousewheel"in window?f.wheel="mousewheel":"MouseScrollEvent"in window&&(f.wheel="DOMMouseScroll")}function d(){document.fullscreenEnabled?(f.requestFullScreen="requestFullscreen",f.exitFullScreen="exitFullscreen",f.fullScreenChange="fullscreenchange",f.fullScreenError="fullscreenerror"):document.webkitFullscreenEnabled?(f.requestFullScreen="webkitRequestFullscreen",f.exitFullScreen="webkitExitFullscreen",f.fullScreenChange="webkitfullscreenchange",f.fullScreenError="webkitfullscreenerror"):document.mozFullScreenEnabled?(f.requestFullScreen="mozRequestFullscreen",f.exitFullScreen="mozCancelFullScreen",f.fullScreenChange="mozfullscreenchange",f.fullScreenError="mozfullscreenerror"):document.msFullscreenEnabled&&(f.requestFullScreen="msRequestFullscreen",f.exitFullScreen="msExitFullscreen",f.fullScreenChange="MSFullscreenChange",f.fullScreenError="MSFullscreenError")}function e(){"pointerLockElement"in document?(f.requestPointerLock="requestPointerLock",f.exitPointerLock="exitPointerLock",f.pointerLockChange="pointerlockchange",f.pointerLockCancel="pointerlockerror"):"webkitPointerLockElement"in document?(f.requestPointerLock="webkitRequestPointerLock",f.exitPointerLock="webkitExitPointerLock",f.pointerLockChange="webkitpointerlockchange",f.pointerLockCancel="webkitpointerlockerror"):"mozPointerLockElement"in document&&(f.requestPointerLock="mozRequestPointerLock",f.exitPointerLock="mozExitPointerLock",f.pointerLockChange="mozpointerlockchange",f.pointerLockCancel="mozpointerlockerror")}var f=this;a(),b(),d(),e(),c()},EZ3.Device._isReady=function(){var a;document.body?this.ready||(a=this,document.removeEventListener("deviceready",this._onReady),document.removeEventListener("DOMContentLoaded",this._onReady),window.removeEventListener("load",this._onReady),delete this._onReady,this._check(),delete this._check,this._onResize=function(){a.onResize.dispatch()},window.addEventListener("resize",this._onResize,!0),this.ready=!0,this._isReady.signal.dispatch(),this._isReady.signal.dispose(),delete this._isReady):window.setTimeout(this._isReady,20)},EZ3.Device.onReady=function(a,b,c){var d,e;this.ready?a.apply(b,c):this._isReady.signal?(e=this._isReady.signal.add(a,b),e.params=c):(d=this,this._isReady.signal=new EZ3.Signal,e=this._isReady.signal.add(a,b),e.params=c,this._onReady=function(){d._isReady()},"complete"===document.readyState||"interactive"===document.readyState?this._isReady():"undefined"==typeof window.cordova||navigator.isCocoonJS?(document.addEventListener("DOMContentLoaded",this._onReady,!1),window.addEventListener("load",this._onReady,!1)):document.addEventListener("deviceready",this._onReady,!1))},EZ3.Time=function(){this.now=0,this.previous=0,this.elapsed=0,this.started=0},EZ3.Time.prototype.start=function(){this.started=this.now=Date.now()},EZ3.Time.prototype.update=function(){this.previous=this.now,this.now=Date.now(),this.elapsed=.001*(this.now-this.previous)},EZ3.Texture=function(a){this._id=null,this._cache={},this.generateMipmaps=void 0===a?!0:a,this.wrapS=EZ3.Texture.REPEAT,this.wrapT=EZ3.Texture.REPEAT,this.magFilter=EZ3.Texture.LINEAR,this.minFilter=EZ3.Texture.LINEAR_MIPMAP_LINEAR,this.flipY=!1,this.needUpdate=!0},EZ3.Texture.prototype._getGLFilter=function(a,b){return b===EZ3.Texture.LINEAR?a.LINEAR:b===EZ3.Texture.NEAREST?a.NEAREST:b===EZ3.Texture.LINEAR_MIPMAP_LINEAR?a.LINEAR_MIPMAP_LINEAR:b===EZ3.Texture.NEAREST_MIPMAP_NEAREST?a.NEAREST_MIPMAP_NEAREST:b===EZ3.Texture.NEAREST_MIPMAP_LINEAR?a.NEAREST_MIPMAP_LINEAR:a.LINEAR_MIPMAP_NEAREST},EZ3.Texture.prototype._getGLWrap=function(a,b){return b===EZ3.Texture.CLAMP_TO_EDGE?a.CLAMP_TO_EDGE:b===EZ3.Texture.REPEAT?a.REPEAT:a.MIRRORED_REPEAT},EZ3.Texture.prototype._updateImage=function(a,b,c){var d=c.getGLFormat(a);EZ3.Math.isPowerOfTwo(c.width)&&EZ3.Math.isPowerOfTwo(c.height)||c.toPowerOfTwo(),a.texImage2D(b,0,d,c.width,c.height,0,d,a.UNSIGNED_BYTE,c.data)},EZ3.Texture.prototype._updateMipmaps=function(a,b){this.generateMipmaps?a.generateMipmap(b):(this.magFilter=EZ3.Texture.LINEAR,this.minFilter=EZ3.Texture.LINEAR)},EZ3.Texture.prototype._updatePixelStore=function(a){this._cache.flipY!==this.flipY&&(a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,this.flipY),this._cache.flipY=this.flipY)},EZ3.Texture.prototype._updateParameters=function(a,b){this._cache.wrapS!==this.wrapS&&(a.texParameteri(b,a.TEXTURE_WRAP_S,this._getGLWrap(a,this.wrapS)),this._cache.wrapS=this.wrapS),this._cache.wrapT!==this.wrapT&&(a.texParameteri(b,a.TEXTURE_WRAP_T,this._getGLWrap(a,this.wrapT)),this._cache.wrapT=this.wrapT),this._cache.magFilter!==this.magFilter&&(a.texParameteri(b,a.TEXTURE_MAG_FILTER,this._getGLFilter(a,this.magFilter)),this._cache.magFilter=this.magFilter),this._cache.minFilter!==this.minFilter&&(a.texParameteri(b,a.TEXTURE_MIN_FILTER,this._getGLFilter(a,this.minFilter)),this._cache.minFilter=this.minFilter)},EZ3.Texture.prototype.bind=function(a,b,c,d){this._id||(this._id=a.createTexture()),b&&c?b.usedTextureSlots<c.maxTextureSlots+1?b.bindTexture(d,this._id):console.warn("EZ3.Texture.bind: not available enough texture slots."):a.bindTexture(d,this._id)},EZ3.Texture.LINEAR=1,EZ3.Texture.NEAREST=2,EZ3.Texture.LINEAR_MIPMAP_LINEAR=3,EZ3.Texture.NEAREST_MIPMAP_NEAREST=4,EZ3.Texture.NEAREST_MIPMAP_LINEAR=5,EZ3.Texture.LINEAR_MIPMAP_NEAREST=6,EZ3.Texture.CLAMP_TO_EDGE=1,EZ3.Texture.REPEAT=2,EZ3.Texture.MIRRORED_REPEAT=3,EZ3.Texture.COLOR_ATTACHMENT0=1,EZ3.CameraControl=function(a,b,c){EZ3.Control.call(this,a),this.right=new EZ3.Vector3,this.roll=0,this.minPitch=-EZ3.Math.HALF_PI,this.maxPitch=EZ3.Math.HALF_PI,this.minYaw=-(1/0),this.maxYaw=1/0,this.lookAt(b,c)},EZ3.CameraControl.prototype=Object.create(EZ3.Control.prototype),EZ3.CameraControl.prototype.constructor=EZ3.CameraControl,EZ3.CameraControl.prototype.lookAt=function(a,b){var c;this.target=a||new EZ3.Vector3,this.up=b||new EZ3.Vector3(0,1,0),this.look=(new EZ3.Vector3).sub(this.target,this.entity.position).normalize(),this.right=(new EZ3.Vector3).cross(this.look,this.up),c=Math.sqrt(this.look.x*this.look.x+this.look.z*this.look.z),this.yaw=Math.atan2(this.look.x,this.look.z),this.pitch=Math.atan2(-this.look.y,c),this.entity.lookAt(this.target,this.up)},EZ3.CameraControl.prototype.rotate=function(a,b,c){c=void 0!==c?c:1,this.yaw-=a*c,this.pitch+=b*c,this.yaw=Math.max(this.minYaw,Math.min(this.maxYaw,this.yaw)),this.pitch=Math.max(this.minPitch,Math.min(this.maxPitch,this.pitch))},EZ3.Camera=function(){EZ3.Entity.call(this),this.view=new EZ3.Matrix4,this.projection=new EZ3.Matrix4,this.viewProjection=new EZ3.Matrix4,this.frustum=new EZ3.Frustum},EZ3.Camera.prototype=Object.create(EZ3.Entity.prototype),EZ3.Camera.prototype.constructor=EZ3.Camera,EZ3.Camera.prototype._updateView=function(){return this.world.isDiff(this._cache.world)?(this._cache.world=this.world.clone(),this.view.inverse(this.world),!0):!1},EZ3.Camera.prototype.updateFrustum=function(){(this._updateView()||this._updateProjection())&&(this.viewProjection.mul(this.projection,this.view),this.frustum.setFromMatrix4(this.viewProjection))},EZ3.CubeCamera=function(a,b){var c;for(EZ3.Entity.call(this),this.near=void 0!==a?a:.1,this.far=void 0!==b?b:2e3,this._views=[],this.projection=new EZ3.Matrix4,this._viewProjections=[],this._frustums=[],c=0;6>c;c++)this._views.push(new EZ3.Matrix4),this._viewProjections.push(new EZ3.Matrix4),this._frustums.push(new EZ3.Frustum)},EZ3.CubeCamera.prototype=Object.create(EZ3.Entity.prototype),EZ3.CubeCamera.prototype.constructor=EZ3.CubeCamera,EZ3.CubeCamera.prototype._updateProjection=function(){var a=!1;return this._cache.near!==this.near&&(this._cache.near=this.near,a=!0),this._cache.far!==this.far&&(this._cache.far=this.far,a=!0),a&&this.projection.perspective(90,1,this.near,this.far),a},EZ3.CubeCamera.prototype._updateViews=function(){var a,b=this.getWorldPosition(),c=new EZ3.Vector3,d=new EZ3.Vector3;if(b.isEqual(this._cache.worldPosition))return!1;for(a=0;6>a;a++){switch(a){case EZ3.Cubemap.POSITIVE_X:c.set(1,0,0),d.set(0,-1,0);break;case EZ3.Cubemap.NEGATIVE_X:c.set(-1,0,0),d.set(0,-1,0);break;case EZ3.Cubemap.POSITIVE_Y:c.set(0,1,0),d.set(0,0,1);break;case EZ3.Cubemap.NEGATIVE_Y:c.set(0,-1,0),d.set(0,0,-1);break;case EZ3.Cubemap.POSITIVE_Z:c.set(0,0,1),d.set(0,-1,0);break;case EZ3.Cubemap.NEGATIVE_Z:c.set(0,0,-1),d.set(0,-1,0)}this._views[a].lookAt(b,c.clone().add(b),d)}return this._cache.worldPosition=b.clone(),!0},EZ3.CubeCamera.prototype.updateFrustums=function(){var a,b;if(this._updateViews()||this._updateProjection())for(b=0;6>b;b++)a=this._viewProjections[b],a.mul(this.projection,this._views[b]),this._frustums[b].setFromMatrix4(a)},EZ3.CubeCamera.prototype.getView=function(a){return this._views[a]},EZ3.CubeCamera.prototype.getViewProjection=function(a){return this._viewProjections[a]},EZ3.CubeCamera.prototype.getFrustum=function(a){return this._frustums[a]},EZ3.Scene=function(){EZ3.Entity.call(this)},EZ3.Scene.prototype=Object.create(EZ3.Entity.prototype),EZ3.Scene.prototype.constructor=EZ3.Scene,EZ3.Mesh=function(a,b){EZ3.Entity.call(this),this.geometry=a||new EZ3.Geometry,this.material=b||new EZ3.MeshMaterial,this.normal=new EZ3.Matrix3,this.shadowCaster=!1,this.shadowReceiver=!1},EZ3.Mesh.prototype=Object.create(EZ3.Entity.prototype),EZ3.Mesh.prototype.constructor=EZ3.Mesh,EZ3.Mesh.prototype.updateProgram=function(a,b,c){this.material.updateProgram(a,b,c,this.shadowReceiver)},EZ3.Mesh.prototype.updateLines=function(){this.material.fill===EZ3.Material.WIREFRAME&&this.geometry.updateLines()},EZ3.Mesh.prototype.updateNormal=function(){this.world.isDiff(this._cache.world)&&(this.normal.normalFromMat4(this.world),this._cache.world=this.world.clone())},EZ3.Mesh.prototype.render=function(a,b,c,d){var e,f,g;this.material.fill===EZ3.Material.WIREFRAME?(f=EZ3.IndexBuffer.LINEAR,g=this.geometry.buffers.getLines(),e=a.LINES):this.material.fill===EZ3.Material.POINTS?(g=this.geometry.buffers.getPositions(),e=a.POINTS):(f=EZ3.IndexBuffer.TRIANGULAR,g=this.geometry.buffers.getTriangles(),e=a.TRIANGLES),f?(this.geometry.buffers.bind(a,d,b,c,f),a.drawElements(e,g.data.length,g.getGLType(a,c),0)):(this.geometry.buffers.bind(a,d,b,c),a.drawArrays(e,0,g.data.length/3))},EZ3.DepthCubeFramebuffer=function(a){EZ3.Framebuffer.call(this,a)},EZ3.DepthCubeFramebuffer.prototype=Object.create(EZ3.Framebuffer.prototype),EZ3.DepthCubeFramebuffer.prototype.constructor=EZ3.DepthCubeFramebuffer,EZ3.DepthCubeFramebuffer.prototype.update=function(a){this.size.isDiff(this._cache.size)&&(this._cache.size=this.size.clone(),this.texture=new EZ3.TargetCubemap(this.size,EZ3.Image.RGBA_FORMAT,a.COLOR_ATTACHMENT0),this.texture.wrapS=EZ3.Texture.CLAMP_TO_EDGE,this.texture.wrapT=EZ3.Texture.CLAMP_TO_EDGE,EZ3.Framebuffer.prototype.update.call(this,a))},EZ3.DepthFramebuffer=function(a){EZ3.Framebuffer.call(this,a)},EZ3.DepthFramebuffer.prototype=Object.create(EZ3.Framebuffer.prototype),EZ3.DepthFramebuffer.prototype.constructor=EZ3.DepthFramebuffer,EZ3.DepthFramebuffer.prototype.update=function(a){this.size.isDiff(this._cache.size)&&(this._cache.size=this.size.clone(),this.texture=new EZ3.TargetTexture2D(this.size,EZ3.Image.RGBA_FORMAT,a.COLOR_ATTACHMENT0),this.texture.wrapS=EZ3.Texture.CLAMP_TO_EDGE,this.texture.wrapT=EZ3.Texture.CLAMP_TO_EDGE,EZ3.Framebuffer.prototype.update.call(this,a))},EZ3.PrimitiveGeometry=function(){EZ3.Geometry.call(this),this._cache={}},EZ3.PrimitiveGeometry.prototype=Object.create(EZ3.Geometry.prototype),EZ3.PrimitiveGeometry.prototype.constructor=EZ3.PrimitiveGeometry,EZ3.PrimitiveGeometry.prototype.updateData=function(){this._dataNeedUpdate&&this._computeData()},EZ3.IndexBuffer=function(a,b,c){EZ3.Buffer.call(this,a,c),this.need32Bits=void 0!==b?b:!1},EZ3.IndexBuffer.prototype=Object.create(EZ3.Buffer.prototype),EZ3.IndexBuffer.prototype.constructor=EZ3.IndexBuffer,EZ3.IndexBuffer.prototype.bind=function(a){EZ3.Buffer.prototype.bind.call(this,a,a.ELEMENT_ARRAY_BUFFER)},EZ3.IndexBuffer.prototype.update=function(a,b){var c;if(this.need32Bits){if(!b.elementIndexUInt)return;c=4}else c=2;EZ3.Buffer.prototype.update.call(this,a,a.ELEMENT_ARRAY_BUFFER,c)},EZ3.IndexBuffer.prototype.getGLType=function(a,b){return b.elementIndexUInt&&this.need32Bits?a.UNSIGNED_INT:a.UNSIGNED_SHORT},EZ3.IndexBuffer.TRIANGULAR=1,EZ3.IndexBuffer.LINEAR=2,EZ3.VertexBuffer=function(a,b){EZ3.Buffer.call(this,a,b),this._attributes={},this._stride=0},EZ3.VertexBuffer.prototype=Object.create(EZ3.Buffer.prototype),EZ3.VertexBuffer.prototype.constructor=EZ3.VertexBuffer,EZ3.VertexBuffer.prototype.isValid=function(a,b){var c;for(c in this._attributes)if(b[c]>=0)return!0;return!1},EZ3.VertexBuffer.prototype.bind=function(a,b,c){var d,e,f,g,h,i=a.FLOAT;EZ3.Buffer.prototype.bind.call(this,a,a.ARRAY_BUFFER);for(h in this._attributes)f=b[h],g=this._attributes[h].size,e=this._attributes[h].offset,d=this._attributes[h].normalized,f>=0&&(c?c.enableVertexAttribArray(f):a.enableVertexAttribArray(f),a.vertexAttribPointer(f,g,i,d,this._stride,e))},EZ3.VertexBuffer.prototype.update=function(a){EZ3.Buffer.prototype.update.call(this,a,a.ARRAY_BUFFER,4)},EZ3.VertexBuffer.prototype.addAttribute=function(a,b){this._stride+=4*b.size,this._attributes[a]=b},EZ3.MousePointer=function(){EZ3.Pointer.call(this),this._buttons=[],this.wheel=new EZ3.Vector2,this.movement=new EZ3.Vector2,this.locked=!1},EZ3.MousePointer.prototype=Object.create(EZ3.Pointer.prototype),EZ3.MousePointer.prototype.constructor=EZ3.MousePointer,EZ3.MousePointer.prototype.processPress=function(a,b,c,d,e){this._buttons[a.button]||(this._buttons[a.button]=new EZ3.Switch(a.button)),this._buttons[a.button].processPress(),EZ3.Pointer.prototype.processPress.call(this,a,b,c),d.dispatch(this._buttons[a.button]),e.dispatch(this)},EZ3.MousePointer.prototype.processMove=function(a,b,c,d){this.locked?(this.movement.x=a.movementX||a.mozMovementX||0,this.movement.y=a.movementY||a.mozMovementY||0):EZ3.Pointer.prototype.processMove.call(this,a,b,c),d.dispatch(this)},EZ3.MousePointer.prototype.processUp=function(a,b){this._buttons[a.button]||(this._buttons[a.button]=new EZ3.Switch(a.button)),this._buttons[a.button].processUp(),b.dispatch(this._buttons[a.button])},EZ3.MousePointer.prototype.processWheel=function(a,b){this.wheel.x=a.wheelDeltaX||a.deltaX,this.wheel.y=a.wheelDeltaY||a.deltaY,b.dispatch(this.wheel)},EZ3.MousePointer.prototype.processLockChange=function(a){this.locked=!this.locked,a.dispatch(this.locked)},EZ3.MousePointer.prototype.getButton=function(a){return this._buttons[a]||(this._buttons[a]=new EZ3.Switch(a)),this._buttons[a]},EZ3.TouchPointer=function(a,b){EZ3.Pointer.call(this),EZ3.Switch.call(this,a),this.id=void 0!==b?b:0},EZ3.TouchPointer.prototype=Object.create(EZ3.Pointer.prototype),EZ3["extends"](EZ3.TouchPointer.prototype,EZ3.Switch.prototype),EZ3.TouchPointer.prototype.constructor=EZ3.TouchPointer,EZ3.TouchPointer.prototype.processPress=function(a,b,c,d,e){EZ3.Pointer.prototype.processPress.call(this,a,b,c),EZ3.Switch.prototype.processPress.call(this),this.last.page.copy(this.current.position),this.last.client.copy(this.current.client),this.last.screen.copy(this.current.screen),this.last.position.copy(this.current.position),d.dispatch(this),e.dispatch(this)},EZ3.TouchPointer.prototype.processMove=function(a,b,c,d){EZ3.Pointer.prototype.processMove.call(this,a,b,c),d.dispatch(this)},EZ3.TouchPointer.prototype.processUp=function(a){EZ3.Switch.prototype.processUp.call(this),a.dispatch(this)},EZ3.Image=function(a,b,c,d){EZ3.File.call(this,d),this.width=void 0!==a?a:0,this.height=void 0!==b?b:0,this.format=void 0!==c?c:EZ3.Image.RGBA},EZ3.Image.prototype=Object.create(EZ3.File.prototype),EZ3.Image.prototype.constructor=EZ3.Image,EZ3.Image.prototype.getGLFormat=function(a){return this.format===EZ3.Image.RGB_FORMAT?a.RGB:a.RGBA},EZ3.Image.prototype.getCanvas=function(){var a=document.createElement("canvas"),b=a.getContext("2d"),c=b.createImageData(this.width,this.height);return a.width=this.width,a.height=this.height,c.data.set(new Uint8ClampedArray(this.data)),b.putImageData(c,0,0),a},EZ3.Image.prototype.toPowerOfTwo=function(){var a=document.createElement("canvas"),b=a.getContext("2d");return a.width=EZ3.Math.nextHighestPowerOfTwo(this.width),a.height=EZ3.Math.nextHighestPowerOfTwo(this.height),b.drawImage(this.getCanvas(),0,0,this.width,this.height,0,0,a.width,a.height),this.width=a.width,this.height=a.height,this.data=new Uint8Array(b.getImageData(0,0,a.width,a.height).data),this},EZ3.Image.prototype.download=function(){var a=document.createElement("a");a.href=this.getCanvas().toDataURL(),a.download="output.png",document.body.appendChild(a),a.click(),document.body.removeChild(a)},EZ3.Image.RGB_FORMAT=1,EZ3.Image.RGBA_FORMAT=2,EZ3.FileRequest=function(a,b,c,d){EZ3.Request.call(this,a,new EZ3.File,b,c),this._request=new XMLHttpRequest,this.responseType=d},EZ3.FileRequest.prototype=Object.create(EZ3.Request.prototype),EZ3.FileRequest.prototype.constructor=EZ3.FileRequest,EZ3.FileRequest.prototype._processLoad=function(a,b){this._removeEventListeners(),this.asset.data=a.response,b(this.url,this.asset,this.cached)},EZ3.FileRequest.prototype._processError=function(a){this._removeEventListeners(),a(this.url)},EZ3.FileRequest.prototype._addEventListeners=function(a,b){var c=this;this._onLoad=function(){c._processLoad(this,a)},this._onError=function(){c._processError(b)},this._request.addEventListener("load",this._onLoad,!1),this._request.addEventListener("error",this._onError,!1)},EZ3.FileRequest.prototype._removeEventListeners=function(){this._request.removeEventListener("load",this._onLoad,!1),this._request.removeEventListener("error",this._onError,!1),delete this._onLoad,delete this._onError},EZ3.FileRequest.prototype.send=function(a,b){this._request.open("GET",this.url,!0),this._addEventListeners(a,b),this.crossOrigin&&(this._request.crossOrigin=this.crossOrigin),this.responseType&&(this._request.responseType=this.responseType),this._request.send(null)},EZ3.ImageRequest=function(a,b,c){EZ3.Request.call(this,a,new EZ3.Image,b,c),this._request=new Image},EZ3.ImageRequest.prototype=Object.create(EZ3.Request.prototype),EZ3.ImageRequest.prototype.constructor=EZ3.ImageRequest,EZ3.ImageRequest.prototype._processLoad=function(a,b){var c=document.createElement("canvas"),d=c.getContext("2d");c.width=a.width,c.height=a.height,d.drawImage(a,0,0),this.asset.width=a.width,this.asset.height=a.height,this.asset.data=new Uint8Array(d.getImageData(0,0,a.width,a.height).data),this._removeEventListeners(),b(this.url,this.asset,this.cached)},EZ3.ImageRequest.prototype._processError=function(a){this._removeEventListeners(),a(this.url)},EZ3.ImageRequest.prototype._addEventListeners=function(a,b){var c=this;this._onLoad=function(){c._processLoad(this,a)},this._onError=function(){c._processError(b)},this._request.addEventListener("load",this._onLoad,!1),this._request.addEventListener("error",this._onError,!1)},EZ3.ImageRequest.prototype._removeEventListeners=function(){this._request.removeEventListener("load",this._onLoad,!1),this._request.removeEventListener("error",this._onError,!1),delete this._onLoad,delete this._onError},EZ3.ImageRequest.prototype.send=function(a,b){this._addEventListeners(a,b),this.crossOrigin||(this._request.crossOrigin=this.crossOrigin),this._request.src=this.url},EZ3.MD2Request=function(a,b,c){EZ3.Request.call(this,a,new EZ3.Mesh,b,c)},EZ3.MD2Request.prototype=Object.create(EZ3.Request.prototype),EZ3.MD2Request.prototype.constructor=EZ3.MD2Request,EZ3.MD2Request.prototype._parse=function(a,b,c){},EZ3.MD2Request.prototype.send=function(a,b){var c=this,d=new EZ3.RequestManager;d.addFileRequest(this.url,this.cached,this.crossOrigin,"arraybuffer"),d.onComplete.add(function(d,e){return e?b(c.url):void c._parse(d.get(c.url).data,a,b)}),d.send()},EZ3.MDLRequest=function(a,b,c){EZ3.Request.call(this,a,new EZ3.Mesh,b,c)},EZ3.MDLRequest.prototype=Object.create(EZ3.Request.prototype),EZ3.MDLRequest.prototype.constructor=EZ3.MDLRequest,EZ3.MDLRequest.prototype._parse=function(a,b,c){function d(b,c){var d,e,f,g,h=b.skinWidth*b.skinHeight;for(f=0;f<b.numSkins;f++){for(d=[],j+=4,g=0;h>g;g++)d.push(a.getUint8(j++,!0));for(e=new EZ3.Image(b.skinWidth,b.skinHeight,EZ3.Image.RGBA,new Uint8Array(4*h)),g=0;h>g;g++)e.data[4*g]=k[d[g]][0],e.data[4*g+1]=k[d[g]][1],e.data[4*g+2]=k[d[g]][2],e.data[4*g+3]=255;c.push(new EZ3.Texture2D(e))}}function e(b,c,d){var e;for(e=0;e<b.numVerts;e++)c.push(a.getInt32(j,!0)),d.push(a.getInt32(j+4,!0)),d.push(a.getInt32(j+8,!0)),j+=12}function f(b,c,d){var e,f;for(e=0;e<b.numTris;e++){for(c.push(a.getInt32(j,!0)),f=0;3>f;f++)d.push(a.getInt32(j+4*(f+1),!0));j+=16}}function g(b,c){var d,e,f,g;for(e=0;e<b.numFrames;e++){for(c[e]={name:[],vertices:[],normals:[]},j+=12,f=0;16>f&&(d=a.getInt8(j+f,!0),0!==d);f++)c[e].name.push(d);for(c[e].name=String.fromCharCode.apply(null,c[e].name),j+=16,f=0;f<b.numVerts;f++){for(g=2;g>=0;g--)c[e].vertices.push(b.scale[g]*a.getUint8(j+g,!0)+b.translate[g]);j+=3,c[e].normals.push(a.getUint8(j++,!0))}}}function h(){var h,k,l,m,n,o=[],p=[],q=[],r=[],s=[],t=[];if(a=new DataView(a),h={ident:a.getInt32(j,!0),version:a.getInt32(j+4,!0),scale:[a.getFloat32(j+8,!0),a.getFloat32(j+12,!0),a.getFloat32(j+16,!0)],translate:[a.getFloat32(j+20,!0),a.getFloat32(j+24,!0),a.getFloat32(j+28,!0)],numSkins:a.getInt32(j+48,!0),skinWidth:a.getInt32(j+52,!0),skinHeight:a.getInt32(j+56,!0),numVerts:a.getInt32(j+60,!0),numTris:a.getInt32(j+64,!0),numFrames:a.getInt32(j+68,!0)},1330660425!==h.ident||6!==h.version)return c(i.url);j+=84,d(h,o),e(h,p,q),f(h,r,s),g(h,t);var u={},v=h.numVerts;for(l=0;l<h.numTris;l++)for(m=0;3>m;m++)if(k=3*l+m,!r[l]&&p[s[k]]){if(!u[s[k]]){for(n=0;n<h.numFrames;n++)t[n].vertices.push(t[n].vertices[3*s[k]]),t[n].vertices.push(t[n].vertices[3*s[k]+1]),t[n].vertices.push(t[n].vertices[3*s[k]+2]);q.push(q[2*s[k]]+.5*h.skinWidth),q.push(q[2*s[k]+1]),u[s[k]]=v++}s[k]=u[s[k]]}for(l=0;l<q.length/2;l++)m=2*l,q[m]=(q[m]+.5)/h.skinWidth,q[m+1]=(q[m+1]+.5)/h.skinHeight;i.asset.geometry.buffers.setTriangles(s,t[0].vertices.length/3>EZ3.Math.MAX_USHORT),i.asset.geometry.buffers.setPositions(t[0].vertices),i.asset.geometry.buffers.setUVs(q),i.asset.material.diffuseMap=o[0],b(i.url,i.asset)}var i=this,j=0,k=[[0,0,0],[15,15,15],[31,31,31],[47,47,47],[63,63,63],[75,75,75],[91,91,91],[107,107,107],[123,123,123],[139,139,139],[155,155,155],[171,171,171],[187,187,187],[203,203,203],[219,219,219],[235,235,235],[15,11,7],[23,15,11],[31,23,11],[39,27,15],[47,35,19],[55,43,23],[63,47,23],[75,55,27],[83,59,27],[91,67,31],[99,75,31],[107,83,31],[115,87,31],[123,95,35],[131,103,35],[143,111,35],[11,11,15],[19,19,27],[27,27,39],[39,39,51],[47,47,63],[55,55,75],[63,63,87],[71,71,103],[79,79,115],[91,91,127],[99,99,139],[107,107,151],[115,115,163],[123,123,175],[131,131,187],[139,139,203],[0,0,0],[7,7,0],[11,11,0],[19,19,0],[27,27,0],[35,35,0],[43,43,7],[47,47,7],[55,55,7],[63,63,7],[71,71,7],[75,75,11],[83,83,11],[91,91,11],[99,99,11],[107,107,15],[7,0,0],[15,0,0],[23,0,0],[31,0,0],[39,0,0],[47,0,0],[55,0,0],[63,0,0],[71,0,0],[79,0,0],[87,0,0],[95,0,0],[103,0,0],[111,0,0],[119,0,0],[127,0,0],[19,19,0],[27,27,0],[35,35,0],[47,43,0],[55,47,0],[67,55,0],[75,59,7],[87,67,7],[95,71,7],[107,75,11],[119,83,15],[131,87,19],[139,91,19],[151,95,27],[163,99,31],[175,103,35],[35,19,7],[47,23,11],[59,31,15],[75,35,19],[87,43,23],[99,47,31],[115,55,35],[127,59,43],[143,67,51],[159,79,51],[175,99,47],[191,119,47],[207,143,43],[223,171,39],[239,203,31],[255,243,27],[11,7,0],[27,19,0],[43,35,15],[55,43,19],[71,51,27],[83,55,35],[99,63,43],[111,71,51],[127,83,63],[139,95,71],[155,107,83],[167,123,95],[183,135,107],[195,147,123],[211,163,139],[227,179,151],[171,139,163],[159,127,151],[147,115,135],[139,103,123],[127,91,111],[119,83,99],[107,75,87],[95,63,75],[87,55,67],[75,47,55],[67,39,47],[55,31,35],[43,23,27],[35,19,19],[23,11,11],[15,7,7],[187,115,159],[175,107,143],[163,95,131],[151,87,119],[139,79,107],[127,75,95],[115,67,83],[107,59,75],[95,51,63],[83,43,55],[71,35,43],[59,31,35],[47,23,27],[35,19,19],[23,11,11],[15,7,7],[219,195,187],[203,179,167],[191,163,155],[175,151,139],[163,135,123],[151,123,111],[135,111,95],[123,99,83],[107,87,71],[95,75,59],[83,63,51],[67,51,39],[55,43,31],[39,31,23],[27,19,15],[15,11,7],[111,131,123],[103,123,111],[95,115,103],[87,107,95],[79,99,87],[71,91,79],[63,83,71],[55,75,63],[47,67,55],[43,59,47],[35,51,39],[31,43,31],[23,35,23],[15,27,19],[11,19,11],[7,11,7],[255,243,27],[239,223,23],[219,203,19],[203,183,15],[187,167,15],[171,151,11],[155,131,7],[139,115,7],[123,99,7],[107,83,0],[91,71,0],[75,55,0],[59,43,0],[43,31,0],[27,15,0],[11,7,0],[0,0,255],[11,11,239],[19,19,223],[27,27,207],[35,35,191],[43,43,175],[47,47,159],[47,47,143],[47,47,127],[47,47,111],[47,47,95],[43,43,79],[35,35,63],[27,27,47],[19,19,31],[11,11,15],[43,0,0],[59,0,0],[75,7,0],[95,7,0],[111,15,0],[127,23,7],[147,31,7],[163,39,11],[183,51,15],[195,75,27],[207,99,43],[219,127,59],[227,151,79],[231,171,95],[239,191,119],[247,211,139],[167,123,59],[183,155,55],[199,195,55],[231,227,87],[127,191,255],[171,231,255],[215,255,255],[103,0,0],[139,0,0],[179,0,0],[215,0,0],[255,0,0],[255,243,147],[255,247,199],[255,255,255],[159,91,83]];h()},EZ3.MDLRequest.prototype.send=function(a,b){var c=this,d=new EZ3.RequestManager;d.addFileRequest(this.url,this.cached,this.crossOrigin,"arraybuffer"),d.onComplete.add(function(d,e){return e?b(c.url):void c._parse(d.get(c.url).data,a,b)}),d.send()},EZ3.OBJRequest=function(a,b,c){EZ3.Request.call(this,a,new EZ3.Entity,b,c)},EZ3.OBJRequest.prototype=Object.create(EZ3.Request.prototype),EZ3.OBJRequest.prototype.constructor=EZ3.OBJRequest,EZ3.OBJRequest.prototype._parseMTL=function(a,b,c,d){function e(a){var b=a.split(" ");return new EZ3.Vector3(parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2]))}function f(a){var b,c=e(a);for(b=0;b<k.length;b++)k[b].diffuse=c}function g(a){var b,c=e(a);for(b=0;b<k.length;b++)k[b].specular=c}function h(a,b){var c;if(a=parseFloat(a),b&&(a=1-a),!(a>=1))for(c=0;c<k.length;c++);}function i(b){var c,e=new EZ3.Texture2D(d.addImageRequest(a+b,l.cached,l.crossOrigin));for(c=0;c<k.length;c++)k[c].diffuseMap=e}function j(){var a,d,e,j,l,m=b.split("\n");for(j=0;j<m.length;j++)a=m[j].trim(),l=a.indexOf(" "),d=l>=0?a.substring(0,l):a,d=d.toLowerCase(),e=l>=0?a.substring(l+1):"",e=e.trim(),"newmtl"===d?k=c[e]:k&&("kd"===d?f(e):"ks"===d?g(e):"map_kd"===d?i(e):"d"===d?h(e):"tr"===d&&h(e,!0))}var k,l=this;j()},EZ3.OBJRequest.prototype._parseOBJ=function(a,b){function c(a){var b,c=[];for(a=a.split(" "),b=1;b<a.length-1;b++)c.push(a[0],a[b],a[b+1]);return c}function d(a){var b;for(b=1;4>b;b++)s.push(parseFloat(a[b]))}function e(a){var b;for(b=1;4>b;b++)t.push(parseFloat(a[b]))}function f(a){var b;for(b=1;3>b;b++)u.push(parseFloat(a[b]))}function g(a){return a=parseInt(a),0>=a?s.length/3+a:a-1}function h(a){return a=parseInt(a),0>=a?t.length/3+a:a-1}function i(a){return a=parseInt(a),0>=a?u.length/2+a:a-1}function j(a){var b,c,d,e;for(d=0;d<a.length;d++)if(b=g(a[d]),void 0===r[b])for(c=w.length/3,r[b]=c,v.push(c),e=0;3>e;e++)w.push(s[3*b+e]);else v.push(r[b])}function k(a){var b,c,d,e,f,h,j;for(h=0;h<a.length;h++){for(b=a[h].split("/"),c=g(b[0]),d=i(b[1]),e=-1,f=w.length/3,r[c]||(r[c]=[]),j=0;j<r[c].length;j++)if(r[c][j].uv===d){e=r[c][j].index;break}if(e>=0)v.push(e);else{for(r[c].push({uv:d,index:f}),v.push(f),j=0;3>j;j++)w.push(s[3*c+j]);y.push(u[2*d]),y.push(1-u[2*d+1])}}}function l(a){var b,c,d,e,f,j,k,l;for(k=0;k<a.length;k++){for(b=a[k].split("/"),c=g(b[0]),d=i(b[1]),e=h(b[2]),f=-1,j=w.length/3,r[c]||(r[c]=[]),l=0;l<r[c].length;l++)if(r[c][l].uv===d&&r[c][l].normal===e){f=r[c][l].index;break}if(f>=0)v.push(f);else{for(r[c].push({uv:d,normal:e,index:j}),v.push(j),l=0;3>l;l++)w.push(s[3*c+l]);for(l=0;3>l;l++)x.push(t[3*e+l]);y.push(u[2*d]),y.push(1-u[2*d+1])}}}function m(a){var b,c,d,e,f,i,j;for(i=0;i<a.length;i++){for(b=a[i].split("//"),c=g(b[0]),d=h(b[1]),e=-1,f=w.length/3,r[c]||(r[c]=[]),j=0;j<r[c].length;j++)if(r[c][j].normal===d){e=r[c][j].index;break}if(e>=0)v.push(e);else{for(r[c].push({normal:d,index:f}),v.push(f),j=0;3>j;j++)w.push(s[3*c+j]);for(j=0;3>j;j++)x.push(t[3*d+j])}}}function n(a){return v.length?(a.geometry.buffers.setTriangles(v,w.length/3>EZ3.Math.MAX_USHORT),a.geometry.buffers.setPositions(w),y.length&&(a.geometry.buffers.setUVs(y),y=[]),x.length&&(a.geometry.buffers.setNormals(x),x=[]),r=[],v=[],w=[],q.asset.add(a),new EZ3.Mesh):a}function o(a,c){var d,e=new EZ3.RequestManager,f=EZ3.toBaseUrl(q.url),g=[];for(d=0;d<a.length;d++)g.push(e.addFileRequest(f+a[d],q.cached,q.crossOrigin));e.onComplete.add(function(){for(d=0;d<g.length;d++)q._parseMTL(f,g[d].data,c,e);e.onComplete.removeAll(),e.onComplete.add(function(){b(q.url,q.asset)}),e.start()}),e.start()}function p(){var b,g,h,i=new EZ3.Mesh,p=[],q=[],r=a.split("\n");for(h=0;h<r.length;h++)b=r[h].trim().replace(/ +(?= )/g,""),0!==b.length&&"#"!==b.charAt(0)&&((g=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/.exec(b))?d(g):(g=/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/.exec(b))?e(g):(g=/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/.exec(b))?f(g):(g=/f\s(([+-]?\d+\s){2,}[+-]?\d+)/.exec(b))?j(c(g[1])):(g=/f\s(([+-]?\d+\/[+-]?\d+\s){2,}[+-]?\d+\/[+-]?\d+)/.exec(b))?k(c(g[1])):(g=/f\s((([+-]?\d+\/[+-]?\d+\/[+-]?\d+\s){2,})[+-]?\d+\/[+-]?\d+\/[+-]?\d+)/.exec(b))?l(c(g[1])):(g=/f\s(([+-]?\d+\/\/[+-]?\d+\s){2,}[+-]?\d+\/\/[+-]?\d+)/.exec(b))?m(c(g[1])):/^mtllib/.test(b)?p.push(b.substring(7).trim()):/^o/.test(b)||/^g/.test(b)?(i=n(i),i.name=b.substring(2).trim()):/^usemtl/.test(b)&&(i=n(i),i.material.name=b.substring(7).trim(),q[i.material.name]||(q[i.material.name]=[]),q[i.material.name].push(i.material)));n(i),o(p,q)}var q=this,r=[],s=[],t=[],u=[],v=[],w=[],x=[],y=[];p()},EZ3.OBJRequest.prototype.send=function(a,b){var c=this,d=new EZ3.RequestManager;d.addFileRequest(this.url,this.crossOrigin),d.onComplete.add(function(d,e){return e?b(c.url,!0):void c._parseOBJ(d.get(c.url).data,a)}),d.send()},EZ3.OFFRequest=function(a,b,c){EZ3.Request.call(this,a,new EZ3.Mesh,b,c)},EZ3.OFFRequest.prototype=Object.create(EZ3.Request.prototype),EZ3.OFFRequest.prototype.constructor=EZ3.OFFRequest,EZ3.OFFRequest.prototype._parse=function(a,b,c){function d(a){var b,c,d=[];for(a=a.split(" "),b=parseInt(a[0]),c=2;b>c;c++)d.push(a[1],a[c],a[c+1]);return d}function e(a){var b;for(b=0;3>b;b++)j.push(parseFloat(a[b]))}function f(a){var b;for(b=0;b<a.length;b++)i.push(parseInt(a[b]))}function g(){var g,k,l,m=a.split("\n"),n=0,o=0;for(l=m[o++],/OFF/g.exec(l)||c(h.url),l=m[o++].trim().replace(/ +(?= )/g,"").split(" "),g=parseInt(l[0]),k=parseInt(l[1]);g>n;)l=m[o++].trim().replace(/ +(?= )/g,""),0!==l.length&&"#"!==l.charAt(0)&&(e(l.split(" ")),n++);for(n=0;k>n;)l=m[o++].trim().replace(/ +(?= )/g,""),0!==l.length&&"#"!==l.charAt(0)&&(f(d(l)),n++);h.asset.geometry.buffers.setTriangles(i,j.length/3>EZ3.Math.MAX_USHORT),h.asset.geometry.buffers.setPositions(j),b(h.url,h.asset)}var h=this,i=[],j=[];g()},EZ3.OFFRequest.prototype.send=function(a,b){var c=this,d=new EZ3.RequestManager;d.addFileRequest(this.url,this.cached,this.crossOrigin),d.onComplete.add(function(d,e){return e?b(c.url):void c._parse(d.get(c.url).data,a,b)}),d.send()},EZ3.TGARequest=function(a,b,c){EZ3.Request.call(this,a,new EZ3.Image,b,c)},EZ3.TGARequest.prototype=Object.create(EZ3.Request.prototype),EZ3.TGARequest.prototype.constructor=EZ3.TGARequest,EZ3.TGARequest.prototype._parse=function(a,b,c){
function d(a){switch(a.imageType){case o:case r:(a.colormapLength>256||24!==a.colormapSize||1!==a.colormapType)&&c(A.url);break;case p:case q:case s:case t:a.colormapType&&c(A.url);break;case n:c(A.url);break;default:c(A.url)}(a.width<=0||a.height<=0)&&c(A.url),8!==a.pixelSize&&16!==a.pixelSize&&24!==a.pixelSize&&32!==a.pixelSize&&c(A.url)}function e(a,b,c,d,e){var f,g,h,i,j,k,l,m=c.pixelSize>>3,n=c.width*c.height*m;if(b&&(g=e.subarray(d,d+=c.colormapLength*(c.colormapSize>>3))),a)for(f=new Uint8Array(n),h=new Uint8Array(m),i=0;n>i;)if(k=e[d++],j=(127&k)+1,128&k){for(l=0;m>l;++l)h[l]=e[d++];for(l=0;j>l;++l)f.set(h,i+l*m);i+=m*j}else{for(j*=m,l=0;j>l;++l)f[i+l]=e[d++];i+=j}else f=e.subarray(d,d+=b?c.width*c.height:n);return{pixelData:f,palettes:g}}function f(a,b,c,d,e,f,g,h,i,j){var k,l,m,n=j,o=0;for(m=c;m!==e;m+=d)for(l=f;l!==h;l+=g,o++)k=i[o],b[4*(l+a*m)+3]=255,b[4*(l+a*m)+2]=n[3*k+0],b[4*(l+a*m)+1]=n[3*k+1],b[4*(l+a*m)+0]=n[3*k+2];return b}function g(a,b,c,d,e,f,g,h,i){var j,k,l,m=0;for(l=c;l!==e;l+=d)for(k=f;k!==h;k+=g,m+=2)j=i[m+0]+(i[m+1]<<8),b[4*(k+a*l)+0]=(31744&j)>>7,b[4*(k+a*l)+1]=(992&j)>>2,b[4*(k+a*l)+2]=(31&j)>>3,b[4*(k+a*l)+3]=32768&j?0:255;return b}function h(a,b,c,d,e,f,g,h,i){var j,k,l=0;for(k=c;k!==e;k+=d)for(j=f;j!==h;j+=g,l+=3)b[4*(j+a*k)+3]=255,b[4*(j+a*k)+2]=i[l+0],b[4*(j+a*k)+1]=i[l+1],b[4*(j+a*k)+0]=i[l+2];return b}function i(a,b,c,d,e,f,g,h,i){var j,k,l=0;for(k=c;k!==e;k+=d)for(j=f;j!==h;j+=g,l+=4)b[4*(j+a*k)+2]=i[l+0],b[4*(j+a*k)+1]=i[l+1],b[4*(j+a*k)+0]=i[l+2],b[4*(j+a*k)+3]=i[l+3];return b}function j(a,b,c,d,e,f,g,h,i){var j,k,l,m=0;for(l=c;l!==e;l+=d)for(k=f;k!==h;k+=g,m++)j=i[m],b[4*(k+a*l)+0]=j,b[4*(k+a*l)+1]=j,b[4*(k+a*l)+2]=j,b[4*(k+a*l)+3]=255;return b}function k(a,b,c,d,e,f,g,h,i){var j,k,l=0;for(k=c;k!==e;k+=d)for(j=f;j!==h;j+=g,l+=2)b[4*(j+a*k)+0]=i[l+0],b[4*(j+a*k)+1]=i[l+0],b[4*(j+a*k)+2]=i[l+0],b[4*(j+a*k)+3]=i[l+1];return b}function l(a,b,d,e){var l,m,n,o,p,q,r=b.width,s=b.height,t=new Uint8Array(r*s*4);switch((b.flags&u)>>v){default:case y:l=0,n=1,p=r,m=0,o=1,q=s;break;case w:l=0,n=1,p=r,m=s-1,o=-1,q=-1;break;case z:l=r-1,n=-1,p=-1,m=0,o=1,q=s;break;case x:l=r-1,n=-1,p=-1,m=s-1,o=-1,q=-1}if(a)switch(b.pixelSize){case 8:j(r,t,m,o,q,l,n,p,d);break;case 16:k(r,t,m,o,q,l,n,p,d);break;default:c(A.url)}else switch(b.pixelSize){case 8:f(r,t,m,o,q,l,n,p,d,e);break;case 16:g(r,t,m,o,q,l,n,p,d);break;case 24:h(r,t,m,o,q,l,n,p,d);break;case 32:i(r,t,m,o,q,l,n,p,d);break;default:c(A.url)}return t}function m(){var f,g,h,i,j=!1,k=!1,m=!1;switch(a.length<19&&c(A.url),f=new Uint8Array(a),g=0,h={idLenght:f[g++],colormapType:f[g++],imageType:f[g++],colormapIndex:f[g++]|f[g++]<<8,colormapLength:f[g++]|f[g++]<<8,colormapSize:f[g++],origin:[f[g++]|f[g++]<<8,f[g++]|f[g++]<<8],width:f[g++]|f[g++]<<8,height:f[g++]|f[g++]<<8,pixelSize:f[g++],flags:f[g++]},d(h),h.idLenght+g>a.length&&c(A.url),g+=h.idLenght,h.imageType){case r:j=!0,k=!0;break;case o:k=!0;break;case s:j=!0;break;case p:break;case t:j=!0,m=!0;break;case q:m=!0}i=e(j,k,h,g,f),A.asset.data=l(m,h,i.pixelData,i.palettes),A.asset.width=h.width,A.asset.height=h.height,b(A.url,A.asset,A.cached)}var n=0,o=1,p=2,q=3,r=9,s=10,t=11,u=48,v=4,w=0,x=1,y=2,z=3,A=this;m()},EZ3.TGARequest.prototype.send=function(a,b){var c=this,d=new EZ3.RequestManager;d.addFileRequest(this.url,!1,this.crossOrigin,"arraybuffer"),d.onComplete.add(function(d,e){return e?b(c.url):void c._parse(d.get(c.url).data,a)}),d.send()},EZ3.MeshMaterial=function(){EZ3.Material.call(this),this.emissive=new EZ3.Vector3,this.diffuse=new EZ3.Vector3(.8,.8,.8),this.specular=new EZ3.Vector3(.2,.2,.2),this.shading=EZ3.MeshMaterial.SMOOTH,this.normalMap=null,this.diffuseMap=null,this.emissiveMap=null,this.specularMap=null,this.environmentMap=null,this.reflective=!1,this.refractive=!1,this.diffuseReflection=EZ3.MeshMaterial.LAMBERT,this.specularReflection=EZ3.MeshMaterial.BLINN_PHONG,this.albedo=3,this.fresnel=0,this.opacity=1,this.shininess=180,this.refractiveIndex=1,this.diffuseRoughness=.2,this.specularRoughness=.2,this.morphTarget=!1,this.tick=0},EZ3.MeshMaterial.prototype=Object.create(EZ3.Material.prototype),EZ3.MeshMaterial.prototype.constructor=EZ3.Material,EZ3.MeshMaterial.prototype.updateProgram=function(a,b,c,d){var e="MESH.",f=[],g="#define ";f.push("MAX_POINT_LIGHTS "+c.point.length),f.push("MAX_DIRECTIONAL_LIGHTS "+c.directional.length),f.push("MAX_SPOT_LIGHTS "+c.spot.length),this.morphTarget&&f.push("MORPH_TARGET"),this.shading===EZ3.MeshMaterial.FLAT&&f.push("FLAT"),this.diffuseReflection===EZ3.MeshMaterial.OREN_NAYAR?f.push("OREN_NAYAR"):f.push("LAMBERT"),this.specularReflection===EZ3.MeshMaterial.BLINN_PHONG?f.push("BLINN_PHONG"):this.specularReflection===EZ3.MeshMaterial.COOK_TORRANCE?f.push("COOK_TORRANCE"):f.push("PHONG"),this.emissiveMap instanceof EZ3.Texture2D&&f.push("EMISSIVE_MAP"),this.diffuseMap instanceof EZ3.Texture2D&&f.push("DIFFUSE_MAP"),this.normalMap instanceof EZ3.Texture2D&&f.push("NORMAL_MAP"),this.environmentMap instanceof EZ3.Cubemap&&(f.push("ENVIRONMENT_MAP"),this.reflective&&f.push("REFLECTION"),this.refractive&&f.push("REFRACTION")),d&&f.push("SHADOW_MAP"),e+=f.join("."),g+=f.join("\n "+g)+"\n",this._id!==e&&(this._id=e,this.program=b.createProgram(e,EZ3.ShaderLibrary.mesh.vertex,EZ3.ShaderLibrary.mesh.fragment,g))},EZ3.MeshMaterial.prototype.updateUniforms=function(a,b,c){this.program.loadUniformFloat(a,"uEmissive",this.emissive),this.program.loadUniformFloat(a,"uDiffuse",this.diffuse),this.program.loadUniformFloat(a,"uSpecular",this.specular),this.program.loadUniformFloat(a,"uShininess",this.shininess),this.program.loadUniformFloat(a,"uOpacity",this.opacity),this.morphTarget&&(this.program.loadUniformFloat(a,"uInfluence1",this.tick),this.program.loadUniformFloat(a,"uInfluence2",1-this.tick),this.tick+=.01,this.tick>=1&&(this.tick=0)),this.emissiveMap instanceof EZ3.Texture2D&&(this.emissiveMap.bind(a,b,c),this.emissiveMap.update(a),this.program.loadUniformInteger(a,"uEmissiveSampler",b.usedTextureSlots++)),this.diffuseMap instanceof EZ3.Texture2D&&(this.diffuseMap.bind(a,b,c),this.diffuseMap.update(a),this.program.loadUniformInteger(a,"uDiffuseSampler",b.usedTextureSlots++)),this.normalMap instanceof EZ3.Texture2D&&(this.normalMap.bind(a,b,c),this.normalMap.update(a),this.program.loadUniformInteger(a,"uNormalSampler",b.usedTextureSlots++)),this.environmentMap instanceof EZ3.Cubemap&&(this.environmentMap.bind(a,b,c),this.environmentMap.update(a),this.program.loadUniformInteger(a,"uEnvironmentSampler",b.usedTextureSlots++)),this.refractive&&this.program.loadUniformFloat(a,"uRefractiveIndex",this.refractiveIndex),this.diffuseReflection===EZ3.MeshMaterial.OREN_NAYAR&&(this.program.loadUniformFloat(a,"uAlbedo",this.albedo),this.program.loadUniformFloat(a,"uDiffuseRoughness",this.diffuseRoughness)),this.specularReflection===EZ3.MeshMaterial.COOK_TORRANCE&&(this.program.loadUniformFloat(a,"uFresnel",this.fresnel),this.program.loadUniformFloat(a,"uSpecularRoughness",this.specularRoughness))},EZ3.MeshMaterial.FLAT=0,EZ3.MeshMaterial.SMOOTH=1,EZ3.MeshMaterial.LAMBERT=0,EZ3.MeshMaterial.OREN_NAYAR=1,EZ3.MeshMaterial.PHONG=2,EZ3.MeshMaterial.BLINN_PHONG=3,EZ3.MeshMaterial.COOK_TORRANCE=4,EZ3.ShaderMaterial=function(a,b,c){EZ3.Material.call(this,"SHADER."+a),this._vertex=b,this._fragment=c,this._uniformIntegers={},this._uniformFloats={},this._uniformMatrices={},this._uniformTextures={}},EZ3.ShaderMaterial.prototype=Object.create(EZ3.Material.prototype),EZ3.ShaderMaterial.prototype.constructor=EZ3.Material,EZ3.ShaderMaterial.prototype.updateProgram=function(a,b){this.program||(this.program=b.createProgram(this._id,this._vertex,this._fragment))},EZ3.ShaderMaterial.prototype.updateUniforms=function(a,b,c){var d,e;for(d in this._uniformIntegers)this.program.loadUniformInteger(a,d,this._uniformIntegers[d]);for(d in this._uniformFloats)this.program.loadUniformFloat(a,d,this._uniformFloats[d]);for(d in this._uniformMatrices)this.program.loadUniformMatrix(a,d,this._uniformMatrices[d]);for(d in this._uniformTextures)e=this._uniformTextures[d],e.bind(a,b,c),e.update(a),this.program.loadUniformInteger(a,d,b.usedTextureSlots++)},EZ3.ShaderMaterial.prototype.setUniformInteger=function(a,b){this._uniformIntegers[a]=b},EZ3.ShaderMaterial.prototype.setUniformFloat=function(a,b){this._uniformFloats[a]=b},EZ3.ShaderMaterial.prototype.setUniformMatrix=function(a,b){this._uniformMatrices[a]=b},EZ3.ShaderMaterial.prototype.setUniformTexture=function(a,b){this._uniformTextures[a]=b},EZ3.ShaderMaterial.prototype.getUniform=function(a){return this._uniformIntegers[a]?this._uniformIntegers[a]:this._uniformFloats[a]?this._uniformFloat[a]:this._uniformMatrices[a]?this._uniformMatrices[a]:this._uniformTextures[a]},EZ3.Cubemap=function(a,b,c,d,e,f,g){EZ3.Texture.call(this,g),this._images=[],this.setImage(EZ3.Cubemap.POSITIVE_X,a),this.setImage(EZ3.Cubemap.NEGATIVE_X,b),this.setImage(EZ3.Cubemap.POSITIVE_Y,c),this.setImage(EZ3.Cubemap.NEGATIVE_Y,d),this.setImage(EZ3.Cubemap.POSITIVE_Z,e),this.setImage(EZ3.Cubemap.NEGATIVE_Z,f)},EZ3.Cubemap.prototype=Object.create(EZ3.Texture.prototype),EZ3.Cubemap.prototype.contructor=EZ3.Cubemap,EZ3.Cubemap.prototype.bind=function(a,b,c){EZ3.Texture.prototype.bind.call(this,a,b,c,a.TEXTURE_CUBE_MAP)},EZ3.Cubemap.prototype.update=function(a){var b;if(this.needUpdate){for(b=0;6>b;b++)EZ3.Texture.prototype._updateImage.call(this,a,a.TEXTURE_CUBE_MAP_POSITIVE_X+b,this._images[b]);EZ3.Texture.prototype._updateMipmaps.call(this,a,a.TEXTURE_CUBE_MAP),this.needUpdate=!1}EZ3.Texture.prototype._updateParameters.call(this,a,a.TEXTURE_CUBE_MAP),EZ3.Texture.prototype._updatePixelStore.call(this,a)},EZ3.Cubemap.prototype.setImage=function(a,b){this._images[a]=b},EZ3.Cubemap.POSITIVE_X=0,EZ3.Cubemap.NEGATIVE_X=1,EZ3.Cubemap.POSITIVE_Y=2,EZ3.Cubemap.NEGATIVE_Y=3,EZ3.Cubemap.POSITIVE_Z=4,EZ3.Cubemap.NEGATIVE_Z=5,EZ3.Texture2D=function(a,b){EZ3.Texture.call(this,b),this.image=a},EZ3.Texture2D.prototype=Object.create(EZ3.Texture.prototype),EZ3.Texture2D.prototype.constructor=EZ3.Texture2D,EZ3.Texture2D.prototype.bind=function(a,b,c){EZ3.Texture.prototype.bind.call(this,a,b,c,a.TEXTURE_2D)},EZ3.Texture2D.prototype.update=function(a){this.needUpdate&&(EZ3.Texture.prototype._updateImage.call(this,a,a.TEXTURE_2D,this.image),EZ3.Texture.prototype._updateMipmaps.call(this,a,a.TEXTURE_2D),this.needUpdate=!1),EZ3.Texture.prototype._updateParameters.call(this,a,a.TEXTURE_2D),EZ3.Texture.prototype._updatePixelStore.call(this,a)},EZ3.FreeControl=function(a,b,c){EZ3.CameraControl.call(this,a,b,c)},EZ3.FreeControl.prototype=Object.create(EZ3.CameraControl.prototype),EZ3.FreeControl.prototype.constructor=EZ3.FreeControl,EZ3.FreeControl.prototype.rotate=function(a,b,c){var d;EZ3.CameraControl.prototype.rotate.call(this,a,b,c),d=(new EZ3.Matrix4).yawPitchRoll(this.yaw,this.pitch,this.roll),this.up=new EZ3.Vector4(0,1,0,0).mulMatrix4(d).toVector3(),this.look=new EZ3.Vector4(0,0,1,0).mulMatrix4(d).toVector3(),this.right=new EZ3.Vector4(-1,0,0,0).mulMatrix4(d).toVector3(),this.target=(new EZ3.Vector3).add(this.entity.position,this.look),this.entity.lookAt(this.target,this.up)},EZ3.FreeControl.prototype.lift=function(a){var b=this.up.clone().scale(a);this.entity.position.add(b)},EZ3.FreeControl.prototype.walk=function(a){var b=this.look.clone().scale(a);this.entity.position.add(b)},EZ3.FreeControl.prototype.strafe=function(a){var b=this.right.clone().scale(a);this.entity.position.add(b)},EZ3.TargetControl=function(a,b,c){EZ3.CameraControl.call(this,a,b,c)},EZ3.TargetControl.prototype=Object.create(EZ3.CameraControl.prototype),EZ3.TargetControl.prototype.constructor=EZ3.TargetControl,EZ3.TargetControl.prototype.rotate=function(a,b,c){var d,e;EZ3.CameraControl.prototype.rotate.call(this,a,b,c),d=(new EZ3.Matrix4).yawPitchRoll(this.yaw,this.pitch,this.roll),e=new EZ3.Vector4(0,0,-1,0).mulMatrix4(d).toVector3(),this.distance=(new EZ3.Vector3).sub(this.entity.position,this.target).length(),this.distance=Math.max(1,this.distance),e.scale(this.distance),this.entity.position=(new EZ3.Vector3).add(this.target,e),this.look=(new EZ3.Vector3).sub(this.target,this.entity.position),this.up=new EZ3.Vector4(0,1,0,0).mulMatrix4(d).toVector3(),this.right=(new EZ3.Vector3).cross(this.look.normalize(),this.up),this.entity.lookAt(this.target,this.up)},EZ3.TargetControl.prototype.pan=function(a,b,c){var d,e,f,g,h;c=void 0!==c?c:100,d=a*c,e=-b*c,g=(new EZ3.Vector3).copy(this.right).scale(d),f=(new EZ3.Vector3).copy(this.up).scale(e),h=(new EZ3.Vector3).add(g,f),this.entity.position.add(h),this.target.add(h)},EZ3.TargetControl.prototype.zoom=function(a){var b=this.look.clone().scale(a);this.entity.position.add(b)},EZ3.OrthographicCamera=function(a,b,c,d,e,f){EZ3.Camera.call(this),this.left=void 0!==a?a:-25,this.right=void 0!==b?b:25,this.top=void 0!==c?c:25,this.bottom=void 0!==d?d:-25,this.near=void 0!==e?e:.1,this.far=void 0!==f?f:2e3},EZ3.OrthographicCamera.prototype=Object.create(EZ3.Camera.prototype),EZ3.OrthographicCamera.prototype.constructor=EZ3.OrthographicCamera,EZ3.OrthographicCamera.prototype._updateProjection=function(){var a,b,c,d,e=!1;return this._cache.left!==this.left&&(this._cache.left=this.left,e=!0),this._cache.right!==this.right&&(this._cache.right=this.right,e=!0),this._cache.top!==this.top&&(this._cache.top=this.top,e=!0),this._cache.bottom!==this.bottom&&(this._cache.bottom=this.bottom,e=!0),this._cache.near!==this.near&&(this._cache.near=this.near,e=!0),this._cache.far!==this.far&&(this._cache.far=this.far,e=!0),e&&(a=(this.right-this.left)/2,b=(this.top-this.bottom)/2,c=(this.right+this.left)/2,d=(this.top+this.bottom)/2,this.projection.orthographic(c-a,c+a,d+b,d-b,this.near,this.far)),e},EZ3.PerspectiveCamera=function(a,b,c,d){EZ3.Camera.call(this),this.fov=void 0!==a?a:70,this.aspect=void 0!==b?b:1,this.near=void 0!==c?c:.1,this.far=void 0!==d?d:2e3},EZ3.PerspectiveCamera.prototype=Object.create(EZ3.Camera.prototype),EZ3.PerspectiveCamera.prototype.constructor=EZ3.PerspectiveCamera,EZ3.PerspectiveCamera.prototype._updateProjection=function(){var a=!1;return this._cache.fov!==this.fov&&(this._cache.fov=this.fov,a=!0),this._cache.aspect!==this.aspect&&(this._cache.aspect=this.aspect,a=!0),this._cache.near!==this.near&&(this._cache.near=this.near,a=!0),this._cache.far!==this.far&&(this._cache.far=this.far,a=!0),a&&this.projection.perspective(this.fov,this.aspect,this.near,this.far),a},EZ3.PointLight=function(){EZ3.Light.call(this),EZ3.CubeCamera.call(this),this.depthFramebuffer=new EZ3.DepthCubeFramebuffer(new EZ3.Vector2(512,512))},EZ3.PointLight.prototype=Object.create(EZ3.Light.prototype),EZ3["extends"](EZ3.PointLight.prototype,EZ3.CubeCamera.prototype),EZ3.PointLight.prototype.constructor=EZ3.PointLight,EZ3.PointLight.prototype.updateUniforms=function(a,b,c,d,e,f,g){var h="uPointLights["+e+"].";EZ3.Light.prototype.updateUniforms.call(this,a,d,h),d.loadUniformFloat(a,h+"position",this.position),f&&(d.loadUniformFloat(a,h+"shadowBias",this.shadowBias),d.loadUniformFloat(a,h+"shadowDarkness",this.shadowDarkness),this.depthFramebuffer.texture.bind(a,b,c),b.textureArraySlots.push(b.usedTextureSlots++),e===g-1&&(d.loadUniformSamplerArray(a,"uPointShadowSampler[0]",b.textureArraySlots),b.textureArraySlots=[]))},EZ3.BoundingBox=function(a,b,c){var d;a instanceof EZ3.PrimitiveGeometry&&a.updateData(),a.updateBoundingVolumes(),d=a.boundingBox,a=new EZ3.BoxGeometry(b),c?EZ3.Mesh.call(this,a,c):(EZ3.Mesh.call(this,a),this.material.emissive.set(1,1,1),this.material.fill=EZ3.Material.WIREFRAME),this.position.copy((new EZ3.Vector3).add(d.max,d.min).scale(.5)),this.scale.sub(d.max,d.min)},EZ3.BoundingBox.prototype=Object.create(EZ3.Mesh.prototype),EZ3.BoundingBox.prototype.constructor=EZ3.Mesh,EZ3.BoundingSphere=function(a,b,c){var d;a instanceof EZ3.PrimitiveGeometry&&a.updateData(),a.updateBoundingVolumes(),d=a.boundingSphere,a=new EZ3.SphereGeometry(b),c?EZ3.Mesh.call(this,a,c):(EZ3.Mesh.call(this,a),this.material.emissive.set(1,1,1),this.material.fill=EZ3.Material.WIREFRAME),this.position.copy(d.center),this.scale.set(d.radius)},EZ3.BoundingSphere.prototype=Object.create(EZ3.Mesh.prototype),EZ3.BoundingSphere.prototype.constructor=EZ3.Mesh,EZ3.AstroidalEllipsoidGeometry=function(a,b){EZ3.PrimitiveGeometry.call(this),this.resolution=a||new EZ3.Vector2(5,5),this.radiouses=b||new EZ3.Vector3(6,6,6)},EZ3.AstroidalEllipsoidGeometry.prototype=Object.create(EZ3.PrimitiveGeometry.prototype),EZ3.AstroidalEllipsoidGeometry.prototype.constructor=EZ3.AstroidalEllipsoidGeometry,EZ3.AstroidalEllipsoidGeometry.prototype._computeData=function(){var a,b,c,d,e,f,g,h=[],i=[],j=[],k=[],l=new EZ3.Vector3;for(f=0;f<this.resolution.x;f++)for(d=f/(this.resolution.x-1),g=0;g<this.resolution.y;g++)e=g/(this.resolution.y-1),a=EZ3.Math.DOUBLE_PI*d-EZ3.Math.PI,b=EZ3.Math.PI*e-EZ3.Math.HALF_PI,c=Math.pow(Math.cos(b),3),l.x=this.radiouses.x*c*Math.pow(Math.cos(a),3),l.y=this.radiouses.y*Math.pow(Math.sin(b),3),l.z=this.radiouses.z*c*Math.pow(Math.sin(a),3),i.push(l.x,l.y,l.z),l.x/=this.radiouses.x,l.y/=this.radiouses.y,l.z/=this.radiouses.z,l.isZeroVector()||l.normalize(),j.push(l.x,l.y,l.z),k.push(d,e);for(f=0;f<this.resolution.x-1;f++)for(g=0;g<this.resolution.y-1;g++)d=f*this.resolution.y+g,e=(f+1)*this.resolution.y+(g+1),h.push(d,f*this.resolution.y+(g+1),e),h.push(d,e,(f+1)*this.resolution.y+g);this.buffers.setTriangles(h,i.length/3>EZ3.Math.MAX_USHORT),this.buffers.setPositions(i),this.buffers.setNormals(j),this.buffers.setUVs(k)},Object.defineProperty(EZ3.AstroidalEllipsoidGeometry.prototype,"_dataNeedUpdate",{get:function(){var a=!1;return this.radiouses.isEqual(this._cache.radiouses)||(this._cache.radiouses=this.radiouses.clone(),a=!0),this.resolution.isEqual(this._cache.resolution)||(this._cache.resolution=this.resolution.clone(),a=!0),a}}),EZ3.BoxGeometry=function(a,b){EZ3.PrimitiveGeometry.call(this),this.resolution=a||new EZ3.Vector3(1,1,1),this.dimensions=b||new EZ3.Vector3(1,1,1)},EZ3.BoxGeometry.prototype=Object.create(EZ3.PrimitiveGeometry.prototype),EZ3.BoxGeometry.prototype.constructor=EZ3.BoxGeometry,EZ3.BoxGeometry.prototype._computeData=function(){function a(a,g,h,i,j,k,l){var m,n,o,p,q,r,s=b.resolution.x,t=b.resolution.y,u=.5*j,v=.5*k,w=e.length/3,x=new EZ3.Vector3,y=new EZ3.Vector3;for("x"===a&&"y"===g||"y"===a&&"x"===g?p="z":"x"===a&&"z"===g||"z"===a&&"x"===g?(p="y",t=b.resolution.z):("z"===a&&"y"===g||"y"===a&&"z"===g)&&(p="x",s=b.resolution.z),y[p]=l>0?1:-1,m=j/s,n=k/t,q=0;t+1>q;q++)for(r=0;s+1>r;r++)x[a]=(r*m-u)*h,x[g]=(q*n-v)*i,x[p]=l,c.push(r/s,q/t),e.push(x.x,x.y,x.z),f.push(y.x,y.y,y.z);for(q=0;t>q;q++)for(r=0;s>r;r++)o=w+(q*(s+1)+r),p=w+((q+1)*(s+1)+(r+1)),d.push(o,p,w+(q*(s+1)+(r+1))),d.push(o,w+((q+1)*(s+1)+r),p)}var b=this,c=[],d=[],e=[],f=[],g=.5*this.dimensions.x,h=.5*this.dimensions.y,i=.5*this.dimensions.z;a("z","y",-1,-1,this.dimensions.z,this.dimensions.y,g),a("z","y",1,-1,this.dimensions.z,this.dimensions.y,-g),a("x","z",1,1,this.dimensions.x,this.dimensions.z,h),a("x","z",1,-1,this.dimensions.x,this.dimensions.z,-h),a("x","y",1,-1,this.dimensions.x,this.dimensions.y,i),a("x","y",-1,-1,this.dimensions.x,this.dimensions.y,-i),this.buffers.setTriangles(d,e.length/3>EZ3.Math.MAX_USHORT),this.buffers.setPositions(e),this.buffers.setNormals(f),this.buffers.setUVs(c)},Object.defineProperty(EZ3.BoxGeometry.prototype,"_dataNeedUpdate",{get:function(){var a=!1;return this.dimensions.isEqual(this._cache.dimensions)||(this._cache.dimensions=this.dimensions.clone(),a=!0),this.resolution.isEqual(this._cache.resolution)||(this._cache.resolution=this.resolution.clone(),a=!0),a}}),EZ3.EllipsoidGeometry=function(a,b){EZ3.PrimitiveGeometry.call(this),this.resolution=a||new EZ3.Vector2(40,40),this.radiouses=b||new EZ3.Vector3(10,5,10)},EZ3.EllipsoidGeometry.prototype=Object.create(EZ3.PrimitiveGeometry.prototype),EZ3.EllipsoidGeometry.prototype.constructor=EZ3.EllipsoidGeometry,EZ3.EllipsoidGeometry.prototype._computeData=function(){var a,b,c,d,e,f,g,h=[],i=[],j=[],k=[],l=new EZ3.Vector3;for(f=0;f<this.resolution.x;f++)for(d=f/(this.resolution.x-1),g=0;g<this.resolution.y;g++)e=g/(this.resolution.y-1),a=EZ3.Math.DOUBLE_PI*d,b=EZ3.Math.PI*e,c=Math.sin(b),l.x=this.radiouses.x*Math.cos(a)*c,l.y=this.radiouses.y*Math.sin(b-EZ3.Math.HALF_PI),l.z=this.radiouses.z*Math.sin(a)*c,i.push(l.x,l.y,l.z),l.x/=this.radiouses.x,l.y/=this.radiouses.y,l.z/=this.radiouses.z,l.isZeroVector()||l.normalize(),j.push(l.x,l.y,l.z),k.push(d,e);for(f=0;f<this.resolution.x-1;f++)for(g=0;g<this.resolution.y-1;g++)d=f*this.resolution.y+g,e=(f+1)*this.resolution.y+(g+1),h.push(d,f*this.resolution.y+(g+1),e),h.push(d,e,(f+1)*this.resolution.y+g);this.buffers.setTriangles(h,i.length/3>EZ3.Math.MAX_USHORT),this.buffers.setPositions(i),this.buffers.setNormals(j),this.buffers.setUVs(k)},Object.defineProperty(EZ3.EllipsoidGeometry.prototype,"_dataNeedUpdate",{get:function(){var a=!1;return this.radiouses.isEqual(this._cache.radiouses)||(this._cache.radiouses=this.radiouses.clone(),a=!0),this.resolution.isEqual(this._cache.resolution)||(this._cache.resolution=this.resolution.clone(),a=!0),a}}),EZ3.PlaneGeometry=function(a){EZ3.PrimitiveGeometry.call(this),this.resolution=a||new EZ3.Vector2(2,2)},EZ3.PlaneGeometry.prototype=Object.create(EZ3.PrimitiveGeometry.prototype),EZ3.PlaneGeometry.prototype.constructor=EZ3.PlaneGeometry,EZ3.PlaneGeometry.prototype._computeData=function(){var a,b,c,d,e,f,g=[],h=[],i=[],j=[];for(f=0;f<this.resolution.x+1;++f)for(e=0;e<this.resolution.y+1;++e)h.push(e,0,f),i.push(0,1,0),j.push(e/this.resolution.y,f/this.resolution.x);for(f=0;f<this.resolution.x;++f)for(e=0;e<this.resolution.y;++e)a=f*(this.resolution.x+1)+e,b=a+1,c=a+(this.resolution.x+1),d=c+1,g.push(a,c,b,b,c,d);this.buffers.setTriangles(g,h.length/3>EZ3.Math.MAX_USHORT),this.buffers.setPositions(h),this.buffers.setNormals(i),this.buffers.setUVs(j)},Object.defineProperty(EZ3.PlaneGeometry.prototype,"_dataNeedUpdate",{get:function(){return this.resolution.isEqual(this._cache.resolution)?!1:(this._cache.resolution=this.resolution.clone(),!0)}}),EZ3.SphereGeometry=function(a,b){EZ3.PrimitiveGeometry.call(this),this.resolution=a||new EZ3.Vector2(15,15),this.radius=void 0!==b?b:1},EZ3.SphereGeometry.prototype=Object.create(EZ3.PrimitiveGeometry.prototype),EZ3.SphereGeometry.prototype.constructor=EZ3.SphereGeometry,EZ3.SphereGeometry.prototype._computeData=function(){var a,b,c,d,e,f,g,h=[],i=[],j=[],k=[],l=new EZ3.Vector3;for(f=0;f<this.resolution.x;f++)for(d=f/(this.resolution.x-1),g=0;g<this.resolution.y;g++)e=g/(this.resolution.y-1),a=EZ3.Math.DOUBLE_PI*d,b=EZ3.Math.PI*e,c=Math.sin(b),l.x=this.radius*Math.cos(a)*c,l.y=this.radius*Math.sin(b-EZ3.Math.HALF_PI),l.z=this.radius*Math.sin(a)*c,i.push(l.x,l.y,l.z),l.isZeroVector()||l.normalize(),j.push(l.x,l.y,l.z),k.push(d,e);for(f=0;f<this.resolution.x-1;++f)for(g=0;g<this.resolution.y-1;++g)d=f*this.resolution.y+g,e=(f+1)*this.resolution.y+(g+1),h.push(d,f*this.resolution.y+(g+1),e),h.push(d,e,(f+1)*this.resolution.y+g);this.buffers.setTriangles(h,i.length/3>EZ3.Math.MAX_USHORT),this.buffers.setPositions(i),this.buffers.setNormals(j),this.buffers.setUVs(k)},Object.defineProperty(EZ3.SphereGeometry.prototype,"_dataNeedUpdate",{get:function(){var a=!1;return this._cache.radius!==this.radius&&(this._cache.radius=this.radius,a=!0),this.resolution.isEqual(this._cache.resolution)||(this._cache.resolution=this.resolution.clone(),a=!0),a}}),EZ3.TorusGeometry=function(a,b){EZ3.PrimitiveGeometry.call(this),this.resolution=a||new EZ3.Vector2(5,5),this.radiouses=b||new EZ3.Vector2(7,3)},EZ3.TorusGeometry.prototype=Object.create(EZ3.PrimitiveGeometry.prototype),EZ3.TorusGeometry.prototype.constructor=EZ3.TorusGeometry,EZ3.TorusGeometry.prototype._computeData=function(){var a,b,c,d,e,f,g,h,i,j=[],k=[],l=[],m=[],n=new EZ3.Vector3,o=new EZ3.Vector3;for(h=0;h<this.resolution.x;h++)for(f=h/(this.resolution.x-1),i=0;i<this.resolution.y;i++)g=i/(this.resolution.y-1),a=EZ3.Math.DOUBLE_PI*f,b=EZ3.Math.DOUBLE_PI*g,c=Math.cos(a),d=Math.sin(a),e=Math.cos(b),o.x=this.radiouses.x*c,o.z=this.radiouses.x*d,n.x=(this.radiouses.x+this.radiouses.y*e)*c,n.y=this.radiouses.y*Math.sin(b),n.z=(this.radiouses.x+this.radiouses.y*e)*d,k.push(n.x,n.y,n.z),n.sub(o),n.isZeroVector()||n.normalize(),l.push(n.x,n.y,n.z),m.push(f,g);for(h=0;h<this.resolution.x-1;++h)for(i=0;i<this.resolution.y-1;++i)f=h*this.resolution.y+i,g=(h+1)*this.resolution.y+(i+1),j.push(f,h*this.resolution.y+(i+1),g),j.push(f,g,(h+1)*this.resolution.y+i);this.buffers.setTriangles(j,k.length/3>EZ3.Math.MAX_USHORT),this.buffers.setPositions(k),this.buffers.setNormals(l),this.buffers.setUVs(m)},Object.defineProperty(EZ3.TorusGeometry.prototype,"_dataNeedUpdate",{get:function(){var a=!1;return this.radiouses.isEqual(this._cache.radiouses)||(this._cache.radiouses=this.radiouses.clone(),a=!0),this.resolution.isEqual(this._cache.resolution)||(this._cache.resolution=this.resolution.clone(),a=!0),a}}),EZ3.TargetCubemap=function(a,b,c){EZ3.Cubemap.call(this,new EZ3.Image(a.x,a.y,b,null),new EZ3.Image(a.x,a.y,b,null),new EZ3.Image(a.x,a.y,b,null),new EZ3.Image(a.x,a.y,b,null),new EZ3.Image(a.x,a.y,b,null),new EZ3.Image(a.x,a.y,b,null),!1),this.attachment=c},EZ3.TargetCubemap.prototype=Object.create(EZ3.Cubemap.prototype),EZ3.TargetCubemap.prototype.constructor=EZ3.TargetCubemap,EZ3.TargetCubemap.prototype.attach=function(a,b){var c=b||0;a.framebufferTexture2D(a.FRAMEBUFFER,this.attachment,a.TEXTURE_CUBE_MAP_POSITIVE_X+c,this._id,0)},EZ3.TargetTexture2D=function(a,b,c){EZ3.Texture2D.call(this,new EZ3.Image(a.x,a.y,b,null),!1),this.attachment=c},EZ3.TargetTexture2D.prototype=Object.create(EZ3.Texture2D.prototype),EZ3.TargetTexture2D.prototype.constructor=EZ3.TargetTexture2D,EZ3.TargetTexture2D.prototype.attach=function(a){a.framebufferTexture2D(a.FRAMEBUFFER,this.attachment,a.TEXTURE_2D,this._id,0)},EZ3.DirectionalLight=function(){EZ3.Light.call(this),EZ3.OrthographicCamera.call(this,-500,500,500,-500,1,5e3),this.depthFramebuffer=new EZ3.DepthFramebuffer(new EZ3.Vector2(512,512))},EZ3.DirectionalLight.prototype=Object.create(EZ3.Light.prototype),EZ3["extends"](EZ3.DirectionalLight.prototype,EZ3.OrthographicCamera.prototype),EZ3.DirectionalLight.prototype.constructor=EZ3.DirectionalLight,EZ3.DirectionalLight.prototype.updateUniforms=function(a,b,c,d,e,f,g){var h,i,j,k="uDirectionalLights["+e+"].",l=this.getWorldDirection();l.isZeroVector()||l.normalize(),EZ3.Light.prototype.updateUniforms.call(this,a,d,k),d.loadUniformFloat(a,k+"direction",l),f&&(j=(new EZ3.Matrix4).translate(new EZ3.Vector3(.5)).scale(new EZ3.Vector3(.5)),h=(new EZ3.Matrix4).mul(this.projection,this.view),i=(new EZ3.Matrix4).mul(j,h),d.loadUniformMatrix(a,k+"shadow",i),d.loadUniformFloat(a,k+"shadowBias",this.shadowBias),d.loadUniformFloat(a,k+"shadowDarkness",this.shadowDarkness),this.depthFramebuffer.texture.bind(a,b,c),b.textureArraySlots.push(b.usedTextureSlots++),e===g-1&&(d.loadUniformSamplerArray(a,"uDirectionalShadowSampler[0]",b.textureArraySlots),b.textureArraySlots=[]))},EZ3.SpotLight=function(){EZ3.Light.call(this),EZ3.PerspectiveCamera.call(this,60,1,1,4e3),this.cutoff=.9,this.depthFramebuffer=new EZ3.DepthFramebuffer(new EZ3.Vector2(512,512))},EZ3.SpotLight.prototype=Object.create(EZ3.Light.prototype),EZ3["extends"](EZ3.SpotLight.prototype,EZ3.PerspectiveCamera.prototype),EZ3.SpotLight.prototype.constructor=EZ3.SpotLight,EZ3.SpotLight.prototype.updateUniforms=function(a,b,c,d,e,f,g){var h,i,j,k="uSpotLights["+e+"].",l=this.getWorldDirection();l.isZeroVector()||l.normalize(),EZ3.Light.prototype.updateUniforms.call(this,a,d,k),d.loadUniformFloat(a,k+"position",this.position),d.loadUniformFloat(a,k+"direction",l),d.loadUniformFloat(a,k+"cutoff",this.cutoff),f&&(j=(new EZ3.Matrix4).translate(new EZ3.Vector3(.5)).scale(new EZ3.Vector3(.5)),h=(new EZ3.Matrix4).mul(this.projection,this.view),i=(new EZ3.Matrix4).mul(j,h),d.loadUniformMatrix(a,k+"shadow",i),d.loadUniformFloat(a,k+"shadowBias",this.shadowBias),d.loadUniformFloat(a,k+"shadowDarkness",this.shadowDarkness),this.depthFramebuffer.texture.bind(a,b,c),b.textureArraySlots.push(b.usedTextureSlots++),e===g-1&&(d.loadUniformSamplerArray(a,"uSpotShadowSampler[0]",b.textureArraySlots),b.textureArraySlots=[]))};